"use strict";(self.webpackChunkincoming_tool=self.webpackChunkincoming_tool||[]).push([[894],{612:(e,t,i)=>{i.d(t,{Q:()=>r});var o=i(8613),s=i(8006),l=i(161);const r=e=>{const[t,i]=(0,o.useState)([]),[r,n]=(0,o.useState)(!0),[a,d]=(0,o.useState)(null),[c,u]=(0,o.useState)(""),[m,g]=(0,o.useState)("All"),[p,A]=(0,o.useState)(!1);(0,o.useEffect)((()=>{if(console.log("[useStockItems] useEffect: Checking db and orgId:",{db_instance:l.db,org_id:e}),!l.db||!e)return console.warn("[useStockItems] useEffect: db or orgId is missing, skipping Firestore query."),n(!1),void(e||i([]));n(!0),d(null),console.log(`[useStockItems] useEffect: Setting up listener for orgs/${e}/stockItems`);const t=(0,s.query)((0,s.collection)(l.db,"orgs",e,"stockItems"),(0,s.orderBy)("orderDate","desc")),o=(0,s.onSnapshot)(t,(e=>{console.log("[useStockItems] useEffect: Received snapshot.");const t=e.docs.map((e=>({id:e.id,...e.data()})));i(t),n(!1)}),(e=>{console.error("[useStockItems] useEffect: Snapshot error:",e),d("Failed to load items: "+e.message),n(!1)}));return()=>{console.log("[useStockItems] useEffect: Cleaning up listener."),o()}}),[e]);const h=(0,o.useMemo)((()=>t.filter((e=>{const t=c.toLowerCase(),i=e.deliveryName&&"string"===typeof e.deliveryName&&e.deliveryName.toLowerCase().includes(t)||e.productName&&"string"===typeof e.productName&&e.productName.toLowerCase().includes(t)||e.seller&&"string"===typeof e.seller&&e.seller.toLowerCase().includes(t)||e.asinSku&&"string"===typeof e.asinSku&&e.asinSku.toLowerCase().includes(t);let o=!1;o="All"===m||("Late"===m?(e=>{if("Pending Delivery"!==e.currentStatus)return!1;const t=new Date(e.orderDate),i=new Date;return i.setDate(i.getDate()-7),t<i})(e):e.currentStatus===m);const s=!p||!0===e.isFlagged;return o&&i&&s}))),[t,c,m,p]);return{allItems:t,items:h,loading:r,error:a,searchTerm:c,currentFilter:m,showFlaggedOnly:p,setSearchTerm:u,setCurrentFilter:g,setShowFlaggedOnly:A,setError:d}}},5929:(e,t,i)=>{i.r(t),i.d(t,{ActionMenu:()=>z,default:()=>M,getAvailableActions:()=>U});var o=i(8613),s=i(9284),l=(i(8677),i(1024),i(8006)),r=i(6623),n=i(8512),a=i(9801),d=i(6185),c=i(267),u=i(6748),m=i(6393),g=i(5495),p=i(2967),A=i(5895),h=i(6647),v=i(5359),S=i(1),f=i(2571),b=i(5847),x=i(5303),y=i(8229),I=i(6859),D=i(1399),k=i(9841),j=i(2731),w=i(2043),N=i(2327),E=i(9963),C=i(2422),T=i(6384),F=i(210),O=i(161),_=i(612),L=i(579);console.log("[IncomingTool] ToolApp.tsx: Top level, imported db is:",O.db);const R=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{timestamp:(new Date).toISOString(),type:t,userId:e,details:i}},U=(e,t)=>{let i=[];switch(e){case"Pending Delivery":case"Late":i=[{id:"Mark as Delivered",label:"Mark as Delivered",description:"Update status to Delivered"},{id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:(0,L.jsx)(T.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,L.jsx)(F.A,{fontSize:"small"})}];break;case"Delivered":i=[{id:"Archive",label:"Archive",description:"Archive this item",icon:(0,L.jsx)(E.A,{fontSize:"small"})},{id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:(0,L.jsx)(T.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,L.jsx)(F.A,{fontSize:"small"})}];break;case"Issue":i=[{id:"Resolve Issue",label:"Resolve Issue",description:"Mark the issue as resolved"},{id:"Add Issue Update",label:"Add Issue Update",description:"Add an update note to the ongoing issue"},{id:"Archive",label:"Archive",description:"Archive this item",icon:(0,L.jsx)(E.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a general note to the item history",icon:(0,L.jsx)(F.A,{fontSize:"small"})}];break;case"Archived":i=[{id:"Unarchive Item",label:"Unarchive",description:"Restore this item from archive",icon:(0,L.jsx)(C.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,L.jsx)(F.A,{fontSize:"small"})}];break;default:i=[{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,L.jsx)(F.A,{fontSize:"small"})}]}return"Archived"!==e&&i.unshift(t?{id:"action_unflag",label:"Unflag",description:"Remove the flag from this item",icon:(0,L.jsx)(N.A,{fontSize:"small",color:"disabled"})}:{id:"action_flag",label:"Flag",description:"Flag this item for attention",icon:(0,L.jsx)(N.A,{fontSize:"small"})}),i},z=e=>{let{itemId:t,actions:i,onActionSelected:o,onClose:s,anchorEl:l,open:c}=e;return(0,L.jsx)(r.A,{anchorEl:l,open:c,onClose:s,MenuListProps:{"aria-labelledby":`actions-button-${t}`},children:i.map((e=>(0,L.jsxs)(n.A,{onClick:()=>(e=>{o(t,e),s()})(e),children:[e.icon&&(0,L.jsx)(a.A,{sx:{minWidth:"32px"},children:e.icon}),(0,L.jsx)(d.A,{primary:e.label})]},e.id)))})},P=[{id:"orderDate",label:"Order Date"},{id:"quantity",label:"Qty"},{id:"productName",label:"Product Name"},{id:"deliveryName",label:"Delivery Name"},{id:"pricePerItem",label:"Price/Item"},{id:"seller",label:"Seller/Source"},{id:"destination",label:"Destination"},{id:"asinSku",label:"ASIN/SKU"},{id:"purchaseStatus",label:"Purchase Status"},{id:"orderNumber",label:"Order #"},{id:"currentStatus",label:"Status"},{id:"isFlagged",label:"Flagged"},{id:"acquisitionNotes",label:"Acquisition Notes"},{id:"issueDescription",label:"Issue Description"},{id:"dateDelivered",label:"Date Delivered"},{id:"actions",label:"Actions"}],$=["orderDate","quantity","productName","deliveryName","currentStatus","actions"],G="incomingTool_visibleColumns",M=e=>{let{user:t,org:i,permissions:r,logAction:n}=e;console.log("ToolApp Props Received:",{user:t,orgId:null===i||void 0===i?void 0:i.id,permissions:r,logActionExists:!!n}),console.log("ToolApp using imported db:",O.db),console.log("ToolApp using imported auth:",O.auth);const{items:a,allItems:d,loading:N,error:E,searchTerm:C,currentFilter:T,showFlaggedOnly:F,setSearchTerm:U,setCurrentFilter:z,setShowFlaggedOnly:M,setError:q}=(0,_.Q)(null===i||void 0===i?void 0:i.id);console.log("[IncomingTool] useStockItems returned:",{loading:N,error:E,items_length:null===a||void 0===a?void 0:a.length,allItems_length:null===d||void 0===d?void 0:d.length,currentFilter:T,showFlaggedOnly:F,searchTerm:C});const[V,H]=(0,o.useState)(null),[Q,J]=(0,o.useState)(!1),[K,W]=(0,o.useState)(null),[B,X]=(0,o.useState)(null),[Y,Z]=(0,o.useState)(null),[ee,te]=(0,o.useState)(null),[ie,oe]=(0,o.useState)(!1),[se,le]=(0,o.useState)(null),[re,ne]=(0,o.useState)(!1),[ae,de]=(0,o.useState)((()=>{try{const e=localStorage.getItem(G),t=e?JSON.parse(e):$;return Array.isArray(t)?t:$}catch(E){return console.error("Error reading visible columns from localStorage",E),$}})),[ce,ue]=(0,o.useState)(null),[me,ge]=(0,o.useState)(null);(0,o.useEffect)((()=>{localStorage.setItem(G,JSON.stringify(ae))}),[ae]);const pe=ae.map((e=>P.find((t=>t.id===e)))).filter((e=>void 0!==e)),Ae=(0,o.useCallback)((async(e,t,o,s)=>{if(console.log("[IncomingTool] updateItemAndLog: Checking db and org.id:",{db_instance:O.db,org_id:null===i||void 0===i?void 0:i.id}),!O.db||null===i||void 0===i||!i.id||!t)return console.error("Cannot update item: Missing configuration.",{db:!!O.db,orgId:null===i||void 0===i?void 0:i.id,userId:t}),void q("Cannot update item: Missing configuration.");console.log(`[IncomingTool] updateItemAndLog: Preparing to update item ${e} in org ${i.id}`);const r=(0,l.doc)(O.db,"orgs",i.id,"stockItems",e),a=d.find((t=>t.id===e));if(!a)return console.error(`Item ${e} not found for update`),void q(`Item ${e} not found.`);const c=(u={...o,lastUpdated:(0,l.serverTimestamp)()},Object.fromEntries(Object.entries(u).filter((e=>{let[t,i]=e;return void 0!==i}))));var u;const m={...a,...c};try{if(await(0,l.updateDoc)(r,c),console.log(`Item ${e} updated successfully.`),console.log("updateItemAndLog: Attempting to log action. logAction available?",!!n),n){let t;try{if("EDITED"===s.type)t="item.update.fields";else if("FLAG_TOGGLED"===s.type)t="item.update.flag";else if("STATUS_CHANGED"===s.type){var g,p;t=`item.update.status.${(null===(g=s.details)||void 0===g||null===(p=g.newStatus)||void 0===p?void 0:p.toLowerCase())||"unknown"}`}else t="ISSUE_REPORTED"===s.type?"item.update.issue.report":"ISSUE_RESOLVED"===s.type?"item.update.issue.resolve":"ISSUE_UPDATE_ADDED"===s.type?"item.update.issue.update":"NOTE_ADDED"===s.type?"item.add_note":s.type}catch(A){console.error("Error deriving action name for logging:",A),t=s.type}const o={orgId:i.id,toolKey:"incomingtool",action:t,entityPath:`stockItems/${e}`,...void 0!==a&&{before:a},...void 0!==m&&{after:m},...void 0!==s.details&&{details:s.details}};await n(o)}}catch(h){throw console.error(`Error updating item ${e}:`,h),q(`Failed to update item: ${h.message}`),h}}),[i,d,n,q]),he=((0,o.useCallback)((async(e,i)=>{console.log(`Action: ${i.label} on item ${e}`);const o=d.find((t=>t.id===e));if(o)switch(i.id){case"Edit Item":W(o),J(!0);break;case"Flag Item":case"Unflag Item":const s="Flag Item"===i.id;await Ae(e,null===t||void 0===t?void 0:t.uid,{isFlagged:s},R((null===t||void 0===t?void 0:t.uid)||"","FLAG_TOGGLED",{isFlagged:s}));break;case"Mark as Delivered":"Delivered"!==o.currentStatus&&await Ae(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Delivered",dateDelivered:(new Date).toISOString()},R((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:o.currentStatus,newStatus:"Delivered"}));break;case"Archive":"Archived"!==o.currentStatus&&await Ae(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Archived"},R((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:o.currentStatus,newStatus:"Archived"}));break;case"Add Note":le(o);break;case"Report Issue":H(null),X(o);break;case"Resolve Issue":H(null),te(o);break;case"Add Issue Update":H(null),Z(o);break;case"View Details":H(o)}}),[null===t||void 0===t?void 0:t.uid,d,Ae,W,J,X,Z,te,H]),(0,o.useCallback)((e=>{const t=d.find((t=>t.id===e));return t?(console.log("Viewing details for:",t),i?void H(t):(console.error("Org ID is missing, cannot fetch logs."),void q("Organization context is missing."))):(console.error("Item not found for viewing details:",e),void q("Item not found."))}),[i,d,q])),ve=(e,t)=>{ge(e.currentTarget),ue(t.id)},Se=((0,s.FR)(),(0,c.A)()),fe=(0,u.A)(Se.breakpoints.down("sm")),be=e=>{var t;let{item:i,onViewDetails:o,onActionClick:s}=e;return(0,L.jsx)(m.A,{sx:{mb:2,cursor:"pointer"},onClick:()=>o(i.id),children:(0,L.jsx)(g.A,{sx:{pb:"8px !important"},children:(0,L.jsxs)(p.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[(0,L.jsxs)(p.A,{sx:{flexGrow:1,mr:1},children:[(0,L.jsx)(A.A,{variant:"subtitle1",component:"div",sx:{fontWeight:"bold",lineHeight:1.3},children:i.productName||i.deliveryName||"Unnamed Item"}),(0,L.jsxs)(A.A,{variant:"body2",color:"text.secondary",children:["Status: ",i.currentStatus]}),(0,L.jsxs)(A.A,{variant:"body2",color:"text.secondary",children:["Qty: ",null!==(t=i.quantity)&&void 0!==t?t:"N/A"," | Seller: ",i.seller||"N/A"]}),(0,L.jsxs)(A.A,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.8rem"},children:["Order Date: ",i.orderDate?new Date(i.orderDate).toLocaleDateString():"N/A"]})]}),(0,L.jsx)(h.A,{size:"small",onClick:e=>{e.stopPropagation(),s(e,i)},sx:{mt:-1,mr:-1},children:(0,L.jsx)(w.A,{})})]})})})};return(0,L.jsxs)(p.A,{sx:{},children:[E&&(0,L.jsx)(v.A,{severity:"error",onClose:()=>q(null),sx:{},children:E}),N&&(0,L.jsx)(S.A,{sx:{}}),(0,L.jsxs)(p.A,{sx:{},children:[(0,L.jsx)(f.A,{value:C,onChange:e=>U(e.target.value)}),(0,L.jsx)(b.A,{control:(0,L.jsx)(x.A,{checked:F,onChange:e=>M(e.target.checked),size:"small"}),label:(0,L.jsx)(A.A,{variant:"body2",children:"Show Flagged Only"}),sx:{mr:0}})]}),(0,L.jsx)(p.A,{sx:{},children:(0,L.jsx)(y.A,{value:T,onChange:(e,t)=>z(t)})}),(0,L.jsxs)(s.Mp,{children:[!fe&&(0,L.jsx)(I.A,{children:(0,L.jsxs)(D.A,{children:[a.map(((e,t)=>(0,L.jsx)(k.A,{},e.id))),0===a.length&&(0,L.jsx)(k.A,{children:(0,L.jsx)(j.A,{colSpan:pe.length,align:"center",children:"No items match the current filter."})})]})}),fe&&(0,L.jsxs)(p.A,{sx:{p:1},children:[" ",a.map((e=>(0,L.jsx)(be,{item:e,onViewDetails:he,onActionClick:ve},e.id))),0===a.length&&(0,L.jsx)(A.A,{align:"center",sx:{mt:2,color:"text.secondary"},children:"No items match the current filter."})]})]}),(()=>{if(!ce)return null;d.find((e=>e.id===ce))})()]})}}}]);
//# sourceMappingURL=894.e7ec2882.chunk.js.map