"use strict";(self.webpackChunkincoming_tool=self.webpackChunkincoming_tool||[]).push([[935],{612:(e,t,i)=>{i.d(t,{Q:()=>n});var s=i(8613),r=i(8006),o=i(161);const n=e=>{const[t,i]=(0,s.useState)([]),[n,l]=(0,s.useState)(!0),[a,d]=(0,s.useState)(null),[c,u]=(0,s.useState)([]),[m,v]=(0,s.useState)(!0),[p,h]=(0,s.useState)(null),[g,x]=(0,s.useState)(""),[A,b]=(0,s.useState)("All"),[f,S]=(0,s.useState)(!1),y=n||m,j=a||p;(0,s.useEffect)((()=>{if(console.log("[useStockItems] Non-Archived Listener: Checking db and orgId:",{db_instance:o.db,org_id:e}),!o.db||!e)return console.warn("[useStockItems] Non-Archived Listener: db or orgId is missing, skipping Firestore query."),l(!1),void(e||i([]));l(!0),d(null),console.log(`[useStockItems] Non-Archived Listener: Setting up listener for orgs/${e}/stockItems (non-archived)`);const t=(0,r.query)((0,r.collection)(o.db,"orgs",e,"stockItems"),(0,r.where)("currentStatus","!=","Archived"),(0,r.orderBy)("currentStatus"),(0,r.orderBy)("orderDate","desc")),s=(0,r.onSnapshot)(t,(e=>{console.log("[useStockItems] Non-Archived Listener: Received snapshot.");const t=e.docs.map((e=>({...e.data(),id:e.id})));i(t),l(!1)}),(e=>{console.error("[useStockItems] Non-Archived Listener: Snapshot error:",e),d("Failed to load items: "+e.message),l(!1)}));return()=>{console.log("[useStockItems] Non-Archived Listener: Cleaning up listener."),s()}}),[e]),(0,s.useEffect)((()=>{if(console.log("[useStockItems] Archived Listener: Checking db and orgId:",{db_instance:o.db,org_id:e}),!o.db||!e)return console.warn("[useStockItems] Archived Listener: db or orgId is missing, skipping Firestore query."),v(!1),void(e||u([]));v(!0),h(null),console.log(`[useStockItems] Archived Listener: Setting up listener for orgs/${e}/stockItems (archived)`);const t=(0,r.query)((0,r.collection)(o.db,"orgs",e,"stockItems"),(0,r.where)("currentStatus","==","Archived"),(0,r.orderBy)("orderDate","desc")),i=(0,r.onSnapshot)(t,(e=>{console.log("[useStockItems] Archived Listener: Received snapshot.");const t=e.docs.map((e=>({...e.data(),id:e.id})));u(t),v(!1)}),(e=>{console.error("[useStockItems] Archived Listener: Snapshot error:",e),h("Failed to load archived items: "+e.message),v(!1)}));return()=>{console.log("[useStockItems] Archived Listener: Cleaning up listener."),i()}}),[e]);const I=(0,s.useMemo)((()=>("Archived"===A?c:t).filter((e=>{var t,i,s,r;const o=g.toLowerCase(),n=(null===(t=e.deliveryName)||void 0===t?void 0:t.toLowerCase().includes(o))||(null===(i=e.productName)||void 0===i?void 0:i.toLowerCase().includes(o))||(null===(s=e.seller)||void 0===s?void 0:s.toLowerCase().includes(o))||(null===(r=e.asinSku)||void 0===r?void 0:r.toLowerCase().includes(o));let l=!1;if("All"===A||"Archived"===A)l=!0;else if("Late"===A){l=(e=>{if("Pending Delivery"!==e.currentStatus)return!1;try{const t=new Date(e.orderDate),i=new Date;return i.setDate(i.getDate()-7),t<i}catch(t){return console.error("Error parsing orderDate for late check:",t),!1}})(e)}else l=e.currentStatus===A;const a=!f||!0===e.isFlagged;return l&&n&&a}))),[t,c,g,A,f]);return{allItems:t,archivedItems:c,items:I,loading:y,error:j,searchTerm:g,currentFilter:A,showFlaggedOnly:f,setSearchTerm:x,setCurrentFilter:b,setShowFlaggedOnly:S,setError:e=>{d(e),h(e)}}}},1453:(e,t,i)=>{i.d(t,{A:()=>v});var s=i(8613),r=i(8517),o=i(1911),n=i(5895),l=i(4199),a=i(2967),d=i(2571),c=i(8263),u=i(5557),m=i(579);const v=e=>{let{isOpen:t,item:i,onSubmit:v,onClose:p}=e;const[h,g]=(0,s.useState)(""),[x,A]=(0,s.useState)("");return(0,m.jsxs)(r.A,{open:t,onClose:p,maxWidth:"sm",fullWidth:!0,children:[(0,m.jsxs)(o.A,{children:[(0,m.jsx)(n.A,{variant:"h6",children:"Add Issue Update for:"}),(0,m.jsxs)(n.A,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:[i.productName," - ",i.deliveryName]})]}),(0,m.jsxs)(l.A,{dividers:!0,children:[i.issueDescription&&(0,m.jsxs)(a.A,{sx:e=>({mb:2,p:1.5,backgroundColor:e.palette.action.selected||e.palette.grey[100],border:`1px solid ${e.palette.divider}`,borderRadius:1}),children:[(0,m.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,children:"Item Context:"}),(0,m.jsxs)(n.A,{variant:"body2",component:"div",noWrap:!0,children:[i.productName," (",i.deliveryName,")"]})]}),(0,m.jsx)(d.A,{autoFocus:!0,id:"updateNote",label:"Update Note *",type:"text",fullWidth:!0,multiline:!0,rows:4,variant:"outlined",size:"small",sx:{mb:2},value:h,onChange:e=>{g(e.target.value),x&&A("")},error:!!x,helperText:x||"Enter details about the update.",placeholder:"e.g., Contacted seller, awaiting response..."})]}),(0,m.jsxs)(c.A,{sx:{padding:"16px 24px"},children:[(0,m.jsx)(u.A,{onClick:p,color:"secondary",children:"Cancel"}),(0,m.jsx)(u.A,{onClick:()=>{h.trim()?(v(h),p()):A("Please enter an update note.")},variant:"contained",color:"primary",children:"Save Update Note"})]})]})}},1499:(e,t,i)=>{i.d(t,{W:()=>c});var s=i(8613),r=i.n(s),o=i(6623),n=i(8889),l=i(9801),a=i(6185),d=i(579);const c=e=>{let{itemId:t,actions:i,onActionSelected:s,onClose:c,anchorEl:u,open:m}=e;return(0,d.jsx)(o.A,{anchorEl:u,open:m,onClose:c,MenuListProps:{"aria-labelledby":`actions-button-${t}`,dense:!0},PaperProps:{sx:{minWidth:180}},children:i.map(((e,i)=>(0,d.jsxs)(n.A,{onClick:()=>(e=>{s(t,e),c()})(e),children:[e.icon&&(0,d.jsx)(l.A,{sx:{minWidth:"auto",mr:1.5,alignItems:"center",color:"inherit"},children:r().createElement(e.icon,{fontSize:"small"})}),(0,d.jsx)(a.A,{primaryTypographyProps:{variant:"body2"},children:e.label})]},e.id)))})}},2630:(e,t,i)=>{i.d(t,{A:()=>b});var s=i(8613),r=i(8517),o=i(1911),n=i(5895),l=i(4199),a=i(2967),d=i(3863),c=i(5809),u=i(4553),m=i(8889),v=i(468),p=i(2571),h=i(8263),g=i(5557),x=i(579);const A=["Item Accepted / Kept As Is","Item Repaired / Refurbished","Partial Refund Received","Returned to Supplier","Disposed Of","Other"],b=e=>{let{isOpen:t,item:i,onSubmit:b,onClose:f}=e;const[S,y]=(0,s.useState)(""),[j,I]=(0,s.useState)(""),[D,C]=(0,s.useState)("");return(0,x.jsxs)(r.A,{open:t,onClose:f,maxWidth:"sm",fullWidth:!0,children:[(0,x.jsxs)(o.A,{children:[(0,x.jsx)(n.A,{variant:"h6",children:"Resolve Issue for:"}),(0,x.jsxs)(n.A,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:[i.productName," - ",i.deliveryName]})]}),(0,x.jsxs)(l.A,{dividers:!0,children:[i&&(0,x.jsxs)(a.A,{sx:e=>({mb:2,p:1.5,backgroundColor:e.palette.action.selected||e.palette.grey[100],border:`1px solid ${e.palette.divider}`,borderRadius:1}),children:[(0,x.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,children:"Original Issue:"}),(0,x.jsx)(n.A,{variant:"body2",children:i.issueDescription})]}),(0,x.jsxs)(d.A,{fullWidth:!0,error:!!D,sx:{mb:2},variant:"outlined",size:"small",children:[(0,x.jsx)(c.A,{id:"resolution-outcome-label",children:"Resolution Outcome *"}),(0,x.jsxs)(u.A,{labelId:"resolution-outcome-label",id:"resolutionOutcome",value:S,label:"Resolution Outcome *",onChange:e=>{y(e.target.value),D&&C("")},children:[(0,x.jsx)(m.A,{value:"",disabled:!0,children:(0,x.jsx)("em",{children:"-- Select an Outcome --"})}),A.map((e=>(0,x.jsx)(m.A,{value:e,children:e},e)))]}),D&&(0,x.jsx)(v.A,{children:D})]}),(0,x.jsx)(p.A,{id:"resolutionNotes",label:"Resolution Notes (Optional)",multiline:!0,rows:3,fullWidth:!0,value:j,onChange:e=>I(e.target.value),placeholder:"e.g., Supplier issued refund, repaired screen...",variant:"outlined",size:"small",sx:{mb:2}})]}),(0,x.jsxs)(h.A,{sx:{padding:"16px 24px"},children:[(0,x.jsx)(g.A,{onClick:f,color:"secondary",children:"Cancel"}),(0,x.jsx)(g.A,{onClick:()=>{C(""),S?b(S,j.trim()||void 0):C("Please select a resolution outcome.")},variant:"contained",color:"primary",children:"Save Resolution"})]})]})}},3368:(e,t,i)=>{i.d(t,{A:()=>p});var s=i(8613),r=i(2967),o=i(5895),n=i(6647),l=i(2571),a=i(8889),d=i(5847),c=i(5303),u=i(5557),m=i(7421),v=i(579);const p=e=>{let{onSave:t,onClose:i,initialData:p,firstInputRef:h}=e;const g=!!p,[x,A]=(0,s.useState)((null===p||void 0===p?void 0:p.purchaseStatus)||"Purchased"),[b,f]=(0,s.useState)((null===p||void 0===p?void 0:p.deliveryName)||""),[S,y]=(0,s.useState)((null===p||void 0===p?void 0:p.productName)||""),[j,I]=(0,s.useState)((null===p||void 0===p?void 0:p.quantity)||""),[D,C]=(0,s.useState)((null===p||void 0===p?void 0:p.pricePerItem)||""),[N,k]=(0,s.useState)((null===p||void 0===p?void 0:p.orderNumber)||""),[w,E]=(0,s.useState)((()=>(null===p||void 0===p?void 0:p.orderDate)||(new Date).toISOString().split("T")[0])),[O,T]=(0,s.useState)((null===p||void 0===p?void 0:p.seller)||""),[F,P]=(0,s.useState)((null===p||void 0===p?void 0:p.isVatRegistered)||"Unknown"),[$,R]=(0,s.useState)((null===p||void 0===p?void 0:p.destination)||""),[U,L]=(0,s.useState)((null===p||void 0===p?void 0:p.asinSku)||""),[W,_]=(0,s.useState)((null===p||void 0===p?void 0:p.acquisitionNotes)||""),[q,z]=(0,s.useState)((null===p||void 0===p?void 0:p.isFlagged)||!1),[G,V]=(0,s.useState)({});(0,s.useEffect)((()=>{p&&(A(p.purchaseStatus||"Purchased"),f(p.deliveryName||""),y(p.productName||""),I(p.quantity||""),C(p.pricePerItem||""),k(p.orderNumber||""),E(p.orderDate||(new Date).toISOString().split("T")[0]),T(p.seller||""),P(p.isVatRegistered||"Unknown"),R(p.destination||""),L(p.asinSku||""),_(p.acquisitionNotes||""),z(p.isFlagged||!1),V({}))}),[p]);return(0,v.jsxs)(r.A,{component:"form",onSubmit:e=>{e.preventDefault(),console.log("AddItemForm: handleSubmit",{deliveryName:b,productName:S,quantity:j,pricePerItem:D,orderDate:w,seller:O,destination:$,acquisitionNotes:W,isFlagged:q});const i=(()=>{const e={};return b.trim()||(e.deliveryName="Delivery Name is required."),S.trim()||(e.productName="Product Name is required."),(""===j||j<=0)&&(e.quantity="Quantity must be a positive number."),(""===D||D<0)&&(e.pricePerItem="Price must be zero or positive."),w||(e.orderDate="Order Date is required."),V(e),0===Object.keys(e).length})();console.log("AddItemForm: validation result",i,G),i?(console.log("AddItemForm: form valid, calling onSave"),t({purchaseStatus:x,deliveryName:b,productName:S,quantity:Number(j),pricePerItem:Number(D),orderNumber:N||void 0,orderDate:w,seller:O||void 0,isVatRegistered:"Unknown"===F?void 0:F,destination:$||void 0,asinSku:U||void 0,acquisitionNotes:W||void 0,isFlagged:q})):console.log("AddItemForm: form invalid, errors:",G)},id:"add-item-form",noValidate:!0,sx:{p:3,display:"flex",flexDirection:"column",height:"100%"},children:[(0,v.jsxs)(r.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[(0,v.jsx)(o.A,{variant:"h6",children:g?"Edit Stock Item":"Add New Stock Item"}),(0,v.jsx)(n.A,{onClick:i,"aria-label":"Close",children:(0,v.jsx)(m.A,{})})]}),(0,v.jsxs)(r.A,{sx:{flexGrow:1,overflowY:"auto",pr:1},children:[(0,v.jsx)(l.A,{inputRef:h,required:!0,fullWidth:!0,id:"deliveryName",label:"Delivery Name",name:"deliveryName",value:b,onChange:e=>f(e.target.value),error:!!G.deliveryName,helperText:G.deliveryName,variant:"outlined",size:"small",sx:{mb:2}}),(0,v.jsx)(l.A,{required:!0,fullWidth:!0,id:"productName",label:"Product Name",name:"productName",value:S,onChange:e=>y(e.target.value),error:!!G.productName,helperText:G.productName,variant:"outlined",size:"small",sx:{mb:2}}),(0,v.jsx)(l.A,{required:!0,fullWidth:!0,id:"quantity",label:"Quantity",name:"quantity",type:"number",value:j,onChange:e=>I(""===e.target.value?"":Number(e.target.value)),error:!!G.quantity,helperText:G.quantity,variant:"outlined",size:"small",sx:{mb:2},InputProps:{inputProps:{min:1}}}),(0,v.jsx)(l.A,{required:!0,fullWidth:!0,id:"pricePerItem",label:"Price Per Item",name:"pricePerItem",type:"number",value:D,onChange:e=>C(""===e.target.value?"":Number(e.target.value)),error:!!G.pricePerItem,helperText:G.pricePerItem,variant:"outlined",size:"small",sx:{mb:2},InputProps:{inputProps:{min:0}}}),(0,v.jsx)(l.A,{required:!0,fullWidth:!0,id:"orderDate",label:"Order Date",name:"orderDate",type:"date",value:w,onChange:e=>E(e.target.value),error:!!G.orderDate,helperText:G.orderDate,variant:"outlined",size:"small",sx:{mb:2},InputLabelProps:{shrink:!0}}),(0,v.jsxs)(l.A,{select:!0,fullWidth:!0,id:"purchaseStatus",label:"Purchase Status",name:"purchaseStatus",value:x,onChange:e=>A(e.target.value),variant:"outlined",size:"small",sx:{mb:2},SelectProps:{},children:[(0,v.jsx)(a.A,{value:"Purchased",children:"Purchased"}),(0,v.jsx)(a.A,{value:"Ordered",children:"Ordered"}),(0,v.jsx)(a.A,{value:"Return Expected",children:"Return Expected"})]}),(0,v.jsx)(l.A,{fullWidth:!0,id:"orderNumber",label:"Order Number",name:"orderNumber",value:N,onChange:e=>k(e.target.value),variant:"outlined",size:"small",sx:{mb:2}}),(0,v.jsx)(l.A,{fullWidth:!0,id:"seller",label:"Seller / Source",name:"seller",value:O,onChange:e=>T(e.target.value),variant:"outlined",size:"small",sx:{mb:2}}),(0,v.jsxs)(l.A,{select:!0,fullWidth:!0,id:"isVatRegistered",label:"Seller VAT Registered?",name:"isVatRegistered",value:F,onChange:e=>P(e.target.value),variant:"outlined",size:"small",sx:{mb:2},children:[(0,v.jsx)(a.A,{value:"Unknown",children:"Unknown"}),(0,v.jsx)(a.A,{value:"Yes",children:"Yes"}),(0,v.jsx)(a.A,{value:"No",children:"No"})]}),(0,v.jsxs)(l.A,{select:!0,fullWidth:!0,id:"destination",label:"Planned Destination",name:"destination",value:$,onChange:e=>R(e.target.value),variant:"outlined",size:"small",sx:{mb:2},children:[(0,v.jsx)(a.A,{value:"",children:"_Not Set_"}),(0,v.jsx)(a.A,{value:"FBA Prep",children:"FBA Prep"}),(0,v.jsx)(a.A,{value:"Local Stock Shelf A",children:"Local Stock Shelf A"}),(0,v.jsx)(a.A,{value:"Refurbish Pile",children:"Refurbish Pile"}),(0,v.jsx)(a.A,{value:"Return to Supplier",children:"Return to Supplier"})]}),(0,v.jsx)(l.A,{fullWidth:!0,id:"asinSku",label:"ASIN / SKU",name:"asinSku",value:U,onChange:e=>L(e.target.value),variant:"outlined",size:"small",sx:{mb:2}}),(0,v.jsx)(l.A,{fullWidth:!0,multiline:!0,rows:3,id:"acquisitionNotes",label:"Acquisition Notes",name:"acquisitionNotes",value:W,onChange:e=>_(e.target.value),variant:"outlined",size:"small",sx:{mb:2}}),(0,v.jsx)(d.A,{control:(0,v.jsx)(c.A,{checked:q,onChange:e=>z(e.target.checked),name:"isFlagged",color:"secondary"}),label:"Flag this item for attention",sx:{mb:1}})]}),(0,v.jsxs)(r.A,{sx:{mt:2,pt:2,borderTop:1,borderColor:"divider",display:"flex",justifyContent:"flex-end",gap:1},children:[(0,v.jsx)(u.A,{onClick:i,variant:"outlined",children:"Cancel"}),(0,v.jsx)(u.A,{type:"submit",variant:"contained",children:g?"Save Changes":"Add Item"})]})]})}},3691:(e,t,i)=>{i.d(t,{A:()=>C});var s=i(8613),r=i.n(s),o=i(8006),n=i(5895),l=i(267),a=i(8517),d=i(1911),c=i(4199),u=i(2967),m=i(9623),v=i(5557),p=i(549),h=i(5359),g=i(4225),x=i(2959),A=i(6185),b=i(4527),f=i(8263),S=i(4558),y=i(579);const j=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return void 0===e||null===e||""===e?(0,y.jsx)(n.A,{component:"span",sx:{color:t.palette.text.disabled},children:"N/A"}):`${i}${e}${s}`},I=e=>{var t;const i=new Date(e.timestamp).toLocaleString();switch(e.type){case"CREATED":return`${i}: Item Created`;case"EDITED":return`${i}: Item Edited (${(null===(t=e.details.changedFields)||void 0===t?void 0:t.join(", "))||"details"} changed)`;case"STATUS_CHANGED":return`${i}: Status changed from ${e.details.previousStatus||"?"} to ${e.details.newStatus||"?"}`;case"FLAG_TOGGLED":return`${i}: Item ${e.details.isFlagged?"Flagged":"Unflagged"}`;case"ISSUE_REPORTED":return`${i}: Issue Reported: ${e.details.issueDescription||""}`;case"ISSUE_UPDATE_ADDED":return`${i}: Issue Update Added: ${e.details.note||""}`;case"ISSUE_RESOLVED":return`${i}: Issue Resolved (Outcome: ${e.details.resolutionOutcome||"N/A"}${e.details.note?` - Note: ${e.details.note}`:""}`;case"NOTE_ADDED":return`${i}: Note Added: ${e.details.note||""}`;default:return`${i}: Unknown action`}},D=e=>{var t,i,s,r,n,l,a,d,c,u;const m=e.timestamp instanceof o.Timestamp?e.timestamp.toDate().toISOString():"string"===typeof e.timestamp?e.timestamp:(new Date).toISOString(),v=e.userId||"system";let p=null,h={};switch(e.action){case"item.create":p="CREATED";break;case"item.update.fields":p="EDITED";h={changedFields:e.before&&e.after?Object.keys(e.after).filter((t=>e.before&&e.after&&JSON.stringify(e.before[t])!==JSON.stringify(e.after[t]))):(null===(t=e.details)||void 0===t?void 0:t.changedFields)||["details"]};break;case"item.update.status.Delivered":p="STATUS_CHANGED",h={previousStatus:null===(i=e.before)||void 0===i?void 0:i.currentStatus,newStatus:"Delivered"};break;case"item.update.status.Archived":p="STATUS_CHANGED",h={previousStatus:null===(s=e.before)||void 0===s?void 0:s.currentStatus,newStatus:"Archived"};break;case"item.update.flag":p="FLAG_TOGGLED",h={isFlagged:null===(r=e.after)||void 0===r?void 0:r.isFlagged};break;case"item.update.issue.report":p="ISSUE_REPORTED",h={issueDescription:(null===(n=e.details)||void 0===n?void 0:n.description)||(null===(l=e.details)||void 0===l?void 0:l.issueDescription)};break;case"item.update.issue.resolve":p="ISSUE_RESOLVED",h={resolutionOutcome:null===(a=e.details)||void 0===a?void 0:a.outcome,note:null===(d=e.details)||void 0===d?void 0:d.note};break;case"item.update.issue.update":p="ISSUE_UPDATE_ADDED",h={note:null===(c=e.details)||void 0===c?void 0:c.note};break;case"item.add_note":p="NOTE_ADDED",h={note:null===(u=e.details)||void 0===u?void 0:u.note};break;default:return console.warn(`Unhandled log action type for UI mapping: ${e.action}`),null}return p?{timestamp:m,userId:v,type:p,details:h}:null},C=e=>{let{isOpen:t,item:i,orgId:C,onClose:N,closeButtonRef:k,onActionSelected:w}=e;const[E,O]=(0,s.useState)([]),[T,F]=(0,s.useState)(!0),[P,$]=(0,s.useState)(null),R=(0,S.tE)(i.currentStatus,i.isFlagged),U=(0,l.A)();return(0,s.useEffect)((()=>{if(null===i||void 0===i||!i.id||!C)return F(!1),void $("Missing item or organization ID for fetching logs.");O([]),F(!0),$(null);const e=(0,o.getFirestore)(),t=`stockItems/${i.id}`,s=(0,o.collection)(e,`orgs/${C}/logs`),r=(0,o.query)(s,(0,o.where)("entityPath","==",t),(0,o.orderBy)("timestamp","desc")),n=(0,o.onSnapshot)(r,(e=>{const t=e.docs.map((e=>({...e.data()}))).map(D).filter((e=>null!==e));O(t),F(!1)}),(e=>{console.error("Error fetching logs: ",e),$(`Failed to fetch activity log: ${e.message}`),F(!1)}));return()=>n()}),[null===i||void 0===i?void 0:i.id,C]),(0,y.jsxs)(a.A,{open:t,onClose:N,maxWidth:"md",fullWidth:!0,scroll:"paper",children:[(0,y.jsxs)(d.A,{children:[i.productName," - Details"]}),(0,y.jsxs)(c.A,{dividers:!0,children:[" ",(0,y.jsxs)(u.A,{sx:{mb:2,borderBottom:1,borderColor:"divider",pb:2},children:[(0,y.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:"bold"},children:"Actions"}),(0,y.jsxs)(m.A,{direction:"row",spacing:1,flexWrap:"wrap",children:[" ",R.map((e=>{const t=e.icon;return(0,y.jsx)(v.A,{variant:"outlined",size:"small",onClick:()=>w(i.id,e),startIcon:t?r().createElement(t,{fontSize:"inherit"}):void 0,children:e.label},e.id)}))]})]}),(0,y.jsxs)(u.A,{sx:{mb:2,borderBottom:1,borderColor:"divider",pb:2},children:[(0,y.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:"bold"},children:"Details"}),(0,y.jsxs)(n.A,{variant:"body2",children:["ID: ",j(i.id,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Delivery Name: ",j(i.deliveryName,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Product Name: ",j(i.productName,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Quantity: ",j(i.quantity,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Price/Item: ",j(i.pricePerItem,U,"$")]})," ",(0,y.jsxs)(n.A,{variant:"body2",children:["Order #: ",j(i.orderNumber,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Order Date: ",j(i.orderDate?new Date(i.orderDate).toLocaleDateString():null,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Seller: ",j(i.seller,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Purchase Status: ",j(i.purchaseStatus,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Current Status: ",j(i.currentStatus,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Date Delivered: ",j(i.dateDelivered?new Date(i.dateDelivered).toLocaleDateString():null,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Destination: ",j(i.destination,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["ASIN/SKU: ",j(i.asinSku,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Flagged: ",j(i.isFlagged?"Yes":"No",U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["VAT Registered: ",j(i.isVatRegistered,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Acquisition Notes: ",j(i.acquisitionNotes,U)]}),(0,y.jsxs)(n.A,{variant:"body2",children:["Processor Notes: ",j(i.processorNotes,U)]}),"Issue"===i.currentStatus&&(0,y.jsxs)(n.A,{variant:"body2",color:"error",children:["Issue Description: ",j(i.issueDescription,U)]})]}),(0,y.jsxs)(u.A,{children:[(0,y.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:"bold"},children:"Activity Log"}),T?(0,y.jsx)(p.A,{size:24}):P?(0,y.jsx)(h.A,{severity:"error",children:P}):E.length>0?(0,y.jsx)(g.A,{dense:!0,disablePadding:!0,children:E.map(((e,t)=>(0,y.jsxs)(r().Fragment,{children:[(0,y.jsx)(x.Ay,{disableGutters:!0,sx:{py:.5},children:(0,y.jsx)(A.A,{primary:I(e),primaryTypographyProps:{variant:"body2"},secondary:`User: ${e.userId}`,secondaryTypographyProps:{variant:"caption"}})}),t<E.length-1&&(0,y.jsx)(b.A,{component:"li",variant:"inset"})]},`${e.timestamp}-${t}`)))}):(0,y.jsx)(n.A,{variant:"body2",color:"text.secondary",children:"No activity recorded."})]})]}),(0,y.jsx)(f.A,{children:(0,y.jsx)(v.A,{onClick:N,ref:k,children:"Close"})})]})}},4420:(e,t,i)=>{i.d(t,{A:()=>x});i(8613);var s=i(5129),r=i(215),o=i(2967),n=i(5557),l=i(3287),a=i(6647),d=i(2571),c=i(3241),u=i(9421),m=i(2950),v=i(6936),p=i(9161),h=i(3745),g=i(579);const x=e=>{let{onAddItem:t,onOpenSettings:i,onOpenActivity:x,searchTerm:A,onSearchTermChange:b,showFlaggedOnly:f,onShowFlaggedOnlyChange:S,currentFilter:y,onCurrentFilterChange:j}=e;return(0,g.jsx)(s.A,{position:"static",color:"default",elevation:0,sx:{borderBottom:"1px solid",borderColor:"divider"},children:(0,g.jsxs)(r.A,{disableGutters:!0,sx:{p:1,display:"flex",flexWrap:"wrap",gap:1.5,alignItems:"center"},children:[(0,g.jsxs)(o.A,{sx:{display:"flex",gap:1,alignItems:"center"},children:[(0,g.jsx)(n.A,{variant:"contained",startIcon:(0,g.jsx)(m.A,{}),onClick:t,size:"medium",children:"Add Item"}),(0,g.jsx)(l.A,{title:"Table Settings",children:(0,g.jsx)(a.A,{size:"medium",onClick:i,"aria-label":"Table Settings",children:(0,g.jsx)(v.A,{})})}),(0,g.jsx)(l.A,{title:"User Activity Log",children:(0,g.jsx)(a.A,{size:"medium",onClick:x,"aria-label":"User Activity Log",children:(0,g.jsx)(p.A,{})})})]}),(0,g.jsx)(d.A,{variant:"outlined",size:"small",placeholder:"Search Items",value:A,onChange:e=>{b(e.target.value)},InputProps:{startAdornment:(0,g.jsx)(c.A,{position:"start",children:(0,g.jsx)(h.A,{color:"action",fontSize:"small"})})},sx:{minWidth:"250px",maxWidth:"400px",flexGrow:{xs:1,md:0}}}),(0,g.jsxs)(o.A,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center",flexGrow:1,justifyContent:{xs:"flex-start",md:"flex-end"}},children:[["All","Pending Delivery","Delivered","Issue","Late","Archived"].map((e=>{const t=y===e;return(0,g.jsx)(u.A,{label:e,size:"small",clickable:!0,variant:t?"filled":"outlined",color:t?"primary":"default",onClick:()=>{j(e)},sx:{fontWeight:t?600:400}},e)})),(0,g.jsx)(u.A,{label:"Flagged",size:"small",clickable:!0,variant:f?"filled":"outlined",color:f?"secondary":"default",onClick:()=>{S(!f)},sx:{fontWeight:f?600:400}},"flagged")]})]})})}},4558:(e,t,i)=>{i.d(t,{Do:()=>p,cj:()=>v,fW:()=>h,tE:()=>N});var s=i(2327),r=i(9963),o=i(2422),n=i(6384),l=i(210),a=i(1773),d=i(3201),c=i(7620),u=i(3665),m=i(8337);const v=[{id:"orderDate",label:"Order Date"},{id:"quantity",label:"Qty"},{id:"productName",label:"Product Name"},{id:"deliveryName",label:"Delivery Name"},{id:"pricePerItem",label:"Price/Item"},{id:"seller",label:"Seller/Source"},{id:"destination",label:"Destination"},{id:"asinSku",label:"ASIN/SKU"},{id:"purchaseStatus",label:"Purchase Status"},{id:"orderNumber",label:"Order #"},{id:"currentStatus",label:"Status"},{id:"isFlagged",label:"Flagged"},{id:"acquisitionNotes",label:"Acquisition Notes"},{id:"issueDescription",label:"Issue Description"},{id:"dateDelivered",label:"Date Delivered"},{id:"actions",label:"Actions"}],p=["orderDate","quantity","productName","deliveryName","currentStatus","actions"],h="incomingTool_visibleColumns",g={id:"Edit Item",label:"Edit",description:"Edit item details",icon:a.A},x={id:"Flag Item",label:"Flag",description:"Flag this item for attention",icon:s.A},A={id:"Unflag Item",label:"Unflag",description:"Remove the flag from this item",icon:m.A},b={id:"Archive",label:"Archive",description:"Archive this item",icon:r.A},f={id:"Unarchive Item",label:"Unarchive",description:"Restore this item from archive",icon:o.A},S={id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:n.A},y={id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:l.A},j={id:"Mark as Delivered",label:"Mark as Delivered",description:"Update status to Delivered",icon:d.A},I={id:"Resolve Issue",label:"Resolve Issue",description:"Mark the issue as resolved",icon:d.A},D={id:"Add Issue Update",label:"Add Issue Update",description:"Add an update note to the ongoing issue",icon:c.A},C={id:"View Details",label:"View Details",description:"View full item details",icon:u.A},N=(e,t)=>{let i=[];i.push(C);const s=t?A:x;switch(e){case"Pending Delivery":case"Late":i.push(j),i.push(S),i.push(y),i.push(g);break;case"Delivered":i.push(b),i.push(S),i.push(y),i.push(g);break;case"Issue":i.push(I),i.push(D),i.push(b),i.push(y),i.push(g);break;case"Archived":i.push(f),i.push(y);break;default:i.push(y)}return"Archived"!==e&&i.splice(1,0,s),i}},5929:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w});var s=i(8613),r=i.n(s),o=i(3368),n=i(3691),l=i(5982),a=i(1453),d=i(2630),c=i(7694),u=i(7553),m=i(8006),v=i(5359),p=i(267),h=i(6748),g=i(2967),x=i(1),A=i(1495),b=i(6427),f=i(161),S=i(612),y=i(8137),j=i(6439),I=i(4558),D=i(1499),C=i(4420),N=i(579);console.log("[IncomingTool] ToolApp.tsx: Top level, imported db is:",f.db);const k=r().forwardRef((function(e,t){return(0,N.jsx)(v.A,{elevation:6,ref:t,variant:"filled",...e})})),w=e=>{let{user:t,org:i,permissions:r,logAction:w}=e;console.log("ToolApp Props Received:",{user:t,orgId:null===i||void 0===i?void 0:i.id,permissions:r,logActionExists:!!w}),console.log("ToolApp using imported db:",f.db),console.log("ToolApp using imported auth:",f.auth);const{items:E,allItems:O,archivedItems:T,loading:F,error:P,searchTerm:$,currentFilter:R,showFlaggedOnly:U,setSearchTerm:L,setCurrentFilter:W,setShowFlaggedOnly:_,setError:q}=(0,S.Q)(null===i||void 0===i?void 0:i.id);console.log("[IncomingTool] useStockItems returned:",{loading:F,error:P,items_length:null===E||void 0===E?void 0:E.length,allItems_length:null===O||void 0===O?void 0:O.length,currentFilter:R,showFlaggedOnly:U,searchTerm:$});const[z,G]=(0,s.useState)(null),[V,B]=(0,s.useState)(!1),[M,H]=(0,s.useState)(null),[J,K]=(0,s.useState)(null),[Q,Y]=(0,s.useState)(null),[X,Z]=(0,s.useState)(null),[ee,te]=(0,s.useState)(!1),[ie,se]=(0,s.useState)(null),[re,oe]=(0,s.useState)(!1),[ne,le]=(0,s.useState)((()=>{try{const e=localStorage.getItem(I.fW),t=e?JSON.parse(e):I.Do;return Array.isArray(t)?t:I.Do}catch(P){return console.error("Error reading visible columns from localStorage",P),I.Do}})),[ae,de]=(0,s.useState)(null),[ce,ue]=(0,s.useState)(null);(0,s.useEffect)((()=>{localStorage.setItem(I.fW,JSON.stringify(ne))}),[ne]);const me=ne.map((e=>I.cj.find((t=>t.id===e)))).filter((e=>void 0!==e)),[ve,pe]=(0,s.useState)(!1),[he,ge]=(0,s.useState)(""),[xe,Ae]=(0,s.useState)("success"),be=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";ge(e),Ae(t),pe(!0)},fe=(e,t)=>{"clickaway"!==t&&pe(!1)},Se=(0,s.useCallback)((async(e,t,s,r,o)=>{if(console.log("[IncomingTool] updateItemAndLog: Checking db and org.id:",{db_instance:f.db,org_id:null===i||void 0===i?void 0:i.id}),!f.db||null===i||void 0===i||!i.id||!t)return console.error("Cannot update item: Missing configuration.",{db:!!f.db,orgId:null===i||void 0===i?void 0:i.id,userId:t}),q("Cannot update item: Missing configuration."),void be("Cannot update item: Missing configuration.","error");console.log(`[IncomingTool] updateItemAndLog: Preparing to update item ${e} in org ${i.id}`);const n=(0,m.doc)(f.db,"orgs",i.id,"stockItems",e),l=O.find((t=>t.id===e));if(!l)return console.error(`Item ${e} not found for update`),q(`Item ${e} not found.`),void be(`Item ${e} not found.`,"error");const a=(0,j.uJ)({...s,lastUpdated:(0,m.serverTimestamp)()}),d={...l,...a};try{if(await(0,m.updateDoc)(n,a),console.log(`Item ${e} updated successfully.`),be(o||"Item updated successfully.","success"),console.log("updateItemAndLog: Attempting to log action. logAction available?",!!w),w){let t;try{if("EDITED"===r.type)t="item.update.fields";else if("FLAG_TOGGLED"===r.type)t="item.update.flag";else if("STATUS_CHANGED"===r.type){var c,u;t=`item.update.status.${(null===(c=r.details)||void 0===c||null===(u=c.newStatus)||void 0===u?void 0:u.toLowerCase())||"unknown"}`}else t="ISSUE_REPORTED"===r.type?"item.update.issue.report":"ISSUE_RESOLVED"===r.type?"item.update.issue.resolve":"ISSUE_UPDATE_ADDED"===r.type?"item.update.issue.update":"NOTE_ADDED"===r.type?"item.add_note":r.type}catch(v){console.error("Error deriving action name for logging:",v),t=r.type}const s={orgId:i.id,toolKey:"incomingtool",action:t,entityPath:`stockItems/${e}`,...void 0!==l&&{before:l},...void 0!==d&&{after:d},...void 0!==r.details&&{details:r.details}};await w(s)}}catch(p){console.error(`Error updating item ${e}:`,p),q(`Failed to update item: ${p.message}`),be(`Failed to update item: ${p.message}`,"error")}}),[i,O,w,q]),ye=(0,s.useCallback)((async(e,i)=>{console.log(`Action: ${i.label} on item ${e}`);const s=O.find((t=>t.id===e))||T.find((t=>t.id===e));if(!s)return console.error(`Item ${e} not found for action ${i.id}.`),q(`Item ${e} not found.`),void be(`Item ${e} not found.`,"error");try{switch(i.id){case"Edit Item":H(s),B(!0);break;case"Flag Item":case"Unflag Item":const r="Flag Item"===i.id;await Se(e,null===t||void 0===t?void 0:t.uid,{isFlagged:r},(0,j.is)((null===t||void 0===t?void 0:t.uid)||"","FLAG_TOGGLED",{isFlagged:r}),`Item ${r?"flagged":"unflagged"}.`);break;case"Mark as Delivered":"Delivered"!==s.currentStatus&&await Se(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Delivered",dateDelivered:(new Date).toISOString()},(0,j.is)((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:s.currentStatus,newStatus:"Delivered"}),"Item marked as Delivered.");break;case"Archive":if("Archived"!==s.currentStatus){const i=s.currentStatus;await Se(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Archived",previousStatus:i},(0,j.is)((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:i,newStatus:"Archived"}),"Item archived.")}break;case"Unarchive Item":if("Archived"===s.currentStatus){const i=s.previousStatus||"Delivered";await Se(e,null===t||void 0===t?void 0:t.uid,{currentStatus:i,previousStatus:void 0},(0,j.is)((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:"Archived",newStatus:i}),"Item unarchived.")}break;case"Report Issue":G(null),K(s);break;case"Resolve Issue":G(null),Z(s);break;case"Add Issue Update":G(null),Y(s);break;case"Add Note":se(s)}}catch(r){console.error(`Error performing action ${i.label} on item ${e}:`,r)}}),[null===t||void 0===t?void 0:t.uid,O,T,Se,q,G,K,Z,Y,se]),je=(0,s.useCallback)((e=>{const t=O.find((t=>t.id===e));return t?(console.log("Viewing details for:",t),i?void G(t):(console.error("Org ID is missing, cannot fetch logs."),void q("Organization context is missing."))):(console.error("Item not found for viewing details:",e),void q("Item not found."))}),[i,O,q]),Ie=(0,p.A)(),De=(0,h.A)(Ie.breakpoints.down("sm"));return(0,N.jsxs)(g.A,{sx:{p:De?1:2},children:[(0,N.jsx)(C.A,{onAddItem:()=>{H(null),B(!0)},onOpenSettings:()=>te(!0),onOpenActivity:()=>oe(!0),searchTerm:$,onSearchTermChange:L,showFlaggedOnly:U,onShowFlaggedOnlyChange:_,currentFilter:R,onCurrentFilterChange:W}),P&&(0,N.jsx)(v.A,{severity:"error",onClose:()=>q(null),sx:{},children:P}),F&&(0,N.jsx)(x.A,{sx:{position:"absolute",top:0,left:0,right:0}}),(0,N.jsx)(y.A,{items:E,loading:F,isMobile:De,visibleColumns:me,visibleColumnIds:ne,onColumnOrderChange:e=>le(e),onViewDetails:je,onMenuOpen:(e,t)=>{ue(e.currentTarget),de(t.id)}}),(0,N.jsx)(A.Ay,{anchor:"right",open:V,onClose:()=>B(!1),PaperProps:{sx:{width:{xs:"90%",sm:"500px",md:"600px"}}},children:(0,N.jsx)(o.A,{onClose:()=>B(!1),onSave:async(e,s)=>{if(null===t||void 0===t||!t.uid||null===i||void 0===i||!i.id||!f.db)return q("Missing user, org, or DB connection."),void be("Save failed: Missing user, org, or DB connection.","error");const r=(0,j.uJ)({...e,lastUpdated:(0,m.serverTimestamp)()});try{if(s){console.log(`[IncomingTool] handleSaveItem: Updating item ${s}`);(0,m.doc)(f.db,"orgs",i.id,"stockItems",s);const o=(0,j.is)(t.uid,"EDITED",{changedFields:Object.keys(e)});await Se(s,t.uid,r,o,"Item updated successfully.")}else{console.log("[IncomingTool] handleSaveItem: Adding new item");const e=(0,m.collection)(f.db,"orgs",i.id,"stockItems"),s={...r,currentStatus:"Pending Delivery",activityLog:[(0,j.is)(t.uid,"CREATED")],orgId:i.id},o=await(0,m.addDoc)(e,s);console.log("[IncomingTool] handleSaveItem: Item added with ID:",o.id),be("Item added successfully.","success"),w&&await w({orgId:i.id,toolKey:"incomingtool",action:"item.create",entityPath:`stockItems/${o.id}`,after:{id:o.id,...s}})}B(!1),H(null)}catch(o){console.error("Error saving item:",o),q(`Failed to save item: ${o.message}`),s||be(`Failed to add item: ${o.message}`,"error")}},initialData:M})}),z&&(0,N.jsx)(n.A,{isOpen:!!z,onClose:()=>G(null),item:z,orgId:null===i||void 0===i?void 0:i.id,onActionSelected:ye}),J&&(0,N.jsx)(l.A,{isOpen:!!J,onClose:()=>K(null),item:J,onSubmit:e=>(async(e,t,i)=>{const s=(0,j.is)(i,"ISSUE_REPORTED",{issueDescription:t});await Se(e,i,{currentStatus:"Issue",issueDescription:t},s,"Issue reported successfully."),K(null)})(J.id,e,(null===t||void 0===t?void 0:t.uid)||"")}),Q&&(0,N.jsx)(a.A,{isOpen:!!Q,onClose:()=>Y(null),item:Q,onSubmit:e=>(async(e,t,i)=>{const s=(0,j.is)(i,"ISSUE_UPDATE_ADDED",{note:t});await Se(e,i,{},s,"Issue update added."),console.warn("Issue update note logged, but not stored directly on item field in this basic implementation."),Y(null)})(Q.id,e,(null===t||void 0===t?void 0:t.uid)||"")}),X&&(0,N.jsx)(d.A,{isOpen:!!X,onClose:()=>Z(null),item:X,onSubmit:(e,i)=>(async(e,t,i)=>{if(!O.find((t=>t.id===e)))return;const s=(0,j.is)(i,"ISSUE_RESOLVED",{resolutionOutcome:t});await Se(e,i,{currentStatus:"Delivered",issueDescription:"Resolved: "+t},s,"Issue resolved successfully."),Z(null)})(X.id,e,(null===t||void 0===t?void 0:t.uid)||"")}),ie&&(0,N.jsx)(a.A,{isOpen:!!ie,onClose:()=>se(null),item:ie,onSubmit:e=>(async(e,t,i)=>{const s=(0,j.is)(i,"NOTE_ADDED",{note:t});await Se(e,i,{},s,"Note added successfully."),console.warn("General note logged, but not stored directly on item field."),se(null)})(ie.id,e,(null===t||void 0===t?void 0:t.uid)||"")}),(0,N.jsx)(c.A,{isOpen:ee,onClose:()=>te(!1),allColumns:I.cj.filter((e=>"actions"!==e.id)),initialVisibleColumns:me,onSave:le}),(0,N.jsx)(u.A,{isOpen:re,db:f.db,orgId:null===i||void 0===i?void 0:i.id,onClose:()=>oe(!1)}),(()=>{if(!ae)return null;const e=O.find((e=>e.id===ae));if(!e)return null;const t=(0,I.tE)(e.currentStatus,e.isFlagged);return(0,N.jsx)(D.W,{itemId:e.id,actions:t,onActionSelected:ye,anchorEl:ce,open:Boolean(ce&&ae===e.id),onClose:()=>ue(null)})})(),(0,N.jsx)(b.A,{open:ve,autoHideDuration:6e3,onClose:fe,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:(0,N.jsx)(k,{onClose:fe,severity:xe,sx:{width:"100%"},children:he})})]})}},5982:(e,t,i)=>{i.d(t,{A:()=>m});var s=i(8613),r=i(8517),o=i(1911),n=i(5895),l=i(4199),a=i(2571),d=i(8263),c=i(5557),u=i(579);const m=e=>{let{isOpen:t,item:i,onSubmit:m,onClose:v}=e;const[p,h]=(0,s.useState)(""),[g,x]=(0,s.useState)("");return(0,u.jsxs)(r.A,{open:t,onClose:v,maxWidth:"sm",fullWidth:!0,children:[(0,u.jsxs)(o.A,{children:[(0,u.jsx)(n.A,{variant:"h6",children:"Report Issue for:"}),(0,u.jsxs)(n.A,{variant:"body2",color:"textSecondary",sx:{fontStyle:"italic"},children:[i.productName," - ",i.deliveryName]})]}),(0,u.jsx)(l.A,{dividers:!0,children:(0,u.jsx)(a.A,{autoFocus:!0,id:"issueDescription",label:"Describe the Issue *",type:"text",fullWidth:!0,multiline:!0,rows:4,variant:"outlined",size:"small",sx:{mb:2},value:p,onChange:e=>{h(e.target.value),g&&x("")},error:!!g,helperText:g||"Please provide details about the problem."})}),(0,u.jsxs)(d.A,{sx:{padding:"16px 24px"},children:[(0,u.jsx)(c.A,{onClick:v,color:"secondary",children:"Cancel"}),(0,u.jsx)(c.A,{onClick:()=>{p.trim()?(m(p),v()):x("Please enter a description of the issue.")},variant:"contained",color:"primary",children:"Save Issue Report"})]})]})}},6439:(e,t,i)=>{function s(e){return Object.fromEntries(Object.entries(e).filter((e=>{let[t,i]=e;return void 0!==i})))}i.d(t,{is:()=>o,oG:()=>r,uJ:()=>s});const r=e=>{if("Pending Delivery"!==e.currentStatus)return!1;if(!e.orderDate||isNaN(new Date(e.orderDate).getTime()))return console.warn("Invalid or missing orderDate for late check:",e.id),!1;const t=new Date(e.orderDate),i=new Date;return i.setDate(i.getDate()-7),t<i},o=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{timestamp:(new Date).toISOString(),type:t,userId:e,details:i}}},7553:(e,t,i)=>{i.d(t,{A:()=>A});var s=i(8613),r=i(8006),o=i(6185),n=i(5895),l=i(8517),a=i(1911),d=i(4199),c=i(2967),u=i(549),m=i(4225),v=i(2959),p=i(4527),h=i(8263),g=i(5557),x=i(579);const A=e=>{let{isOpen:t,db:i,orgId:A,onClose:b}=e;const[f,S]=(0,s.useState)([]),[y,j]=(0,s.useState)(!0),[I,D]=(0,s.useState)(null),[C,N]=(0,s.useState)({});(0,s.useEffect)((()=>{if(!A)return;const e=(0,r.collection)(i,`orgs/${A}/members`);(0,r.getDocs)(e).then((e=>{const t={};e.docs.forEach((e=>{const i=e.data();t[e.id]=i.email||e.id})),N(t)})).catch((e=>console.error("Error fetching members:",e)))}),[A,i,N]),(0,s.useEffect)((()=>{if(!A)return D("Organization ID is required."),void j(!1);j(!0),D(null);const e=(0,r.collection)(i,`orgs/${A}/logs`),t=(0,r.query)(e,(0,r.where)("tool","==","incomingtool"),(0,r.orderBy)("ts","desc"),(0,r.limit)(100)),s=(0,r.onSnapshot)(t,(e=>{const t=e.docs.map((e=>{const t=e.data();return{orgId:A,toolKey:t.toolKey||t.tool,action:t.action,entityPath:t.entityPath,timestamp:t.timestamp||t.ts,userId:t.userId||t.uid,userEmail:t.email,before:t.before,after:t.after,details:t.details}})).filter((e=>"app-loaded"!==e.action));S(t),j(!1)}),(e=>{console.error("Error fetching user activity logs: ",e);D(`Failed to load activity logs: ${e.message}`),j(!1)}));return()=>s()}),[A,i,S]);const k=e=>{var t,i,l;const a=e.timestamp instanceof r.Timestamp?e.timestamp.toDate().toLocaleString():"string"===typeof e.timestamp?new Date(e.timestamp).toLocaleString():"Invalid Date",d=e.userEmail||C[e.userId||""]||e.userId||"system",c=(e=>{switch(e.action){case"item.create":return"Item created";case"item.update.fields":{var t,i;if(e.before&&e.after){var s;const t=(null===(s=e.details)||void 0===s?void 0:s.changedFields)||Object.keys(e.after).filter((t=>{var i,s;return JSON.stringify(null===(i=e.before)||void 0===i?void 0:i[t])!==JSON.stringify(null===(s=e.after)||void 0===s?void 0:s[t])}));if(t.length)return`Edited ${t.map((t=>{var i,s;return`${t}: ${null===(i=e.before)||void 0===i?void 0:i[t]} \u2192 ${null===(s=e.after)||void 0===s?void 0:s[t]}`})).join(", ")}`}const r=null===(t=e.details)||void 0===t||null===(i=t.changedFields)||void 0===i?void 0:i.join(", ");return r?`Edited fields: ${r}`:"Item edited"}default:var r,o,n,l,a,d,c,u,m;return e.action.startsWith("item.update.status.")?`Status changed: ${(null===(r=e.details)||void 0===r?void 0:r.previousStatus)||(null===(o=e.before)||void 0===o?void 0:o.currentStatus)||"Unknown"} \u2192 ${(null===(n=e.details)||void 0===n?void 0:n.newStatus)||e.action.replace("item.update.status.","")}`:"item.update.flag"===e.action?(null===(l=e.details)||void 0===l?void 0:l.isFlagged)?"Item flagged":"Item unflagged":"item.update.issue.report"===e.action?`Issue reported: ${(null===(a=e.details)||void 0===a?void 0:a.description)||(null===(d=e.details)||void 0===d?void 0:d.issueDescription)||""}`:"item.update.issue.update"===e.action?`Issue update added: ${(null===(c=e.details)||void 0===c?void 0:c.note)||""}`:"item.update.issue.resolve"===e.action?`Issue resolved: ${(null===(u=e.details)||void 0===u?void 0:u.resolutionOutcome)||""}`:"item.add_note"===e.action?`Note added: ${(null===(m=e.details)||void 0===m?void 0:m.note)||""}`:e.action}})(e),u=e.entityPath.split("/"),m=u.length>=2?u[1]:"",v=null===(t=e.before)||void 0===t?void 0:t.quantity,p=null===(i=e.before)||void 0===i?void 0:i.productName,h=v&&p?`${v}x ${p}`:(null===(l=e.before)||void 0===l?void 0:l.deliveryName)||p||m;return(0,x.jsx)(o.A,{primary:(0,x.jsxs)(s.Fragment,{children:[(0,x.jsxs)(n.A,{sx:{display:"inline"},component:"span",variant:"body2",color:"text.primary",children:[a," - ",c," by ",d]}),(0,x.jsx)(n.A,{component:"span",variant:"body2",sx:{ml:1,color:"text.secondary"},children:h})]})})};return(0,x.jsxs)(l.A,{open:t,onClose:b,maxWidth:"md",fullWidth:!0,scroll:"paper",children:[(0,x.jsxs)(a.A,{children:[(0,x.jsx)(n.A,{variant:"h6",children:"User Activity Log"}),(0,x.jsx)(n.A,{variant:"caption",children:"Last 100 entries"})]}),(0,x.jsxs)(d.A,{dividers:!0,children:[y&&(0,x.jsx)(c.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px"},children:(0,x.jsx)(u.A,{})}),I&&(0,x.jsx)(n.A,{color:"error",sx:{textAlign:"center",mt:2},children:I}),!y&&!I&&(0,x.jsx)(m.A,{dense:!0,sx:{width:"100%",bgcolor:"background.paper",p:0},children:0===f.length?(0,x.jsx)(v.Ay,{children:(0,x.jsx)(o.A,{primary:"No activity logs found."})}):f.map(((e,t)=>(0,x.jsxs)(s.Fragment,{children:[(0,x.jsx)(v.Ay,{alignItems:"flex-start",sx:{py:1.5},children:k(e)}),t<f.length-1&&(0,x.jsx)(p.A,{variant:"inset",component:"li"})]},`${e.timestamp}-${t}-${e.action}`)))})]}),(0,x.jsx)(h.A,{sx:{padding:"16px 24px"},children:(0,x.jsx)(g.A,{onClick:b,color:"primary",children:"Close"})})]})}},7694:(e,t,i)=>{i.d(t,{A:()=>h});var s=i(8613),r=i(8517),o=i(1911),n=i(5895),l=i(4199),a=i(2967),d=i(6679),c=i(5847),u=i(5303),m=i(8263),v=i(5557),p=i(579);const h=e=>{let{isOpen:t,onClose:i,allColumns:h,initialVisibleColumns:g,onSave:x}=e;const[A,b]=(0,s.useState)((()=>Object.fromEntries(h.map((e=>[e.id,!1])))));(0,s.useEffect)((()=>{if(t){const e=new Set(g.map((e=>e.id))),t=Object.fromEntries(h.map((t=>[t.id,e.has(t.id)])));b(t)}}),[t,g,h]);return(0,p.jsxs)(r.A,{open:t,onClose:i,maxWidth:"xs",fullWidth:!0,children:[(0,p.jsx)(o.A,{children:(0,p.jsx)(n.A,{variant:"h6",children:"Configure Table Columns"})}),(0,p.jsxs)(l.A,{dividers:!0,children:[(0,p.jsx)(n.A,{variant:"body2",gutterBottom:!0,children:"Select the columns you want to display:"}),(0,p.jsxs)(a.A,{sx:{maxHeight:"60vh",overflowY:"auto",pr:1},children:[" ",(0,p.jsx)(d.A,{children:h.map((e=>(0,p.jsx)(c.A,{control:(0,p.jsx)(u.A,{checked:A[e.id]||!1,onChange:()=>{return t=e.id,void b((e=>({...e,[t]:!e[t]})));var t},disabled:"actions"===e.id}),label:e.label},e.id)))})]})]}),(0,p.jsxs)(m.A,{sx:{padding:"16px 24px"},children:[(0,p.jsx)(v.A,{onClick:i,color:"secondary",children:"Cancel"}),(0,p.jsx)(v.A,{onClick:()=>{const e=h.map((e=>e.id)).filter((e=>A[e]));x(e)},variant:"contained",color:"primary",children:"Save Settings"})]})]})}},8137:(e,t,i)=>{i.d(t,{A:()=>k});i(8613);var s=i(9284),r=i(1648),o=i(1024),n=i(6800),l=i(2731),a=i(6393),d=i(5495),c=i(2967),u=i(5895),m=i(6647),v=i(9421),p=i(6859),h=i(2523),g=i(2011),x=i(4755),A=i(9841),b=i(1399),f=i(267),S=i(2043),y=i(2327),j=i(6439),I=i(579);const D=e=>{switch(e){case"Delivered":return{color:"success",variant:"filled"};case"Issue":return{color:"error",variant:"filled"};case"Late":return{color:"warning",variant:"filled"};case"Pending Delivery":return{color:"info",variant:"outlined"};default:return{color:"default",variant:"outlined"}}},C=e=>{let{column:t}=e;const{attributes:i,listeners:s,setNodeRef:n,transform:a,transition:d,isDragging:c}=(0,r.gl)({id:t.id}),u={transform:o.Ks.Transform.toString(a),transition:d,opacity:c?.5:1,cursor:"grab",touchAction:"none"},m=["quantity","pricePerItem"].includes(t.id);return(0,I.jsx)(l.A,{ref:n,style:u,...i,...s,align:m?"right":"left",padding:"actions"===t.id?"checkbox":"normal",sx:{whiteSpace:"nowrap"},children:t.label})},N=e=>{var t;let{item:i,onViewDetails:s,onActionClick:r,theme:o}=e;const n=D(i.currentStatus);return(0,I.jsx)(a.A,{variant:"outlined",sx:{mb:1,cursor:"pointer","&:hover":{bgcolor:"action.hover"}},onClick:()=>s(i.id),children:(0,I.jsxs)(d.A,{sx:{pb:"8px !important",position:"relative"},children:[(0,I.jsxs)(c.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[(0,I.jsxs)(c.A,{sx:{flexGrow:1,mr:1,display:"flex",alignItems:"center",gap:.5},children:[i.isFlagged&&(0,I.jsx)(y.A,{sx:{color:"secondary.main",fontSize:"1rem"}}),(0,I.jsx)(u.A,{variant:"subtitle1",component:"div",sx:{fontWeight:"bold",lineHeight:1.3},children:i.productName||i.deliveryName||"Unnamed Item"})]}),(0,I.jsx)(m.A,{size:"small",onClick:e=>{e.stopPropagation(),r(e,i)},sx:{position:"absolute",top:4,right:4},children:(0,I.jsx)(S.A,{})})]}),(0,I.jsx)(v.A,{label:i.currentStatus,size:"small",color:n.color,variant:n.variant,sx:{mr:1,mt:.5,mb:.5}}),(0,I.jsxs)(u.A,{variant:"body2",color:"text.secondary",display:"inline",children:["Qty: ",null!==(t=i.quantity)&&void 0!==t?t:"N/A"," | Seller: ",i.seller||"N/A"]}),(0,I.jsxs)(u.A,{variant:"body2",color:"text.secondary",display:"block",sx:{fontSize:"0.8rem"},children:["Order Date: ",i.orderDate?new Date(i.orderDate).toLocaleDateString():"N/A"]})]})})},k=e=>{let{items:t,loading:i,isMobile:o,visibleColumns:a,visibleColumnIds:d,onColumnOrderChange:k,onViewDetails:w,onMenuOpen:E}=e;const O=(0,s.FR)((0,s.MS)(s.AN),(0,s.MS)(s.uN,{coordinateGetter:r.JR})),T=(0,f.A)();return i?(0,I.jsx)(u.A,{children:"Loading items..."}):o?(0,I.jsxs)(c.A,{sx:{pt:1},children:[" ",t.map((e=>(0,I.jsx)(N,{item:e,onViewDetails:w,onActionClick:E,theme:T},e.id))),0===t.length&&!i&&(0,I.jsx)(u.A,{align:"center",sx:{mt:4,color:"text.secondary"},children:"No items match the current filters."})]}):(0,I.jsx)(s.Mp,{sensors:O,collisionDetection:s.fp,onDragEnd:e=>{const{active:t,over:i}=e;if(i&&t.id!==i.id){const e=d.indexOf(t.id),s=d.indexOf(i.id);if(-1===e||-1===s)return void console.error("Dragged item ID not found in visible columns",{activeId:t.id,overId:i.id});const o=(0,r.be)(d,e,s);k(o)}},modifiers:[n.dU],children:(0,I.jsxs)(p.A,{component:h.A,elevation:1,sx:{mt:2},children:[" ",(0,I.jsxs)(g.A,{size:"small",children:[(0,I.jsxs)(x.A,{sx:{bgcolor:"grey.100"},children:[" ",(0,I.jsx)(A.A,{children:(0,I.jsx)(r.gB,{items:d,strategy:r.m$,children:a.map((e=>(0,I.jsx)(C,{column:e},e.id)))})})]}),(0,I.jsx)(b.A,{children:t.map((e=>{const t=(0,j.oG)(e),i=D(e.currentStatus);return(0,I.jsx)(A.A,{hover:!0,onClick:()=>w(e.id),sx:{cursor:"pointer",bgcolor:"background.paper","&:hover":{bgcolor:"action.hover"},"&:last-child td, &:last-child th":{border:0},...t&&{borderLeft:3,borderColor:"warning.main"}},children:a.map((t=>{var s;const r=null!==(s=e[t.id])&&void 0!==s?s:"",o=["quantity","pricePerItem"].includes(t.id);return(0,I.jsx)(l.A,{align:o?"right":"left",padding:"actions"===t.id?"checkbox":"normal",sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:"actions"===t.id?(0,I.jsx)(m.A,{size:"small",onClick:t=>{t.stopPropagation(),E(t,e)},color:"inherit",children:(0,I.jsx)(S.A,{fontSize:"small"})}):"currentStatus"===t.id?(0,I.jsx)(v.A,{label:e.currentStatus,size:"small",color:i.color,variant:i.variant}):"isFlagged"===t.id?e.isFlagged?(0,I.jsx)(y.A,{sx:{fontSize:"1rem",color:"secondary.main",display:"block",margin:"auto"}}):null:"orderDate"===t.id||"dateDelivered"===t.id?r?new Date(r).toLocaleDateString():"":["deliveryName","productName"].includes(t.id)?(0,I.jsxs)(c.A,{component:"span",sx:{display:"flex",alignItems:"center",gap:.5},children:[e.isFlagged&&(0,I.jsx)(y.A,{sx:{color:"secondary.main",fontSize:"1rem"}}),r]}):r},t.id)}))},e.id)}))})]}),0===t.length&&!i&&(0,I.jsx)(u.A,{align:"center",sx:{p:4,color:"text.secondary"},children:"No items match the current filters."})]})})}}}]);
//# sourceMappingURL=935.f649ab2f.chunk.js.map