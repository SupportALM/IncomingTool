"use strict";(self.webpackChunkincoming_tool=self.webpackChunkincoming_tool||[]).push([[894],{612:(e,t,i)=>{i.d(t,{Q:()=>n});var o=i(8613),s=i(8006),r=i(161);const n=e=>{const[t,i]=(0,o.useState)([]),[n,l]=(0,o.useState)(!0),[a,d]=(0,o.useState)(null),[c,u]=(0,o.useState)(""),[m,g]=(0,o.useState)("All"),[p,h]=(0,o.useState)(!1);(0,o.useEffect)((()=>{if(console.log("[useStockItems] useEffect: Checking db and orgId:",{db_instance:r.db,org_id:e}),!r.db||!e)return console.warn("[useStockItems] useEffect: db or orgId is missing, skipping Firestore query."),l(!1),void(e||i([]));l(!0),d(null),console.log(`[useStockItems] useEffect: Setting up listener for orgs/${e}/stockItems`);const t=(0,s.query)((0,s.collection)(r.db,"orgs",e,"stockItems"),(0,s.orderBy)("orderDate","desc")),o=(0,s.onSnapshot)(t,(e=>{console.log("[useStockItems] useEffect: Received snapshot.");const t=e.docs.map((e=>({id:e.id,...e.data()})));i(t),l(!1)}),(e=>{console.error("[useStockItems] useEffect: Snapshot error:",e),d("Failed to load items: "+e.message),l(!1)}));return()=>{console.log("[useStockItems] useEffect: Cleaning up listener."),o()}}),[e]);const A=(0,o.useMemo)((()=>t.filter((e=>{const t=c.toLowerCase(),i=e.deliveryName&&"string"===typeof e.deliveryName&&e.deliveryName.toLowerCase().includes(t)||e.productName&&"string"===typeof e.productName&&e.productName.toLowerCase().includes(t)||e.seller&&"string"===typeof e.seller&&e.seller.toLowerCase().includes(t)||e.asinSku&&"string"===typeof e.asinSku&&e.asinSku.toLowerCase().includes(t);let o=!1;o="All"===m||("Late"===m?(e=>{if("Pending Delivery"!==e.currentStatus)return!1;const t=new Date(e.orderDate),i=new Date;return i.setDate(i.getDate()-7),t<i})(e):e.currentStatus===m);const s=!p||!0===e.isFlagged;return o&&i&&s}))),[t,c,m,p]);return{allItems:t,items:A,loading:n,error:a,searchTerm:c,currentFilter:m,showFlaggedOnly:p,setSearchTerm:u,setCurrentFilter:g,setShowFlaggedOnly:h,setError:d}}},5929:(e,t,i)=>{i.r(t),i.d(t,{ActionMenu:()=>M,default:()=>B,getAvailableActions:()=>G});var o=i(8613),s=i(9284),r=i(8677),n=i(1024),l=i(8006),a=i(6623),d=i(8512),c=i(9801),u=i(6185),m=i(2731),g=i(267),p=i(6748),h=i(6393),A=i(5495),v=i(2967),S=i(5895),f=i(6647),x=i(5359),b=i(1),y=i(2571),I=i(5847),D=i(5303),w=i(8229),j=i(6859),k=i(2523),N=i(2011),C=i(4755),E=i(9841),F=i(1399),T=i(2043),O=i(2327),_=i(9963),z=i(2422),L=i(6384),R=i(210),U=i(161),P=i(612),$=i(579);console.log("[IncomingTool] ToolApp.tsx: Top level, imported db is:",U.db);const q=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{timestamp:(new Date).toISOString(),type:t,userId:e,details:i}},G=(e,t)=>{let i=[];switch(e){case"Pending Delivery":case"Late":i=[{id:"Mark as Delivered",label:"Mark as Delivered",description:"Update status to Delivered"},{id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:(0,$.jsx)(L.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,$.jsx)(R.A,{fontSize:"small"})}];break;case"Delivered":i=[{id:"Archive",label:"Archive",description:"Archive this item",icon:(0,$.jsx)(_.A,{fontSize:"small"})},{id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:(0,$.jsx)(L.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,$.jsx)(R.A,{fontSize:"small"})}];break;case"Issue":i=[{id:"Resolve Issue",label:"Resolve Issue",description:"Mark the issue as resolved"},{id:"Add Issue Update",label:"Add Issue Update",description:"Add an update note to the ongoing issue"},{id:"Archive",label:"Archive",description:"Archive this item",icon:(0,$.jsx)(_.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a general note to the item history",icon:(0,$.jsx)(R.A,{fontSize:"small"})}];break;case"Archived":i=[{id:"Unarchive Item",label:"Unarchive",description:"Restore this item from archive",icon:(0,$.jsx)(z.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,$.jsx)(R.A,{fontSize:"small"})}];break;default:i=[{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,$.jsx)(R.A,{fontSize:"small"})}]}return"Archived"!==e&&i.unshift(t?{id:"action_unflag",label:"Unflag",description:"Remove the flag from this item",icon:(0,$.jsx)(O.A,{fontSize:"small",color:"disabled"})}:{id:"action_flag",label:"Flag",description:"Flag this item for attention",icon:(0,$.jsx)(O.A,{fontSize:"small"})}),i},M=e=>{let{itemId:t,actions:i,onActionSelected:o,onClose:s,anchorEl:r,open:n}=e;return(0,$.jsx)(a.A,{anchorEl:r,open:n,onClose:s,MenuListProps:{"aria-labelledby":`actions-button-${t}`},children:i.map((e=>(0,$.jsxs)(d.A,{onClick:()=>(e=>{o(t,e),s()})(e),children:[e.icon&&(0,$.jsx)(c.A,{sx:{minWidth:"32px"},children:e.icon}),(0,$.jsx)(u.A,{primary:e.label})]},e.id)))})},W=[{id:"orderDate",label:"Order Date"},{id:"quantity",label:"Qty"},{id:"productName",label:"Product Name"},{id:"deliveryName",label:"Delivery Name"},{id:"pricePerItem",label:"Price/Item"},{id:"seller",label:"Seller/Source"},{id:"destination",label:"Destination"},{id:"asinSku",label:"ASIN/SKU"},{id:"purchaseStatus",label:"Purchase Status"},{id:"orderNumber",label:"Order #"},{id:"currentStatus",label:"Status"},{id:"isFlagged",label:"Flagged"},{id:"acquisitionNotes",label:"Acquisition Notes"},{id:"issueDescription",label:"Issue Description"},{id:"dateDelivered",label:"Date Delivered"},{id:"actions",label:"Actions"}],H=["orderDate","quantity","productName","deliveryName","currentStatus","actions"],V="incomingTool_visibleColumns",Q=e=>{let{column:t}=e;const{attributes:i,listeners:o,setNodeRef:s,transform:l,transition:a,isDragging:d}=(0,r.gl)({id:t.id}),c={transform:n.Ks.Transform.toString(l),transition:a,opacity:d?.5:1,touchAction:"none"},u=["quantity","pricePerItem"].includes(t.id);return(0,$.jsxs)(m.A,{ref:s,component:"th",scope:"col",style:c,...i,...o,align:u?"right":"left",sx:{fontWeight:"bold",cursor:"grab",whiteSpace:"nowrap",bgcolor:d?"#e0e0e0":"background.paper",..."isFlagged"===t.id&&{width:50,p:"6px 8px"},..."seller"===t.id&&{minWidth:140},..."deliveryName"===t.id&&{minWidth:160},..."quantity"===t.id&&{width:80},..."destination"===t.id&&{minWidth:110},..."pricePerItem"===t.id&&{width:100},..."orderNumber"===t.id&&{width:110},..."purchaseStatus"===t.id&&{width:110},..."orderDate"===t.id&&{width:110},..."asinSku"===t.id&&{width:120},..."productName"===t.id&&{minWidth:160},..."actions"===t.id&&{width:60,p:"6px 8px"},..."currentStatus"===t.id&&{width:100}},children:[t.label," "]})},B=e=>{let{user:t,org:i,permissions:n,logAction:a}=e;console.log("ToolApp Props Received:",{user:t,orgId:null===i||void 0===i?void 0:i.id,permissions:n,logActionExists:!!a}),console.log("ToolApp using imported db:",U.db),console.log("ToolApp using imported auth:",U.auth);const{items:d,allItems:c,loading:u,error:_,searchTerm:z,currentFilter:L,showFlaggedOnly:R,setSearchTerm:G,setCurrentFilter:M,setShowFlaggedOnly:B,setError:K}=(0,P.Q)(null===i||void 0===i?void 0:i.id);console.log("[IncomingTool] useStockItems returned:",{loading:u,error:_,items_length:null===d||void 0===d?void 0:d.length,allItems_length:null===c||void 0===c?void 0:c.length,currentFilter:L,showFlaggedOnly:R,searchTerm:z});const[J,Y]=(0,o.useState)(null),[X,Z]=(0,o.useState)(!1),[ee,te]=(0,o.useState)(null),[ie,oe]=(0,o.useState)(null),[se,re]=(0,o.useState)(null),[ne,le]=(0,o.useState)(null),[ae,de]=(0,o.useState)(!1),[ce,ue]=(0,o.useState)(null),[me,ge]=(0,o.useState)(!1),[pe,he]=(0,o.useState)((()=>{try{const e=localStorage.getItem(V),t=e?JSON.parse(e):H;return Array.isArray(t)?t:H}catch(_){return console.error("Error reading visible columns from localStorage",_),H}})),[Ae,ve]=(0,o.useState)(null),[Se,fe]=(0,o.useState)(null);(0,o.useEffect)((()=>{localStorage.setItem(V,JSON.stringify(pe))}),[pe]);const xe=pe.map((e=>W.find((t=>t.id===e)))).filter((e=>void 0!==e)),be=(0,o.useCallback)((async(e,t,o,s)=>{if(console.log("[IncomingTool] updateItemAndLog: Checking db and org.id:",{db_instance:U.db,org_id:null===i||void 0===i?void 0:i.id}),!U.db||null===i||void 0===i||!i.id||!t)return console.error("Cannot update item: Missing configuration.",{db:!!U.db,orgId:null===i||void 0===i?void 0:i.id,userId:t}),void K("Cannot update item: Missing configuration.");console.log(`[IncomingTool] updateItemAndLog: Preparing to update item ${e} in org ${i.id}`);const r=(0,l.doc)(U.db,"orgs",i.id,"stockItems",e),n=c.find((t=>t.id===e));if(!n)return console.error(`Item ${e} not found for update`),void K(`Item ${e} not found.`);const d=(u={...o,lastUpdated:(0,l.serverTimestamp)()},Object.fromEntries(Object.entries(u).filter((e=>{let[t,i]=e;return void 0!==i}))));var u;const m={...n,...d};try{if(await(0,l.updateDoc)(r,d),console.log(`Item ${e} updated successfully.`),console.log("updateItemAndLog: Attempting to log action. logAction available?",!!a),a){let t;try{if("EDITED"===s.type)t="item.update.fields";else if("FLAG_TOGGLED"===s.type)t="item.update.flag";else if("STATUS_CHANGED"===s.type){var g,p;t=`item.update.status.${(null===(g=s.details)||void 0===g||null===(p=g.newStatus)||void 0===p?void 0:p.toLowerCase())||"unknown"}`}else t="ISSUE_REPORTED"===s.type?"item.update.issue.report":"ISSUE_RESOLVED"===s.type?"item.update.issue.resolve":"ISSUE_UPDATE_ADDED"===s.type?"item.update.issue.update":"NOTE_ADDED"===s.type?"item.add_note":s.type}catch(h){console.error("Error deriving action name for logging:",h),t=s.type}const o={orgId:i.id,toolKey:"incomingtool",action:t,entityPath:`stockItems/${e}`,...void 0!==n&&{before:n},...void 0!==m&&{after:m},...void 0!==s.details&&{details:s.details}};await a(o)}}catch(A){throw console.error(`Error updating item ${e}:`,A),K(`Failed to update item: ${A.message}`),A}}),[i,c,a,K]),ye=((0,o.useCallback)((async(e,i)=>{console.log(`Action: ${i.label} on item ${e}`);const o=c.find((t=>t.id===e));if(o)switch(i.id){case"Edit Item":te(o),Z(!0);break;case"Flag Item":case"Unflag Item":const s="Flag Item"===i.id;await be(e,null===t||void 0===t?void 0:t.uid,{isFlagged:s},q((null===t||void 0===t?void 0:t.uid)||"","FLAG_TOGGLED",{isFlagged:s}));break;case"Mark as Delivered":"Delivered"!==o.currentStatus&&await be(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Delivered",dateDelivered:(new Date).toISOString()},q((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:o.currentStatus,newStatus:"Delivered"}));break;case"Archive":"Archived"!==o.currentStatus&&await be(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Archived"},q((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:o.currentStatus,newStatus:"Archived"}));break;case"Add Note":ue(o);break;case"Report Issue":Y(null),oe(o);break;case"Resolve Issue":Y(null),le(o);break;case"Add Issue Update":Y(null),re(o);break;case"View Details":Y(o)}}),[null===t||void 0===t?void 0:t.uid,c,be,te,Z,oe,re,le,Y]),(0,o.useCallback)((e=>{const t=c.find((t=>t.id===e));return t?(console.log("Viewing details for:",t),i?void Y(t):(console.error("Org ID is missing, cannot fetch logs."),void K("Organization context is missing."))):(console.error("Item not found for viewing details:",e),void K("Item not found."))}),[i,c,K])),Ie=(e,t)=>{fe(e.currentTarget),ve(t.id)},De=((0,s.FR)(),(0,g.A)()),we=(0,p.A)(De.breakpoints.down("sm")),je=e=>{var t;let{item:i,onViewDetails:o,onActionClick:s}=e;return(0,$.jsx)(h.A,{sx:{mb:2,cursor:"pointer"},onClick:()=>o(i.id),children:(0,$.jsx)(A.A,{sx:{pb:"8px !important"},children:(0,$.jsxs)(v.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[(0,$.jsxs)(v.A,{sx:{flexGrow:1,mr:1},children:[(0,$.jsx)(S.A,{variant:"subtitle1",component:"div",sx:{fontWeight:"bold",lineHeight:1.3},children:i.productName||i.deliveryName||"Unnamed Item"}),(0,$.jsxs)(S.A,{variant:"body2",color:"text.secondary",children:["Status: ",i.currentStatus]}),(0,$.jsxs)(S.A,{variant:"body2",color:"text.secondary",children:["Qty: ",null!==(t=i.quantity)&&void 0!==t?t:"N/A"," | Seller: ",i.seller||"N/A"]}),(0,$.jsxs)(S.A,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.8rem"},children:["Order Date: ",i.orderDate?new Date(i.orderDate).toLocaleDateString():"N/A"]})]}),(0,$.jsx)(f.A,{size:"small",onClick:e=>{e.stopPropagation(),s(e,i)},sx:{mt:-1,mr:-1},children:(0,$.jsx)(T.A,{})})]})})})};return(0,$.jsxs)(v.A,{sx:{},children:[_&&(0,$.jsx)(x.A,{severity:"error",onClose:()=>K(null),sx:{},children:_}),u&&(0,$.jsx)(b.A,{sx:{}}),(0,$.jsxs)(v.A,{sx:{},children:[(0,$.jsx)(y.A,{value:z,onChange:e=>G(e.target.value)}),(0,$.jsx)(I.A,{control:(0,$.jsx)(D.A,{checked:R,onChange:e=>B(e.target.checked),size:"small"}),label:(0,$.jsx)(S.A,{variant:"body2",children:"Show Flagged Only"}),sx:{mr:0}})]}),(0,$.jsx)(v.A,{sx:{},children:(0,$.jsx)(w.A,{value:L,onChange:(e,t)=>M(t)})}),(0,$.jsxs)(s.Mp,{children:[!we&&(0,$.jsx)(j.A,{component:k.A,sx:{mt:2,maxHeight:"calc(100vh - 250px)",overflowY:"auto"},children:(0,$.jsxs)(N.A,{stickyHeader:!0,size:"small",children:[(0,$.jsx)(C.A,{children:(0,$.jsx)(E.A,{children:(0,$.jsx)(r.gB,{items:pe,strategy:r.m$,children:xe.map((e=>(0,$.jsx)(Q,{column:e},e.id)))})})}),(0,$.jsxs)(F.A,{children:[d.map(((e,t)=>(0,$.jsx)(E.A,{hover:!0,sx:{"& > *":{borderBottom:"unset"},cursor:"pointer"},onClick:()=>ye(e.id),children:xe.map((t=>{var i;return(0,$.jsx)(m.A,{align:["quantity","pricePerItem"].includes(t.id)?"right":"left",sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:["productName","deliveryName","seller"].includes(t.id)?200:void 0,..."isFlagged"===t.id&&{p:"6px 8px",textAlign:"center"},..."actions"===t.id&&{p:"0px 8px",textAlign:"center"}},children:"actions"===t.id?(0,$.jsx)(f.A,{size:"small",onClick:t=>{t.stopPropagation(),Ie(t,e)},children:(0,$.jsx)(T.A,{fontSize:"small"})}):"isFlagged"===t.id?e.isFlagged?(0,$.jsx)(O.A,{fontSize:"inherit",color:"error"}):null:"orderDate"===t.id||"dateDelivered"===t.id?e[t.id]?new Date(e[t.id]).toLocaleDateString():"":null!==(i=e[t.id])&&void 0!==i?i:""},t.id)}))},e.id))),0===d.length&&!u&&(0,$.jsx)(E.A,{children:(0,$.jsx)(m.A,{colSpan:xe.length,align:"center",children:"No items match the current filter."})})]})]})}),we&&(0,$.jsxs)(v.A,{sx:{p:1},children:[" ",d.map((e=>(0,$.jsx)(je,{item:e,onViewDetails:ye,onActionClick:Ie},e.id))),0===d.length&&(0,$.jsx)(S.A,{align:"center",sx:{mt:2,color:"text.secondary"},children:"No items match the current filter."})]})]}),(()=>{if(!Ae)return null;c.find((e=>e.id===Ae))})()]})}}}]);
//# sourceMappingURL=894.38710774.chunk.js.map