/*! For license information please see 857.62eb44a1.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkincoming_tool=self.webpackChunkincoming_tool||[]).push([[857],{4857:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>lf,AggregateField:()=>ed,AggregateQuerySnapshot:()=>nd,Bytes:()=>rd,CACHE_SIZE_UNLIMITED:()=>Uh,CollectionReference:()=>Dh,DocumentReference:()=>Ah,DocumentSnapshot:()=>vf,FieldPath:()=>sd,FieldValue:()=>od,Firestore:()=>qh,FirestoreError:()=>F,GeoPoint:()=>ad,LoadBundleTask:()=>Vh,PersistentCacheIndexManager:()=>gg,Query:()=>Ch,QueryCompositeFilterConstraint:()=>Kd,QueryConstraint:()=>qd,QueryDocumentSnapshot:()=>bf,QueryEndAtConstraint:()=>ef,QueryFieldFilterConstraint:()=>zd,QueryLimitConstraint:()=>Wd,QueryOrderByConstraint:()=>Qd,QuerySnapshot:()=>If,QueryStartAtConstraint:()=>Jd,SnapshotMetadata:()=>wf,Timestamp:()=>it,Transaction:()=>rg,VectorValue:()=>ud,WriteBatch:()=>tg,_AutoId:()=>Y,_ByteString:()=>vn,_DatabaseId:()=>Mn,_DocumentKey:()=>dt,_EmptyAppCheckTokenProvider:()=>Q,_EmptyAuthCredentialsProvider:()=>q,_FieldPath:()=>ht,_TestingHooks:()=>_g,_cast:()=>bh,_debugAssert:()=>P,_internalAggregationQueryToProtoRunAggregationQueryRequest:()=>Tg,_internalQueryToProtoQueryTarget:()=>Ig,_isBase64Available:()=>wn,_logWarn:()=>k,_validateIsNotUsedTogether:()=>ph,addDoc:()=>Pf,aggregateFieldEqual:()=>pf,aggregateQuerySnapshotEqual:()=>yf,and:()=>$d,arrayRemove:()=>ug,arrayUnion:()=>ag,average:()=>gf,clearIndexedDbPersistence:()=>Hh,collection:()=>kh,collectionGroup:()=>Nh,connectFirestoreEmulator:()=>xh,count:()=>mf,deleteAllPersistentCacheIndexes:()=>wg,deleteDoc:()=>Mf,deleteField:()=>ig,disableNetwork:()=>Xh,disablePersistentCacheIndexAutoCreation:()=>yg,doc:()=>Rh,documentId:()=>id,enableIndexedDbPersistence:()=>Gh,enableMultiTabIndexedDbPersistence:()=>$h,enableNetwork:()=>Yh,enablePersistentCacheIndexAutoCreation:()=>pg,endAt:()=>rf,endBefore:()=>nf,ensureFirestoreConfigured:()=>jh,executeWrite:()=>Ff,getAggregateFromServer:()=>qf,getCountFromServer:()=>Uf,getDoc:()=>Ef,getDocFromCache:()=>xf,getDocFromServer:()=>Cf,getDocs:()=>Af,getDocsFromCache:()=>Df,getDocsFromServer:()=>kf,getFirestore:()=>zh,getPersistentCacheIndexManager:()=>mg,increment:()=>cg,initializeFirestore:()=>Bh,limit:()=>Yd,limitToLast:()=>Xd,loadBundle:()=>Zh,memoryEagerGarbageCollector:()=>Gf,memoryLocalCache:()=>Qf,memoryLruGarbageCollector:()=>$f,namedQuery:()=>td,onSnapshot:()=>Of,onSnapshotsInSync:()=>Lf,or:()=>Gd,orderBy:()=>Hd,persistentLocalCache:()=>Hf,persistentMultipleTabManager:()=>Jf,persistentSingleTabManager:()=>Xf,query:()=>Bd,queryEqual:()=>Ph,refEqual:()=>Mh,runTransaction:()=>sg,serverTimestamp:()=>og,setDoc:()=>Nf,setIndexConfiguration:()=>dg,setLogLevel:()=>C,snapshotEqual:()=>_f,startAfter:()=>tf,startAt:()=>Zd,sum:()=>ff,terminate:()=>Jh,updateDoc:()=>Rf,vector:()=>lg,waitForPendingWrites:()=>Wh,where:()=>jd,writeBatch:()=>hg});var r,s,i=n(8930),o=n(1259),a=n(9766),u=n(4358),c="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{},l={};(function(){var t;function e(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function n(t,e,n){n||(n=0);var r=Array(16);if("string"===typeof e)for(var s=0;16>s;++s)r[s]=e.charCodeAt(n++)|e.charCodeAt(n++)<<8|e.charCodeAt(n++)<<16|e.charCodeAt(n++)<<24;else for(s=0;16>s;++s)r[s]=e[n++]|e[n++]<<8|e[n++]<<16|e[n++]<<24;e=t.g[0],n=t.g[1],s=t.g[2];var i=t.g[3],o=e+(i^n&(s^i))+r[0]+3614090360&4294967295;o=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=n+(o<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^i&(n^s))+r[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=e+(n^s^i)+r[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=e+(s^(n|~i))+r[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((i=(e=n+((o=e+(s^(n|~i))+r[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((s=i+((o=s+(e^(i|~n))+r[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~e))+r[9]+3951481745&4294967295,t.g[0]=t.g[0]+e&4294967295,t.g[1]=t.g[1]+(s+(o<<21&4294967295|o>>>11))&4294967295,t.g[2]=t.g[2]+s&4294967295,t.g[3]=t.g[3]+i&4294967295}function i(t,e){this.h=e;for(var n=[],r=!0,s=t.length-1;0<=s;s--){var i=0|t[s];r&&i==e||(n[s]=i,r=!1)}this.g=n}!function(t,e){function n(){}n.prototype=e.prototype,t.D=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.C=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}(e,(function(){this.blockSize=-1})),e.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},e.prototype.u=function(t,e){void 0===e&&(e=t.length);for(var r=e-this.blockSize,s=this.B,i=this.h,o=0;o<e;){if(0==i)for(;o<=r;)n(this,t,o),o+=this.blockSize;if("string"===typeof t){for(;o<e;)if(s[i++]=t.charCodeAt(o++),i==this.blockSize){n(this,s),i=0;break}}else for(;o<e;)if(s[i++]=t[o++],i==this.blockSize){n(this,s),i=0;break}}this.h=i,this.o+=e},e.prototype.v=function(){var t=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);t[0]=128;for(var e=1;e<t.length-8;++e)t[e]=0;var n=8*this.o;for(e=t.length-8;e<t.length;++e)t[e]=255&n,n/=256;for(this.u(t),t=Array(16),e=n=0;4>e;++e)for(var r=0;32>r;r+=8)t[n++]=this.g[e]>>>r&255;return t};var o={};function a(t){return-128<=t&&128>t?function(t,e){var n=o;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(t,(function(t){return new i([0|t],0>t?-1:0)})):new i([0|t],0>t?-1:0)}function u(t){if(isNaN(t)||!isFinite(t))return c;if(0>t)return m(u(-t));for(var e=[],n=1,r=0;t>=n;r++)e[r]=t/n|0,n*=4294967296;return new i(e,0)}var c=a(0),h=a(1),d=a(16777216);function f(t){if(0!=t.h)return!1;for(var e=0;e<t.g.length;e++)if(0!=t.g[e])return!1;return!0}function g(t){return-1==t.h}function m(t){for(var e=t.g.length,n=[],r=0;r<e;r++)n[r]=~t.g[r];return new i(n,~t.h).add(h)}function p(t,e){return t.add(m(e))}function y(t,e){for(;(65535&t[e])!=t[e];)t[e+1]+=t[e]>>>16,t[e]&=65535,e++}function w(t,e){this.g=t,this.h=e}function v(t,e){if(f(e))throw Error("division by zero");if(f(t))return new w(c,c);if(g(t))return e=v(m(t),e),new w(m(e.g),m(e.h));if(g(e))return e=v(t,m(e)),new w(m(e.g),e.h);if(30<t.g.length){if(g(t)||g(e))throw Error("slowDivide_ only works with positive integers.");for(var n=h,r=e;0>=r.l(t);)n=b(n),r=b(r);var s=I(n,1),i=I(r,1);for(r=I(r,2),n=I(n,2);!f(r);){var o=i.add(r);0>=o.l(t)&&(s=s.add(n),i=o),r=I(r,1),n=I(n,1)}return e=p(t,s.j(e)),new w(s,e)}for(s=c;0<=t.l(e);){for(n=Math.max(1,Math.floor(t.m()/e.m())),r=48>=(r=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,r-48),o=(i=u(n)).j(e);g(o)||0<o.l(t);)o=(i=u(n-=r)).j(e);f(i)&&(i=h),s=s.add(i),t=p(t,o)}return new w(s,t)}function b(t){for(var e=t.g.length+1,n=[],r=0;r<e;r++)n[r]=t.i(r)<<1|t.i(r-1)>>>31;return new i(n,t.h)}function I(t,e){var n=e>>5;e%=32;for(var r=t.g.length-n,s=[],o=0;o<r;o++)s[o]=0<e?t.i(o+n)>>>e|t.i(o+n+1)<<32-e:t.i(o+n);return new i(s,t.h)}(t=i.prototype).m=function(){if(g(this))return-m(this).m();for(var t=0,e=1,n=0;n<this.g.length;n++){var r=this.i(n);t+=(0<=r?r:4294967296+r)*e,e*=4294967296}return t},t.toString=function(t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);if(f(this))return"0";if(g(this))return"-"+m(this).toString(t);for(var e=u(Math.pow(t,6)),n=this,r="";;){var s=v(n,e).g,i=((0<(n=p(n,s.j(e))).g.length?n.g[0]:n.h)>>>0).toString(t);if(f(n=s))return i+r;for(;6>i.length;)i="0"+i;r=i+r}},t.i=function(t){return 0>t?0:t<this.g.length?this.g[t]:this.h},t.l=function(t){return g(t=p(this,t))?-1:f(t)?0:1},t.abs=function(){return g(this)?m(this):this},t.add=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0,s=0;s<=e;s++){var o=r+(65535&this.i(s))+(65535&t.i(s)),a=(o>>>16)+(this.i(s)>>>16)+(t.i(s)>>>16);r=a>>>16,o&=65535,a&=65535,n[s]=a<<16|o}return new i(n,-2147483648&n[n.length-1]?-1:0)},t.j=function(t){if(f(this)||f(t))return c;if(g(this))return g(t)?m(this).j(m(t)):m(m(this).j(t));if(g(t))return m(this.j(m(t)));if(0>this.l(d)&&0>t.l(d))return u(this.m()*t.m());for(var e=this.g.length+t.g.length,n=[],r=0;r<2*e;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var s=0;s<t.g.length;s++){var o=this.i(r)>>>16,a=65535&this.i(r),l=t.i(s)>>>16,h=65535&t.i(s);n[2*r+2*s]+=a*h,y(n,2*r+2*s),n[2*r+2*s+1]+=o*h,y(n,2*r+2*s+1),n[2*r+2*s+1]+=a*l,y(n,2*r+2*s+1),n[2*r+2*s+2]+=o*l,y(n,2*r+2*s+2)}for(r=0;r<e;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=e;r<2*e;r++)n[r]=0;return new i(n,0)},t.A=function(t){return v(this,t).h},t.and=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.i(r)&t.i(r);return new i(n,this.h&t.h)},t.or=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.i(r)|t.i(r);return new i(n,this.h|t.h)},t.xor=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.i(r)^t.i(r);return new i(n,this.h^t.h)},e.prototype.digest=e.prototype.v,e.prototype.reset=e.prototype.s,e.prototype.update=e.prototype.u,s=l.Md5=e,i.prototype.add=i.prototype.add,i.prototype.multiply=i.prototype.j,i.prototype.modulo=i.prototype.A,i.prototype.compare=i.prototype.l,i.prototype.toNumber=i.prototype.m,i.prototype.toString=i.prototype.toString,i.prototype.getBits=i.prototype.i,i.fromNumber=u,i.fromString=function t(e,n){if(0==e.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==e.charAt(0))return m(t(e.substring(1),n));if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=u(Math.pow(n,8)),s=c,i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),a=parseInt(e.substring(i,i+o),n);8>o?(o=u(Math.pow(n,o)),s=s.j(o).add(u(a))):s=(s=s.j(r)).add(u(a))}return s},r=l.Integer=i}).apply("undefined"!==typeof c?c:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{});var h,d,f,g,m,p,y,w,v="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{},b={};(function(){var t,e="function"==typeof Object.defineProperties?Object.defineProperty:function(t,e,n){return t==Array.prototype||t==Object.prototype||(t[e]=n.value),t};var n=function(t){t=["object"==typeof globalThis&&globalThis,t,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof v&&v];for(var e=0;e<t.length;++e){var n=t[e];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);!function(t,r){if(r)t:{var s=n;t=t.split(".");for(var i=0;i<t.length-1;i++){var o=t[i];if(!(o in s))break t;s=s[o]}(r=r(i=s[t=t[t.length-1]]))!=i&&null!=r&&e(s,t,{configurable:!0,writable:!0,value:r})}}("Array.prototype.values",(function(t){return t||function(){return function(t,e){t instanceof String&&(t+="");var n=0,r=!1,s={next:function(){if(!r&&n<t.length){var s=n++;return{value:e(s,t[s]),done:!1}}return r=!0,{done:!0,value:void 0}}};return s[Symbol.iterator]=function(){return s},s}(this,(function(t,e){return e}))}}));var r=r||{},s=this||self;function i(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function o(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}function a(t,e,n){return t.call.apply(t.bind,arguments)}function u(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function c(t,e,n){return(c=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?a:u).apply(null,arguments)}function l(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function I(t,e){function n(){}n.prototype=e.prototype,t.aa=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Qb=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}function _(t){const e=t.length;if(0<e){const n=Array(e);for(let r=0;r<e;r++)n[r]=t[r];return n}return[]}function E(t,e){for(let n=1;n<arguments.length;n++){const e=arguments[n];if(i(e)){const n=t.length||0,r=e.length||0;t.length=n+r;for(let s=0;s<r;s++)t[n+s]=e[s]}else t.push(e)}}function S(t){return/^[\s\xa0]*$/.test(t)}function x(){var t=s.navigator;return t&&(t=t.userAgent)?t:""}function C(t){return C[" "](t),t}C[" "]=function(){};var A=-1!=x().indexOf("Gecko")&&!(-1!=x().toLowerCase().indexOf("webkit")&&-1==x().indexOf("Edge"))&&!(-1!=x().indexOf("Trident")||-1!=x().indexOf("MSIE"))&&-1==x().indexOf("Edge");function D(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function k(t){const e={};for(const n in t)e[n]=t[n];return e}const N="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function R(t,e){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s],r)t[n]=r[n];for(let e=0;e<N.length;e++)n=N[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function M(t){var e=1;t=t.split(":");const n=[];for(;0<e&&t.length;)n.push(t.shift()),e--;return t.length&&n.push(t.join(":")),n}function P(t){s.setTimeout((()=>{throw t}),0)}function O(){var t=q;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var L=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new F),(t=>t.reset()));class F{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}let V,U=!1,q=new class{constructor(){this.h=this.g=null}add(t,e){const n=L.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}},B=()=>{const t=s.Promise.resolve(void 0);V=()=>{t.then(z)}};var z=()=>{for(var t;t=O();){try{t.h.call(t.g)}catch(n){P(n)}var e=L;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}U=!1};function j(){this.s=this.s,this.C=this.C}function K(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}j.prototype.s=!1,j.prototype.ma=function(){this.s||(this.s=!0,this.N())},j.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},K.prototype.h=function(){this.defaultPrevented=!0};var G=function(){if(!s.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{const t=()=>{};s.addEventListener("test",t,e),s.removeEventListener("test",t,e)}catch(n){}return t}();function $(t,e){if(K.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(A){t:{try{C(e.nodeName);var s=!0;break t}catch(i){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"===typeof t.pointerType?t.pointerType:Q[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&$.aa.h.call(this)}}I($,K);var Q={2:"touch",3:"pen",4:"mouse"};$.prototype.h=function(){$.aa.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var H="closure_listenable_"+(1e6*Math.random()|0),W=0;function Y(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ha=s,this.key=++W,this.da=this.fa=!1}function X(t){t.da=!0,t.listener=null,t.proxy=null,t.src=null,t.ha=null}function J(t){this.src=t,this.g={},this.h=0}function Z(t,e){var n=e.type;if(n in t.g){var r,s=t.g[n],i=Array.prototype.indexOf.call(s,e,void 0);(r=0<=i)&&Array.prototype.splice.call(s,i,1),r&&(X(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function tt(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.da&&i.listener==e&&i.capture==!!n&&i.ha==r)return s}return-1}J.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=tt(t,e,r,s);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new Y(e,this.src,i,!!r,s)).fa=n,t.push(e)),e};var et="closure_lm_"+(1e6*Math.random()|0),nt={};function rt(t,e,n,r,s){if(r&&r.once)return it(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)rt(t,e[i],n,r,s);return null}return n=dt(n),t&&t[H]?t.K(e,n,o(r)?!!r.capture:!!r,s):st(t,e,n,!1,r,s)}function st(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var a=o(s)?!!s.capture:!!s,u=lt(t);if(u||(t[et]=u=new J(t)),(n=u.add(e,n,r,a,i)).proxy)return n;if(r=function(){function t(n){return e.call(t.src,t.listener,n)}const e=ct;return t}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)G||(s=a),void 0===s&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(ut(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function it(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)it(t,e[i],n,r,s);return null}return n=dt(n),t&&t[H]?t.L(e,n,o(r)?!!r.capture:!!r,s):st(t,e,n,!0,r,s)}function ot(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)ot(t,e[i],n,r,s);else r=o(r)?!!r.capture:!!r,n=dt(n),t&&t[H]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=tt(i=t.g[e],n,r,s))&&(X(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):t&&(t=lt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=tt(e,n,r,s)),(n=-1<t?e[t]:null)&&at(n))}function at(t){if("number"!==typeof t&&t&&!t.da){var e=t.src;if(e&&e[H])Z(e.i,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(ut(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=lt(e))?(Z(n,t),0==n.h&&(n.src=null,e[et]=null)):X(t)}}}function ut(t){return t in nt?nt[t]:nt[t]="on"+t}function ct(t,e){if(t.da)t=!0;else{e=new $(e,this);var n=t.listener,r=t.ha||t.src;t.fa&&at(t),t=n.call(r,e)}return t}function lt(t){return(t=t[et])instanceof J?t:null}var ht="__closure_events_fn_"+(1e9*Math.random()>>>0);function dt(t){return"function"===typeof t?t:(t[ht]||(t[ht]=function(e){return t.handleEvent(e)}),t[ht])}function ft(){j.call(this),this.i=new J(this),this.M=this,this.F=null}function gt(t,e){var n,r=t.F;if(r)for(n=[];r;r=r.F)n.push(r);if(t=t.M,r=e.type||e,"string"===typeof e)e=new K(e,t);else if(e instanceof K)e.target=e.target||t;else{var s=e;R(e=new K(r,t),s)}if(s=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];s=mt(o,r,!0,e)&&s}if(s=mt(o=e.g=t,r,!0,e)&&s,s=mt(o,r,!1,e)&&s,n)for(i=0;i<n.length;i++)s=mt(o=e.g=n[i],r,!1,e)&&s}function mt(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.da&&o.capture==n){var a=o.listener,u=o.ha||o.src;o.fa&&Z(t.i,o),s=!1!==a.call(u,r)&&s}}return s&&!r.defaultPrevented}function pt(t,e,n){if("function"===typeof t)n&&(t=c(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=c(t.handleEvent,t)}return 2147483647<Number(e)?-1:s.setTimeout(t,e||0)}function yt(t){t.g=pt((()=>{t.g=null,t.i&&(t.i=!1,yt(t))}),t.l);const e=t.h;t.h=null,t.m.apply(null,e)}I(ft,j),ft.prototype[H]=!0,ft.prototype.removeEventListener=function(t,e,n,r){ot(this,t,e,n,r)},ft.prototype.N=function(){if(ft.aa.N.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)X(n[r]);delete e.g[t],e.h--}}this.F=null},ft.prototype.K=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},ft.prototype.L=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};class wt extends j{constructor(t,e){super(),this.m=t,this.l=e,this.h=null,this.i=!1,this.g=null}j(t){this.h=arguments,this.g?this.i=!0:yt(this)}N(){super.N(),this.g&&(s.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function vt(t){j.call(this),this.h=t,this.g={}}I(vt,j);var bt=[];function It(t){D(t.g,(function(t,e){this.g.hasOwnProperty(e)&&at(t)}),t),t.g={}}vt.prototype.N=function(){vt.aa.N.call(this),It(this)},vt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Tt=s.JSON.stringify,_t=s.JSON.parse,Et=class{stringify(t){return s.JSON.stringify(t,void 0)}parse(t){return s.JSON.parse(t,void 0)}};function St(){}function xt(t){return t.h||(t.h=t.i())}function Ct(){}St.prototype.h=null;var At={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Dt(){K.call(this,"d")}function kt(){K.call(this,"c")}I(Dt,K),I(kt,K);var Nt={},Rt=null;function Mt(){return Rt=Rt||new ft}function Pt(t){K.call(this,Nt.La,t)}function Ot(t){const e=Mt();gt(e,new Pt(e))}function Lt(t,e){K.call(this,Nt.STAT_EVENT,t),this.stat=e}function Ft(t){const e=Mt();gt(e,new Lt(e,t))}function Vt(t,e){K.call(this,Nt.Ma,t),this.size=e}function Ut(t,e){if("function"!==typeof t)throw Error("Fn must not be null and must be a function");return s.setTimeout((function(){t()}),e)}function qt(){this.g=!0}function Bt(t,e,n,r){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(2>r.length)){var s=r[1];if(Array.isArray(s)&&!(1>s.length)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return Tt(n)}catch(a){return e}}(t,n)+(r?" "+r:"")}))}Nt.La="serverreachability",I(Pt,K),Nt.STAT_EVENT="statevent",I(Lt,K),Nt.Ma="timingevent",I(Vt,K),qt.prototype.xa=function(){this.g=!1},qt.prototype.info=function(){};var zt,jt={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Kt={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function Gt(){}function $t(t,e,n,r){this.j=t,this.i=e,this.l=n,this.R=r||1,this.U=new vt(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Qt}function Qt(){this.i=null,this.g="",this.h=!1}I(Gt,St),Gt.prototype.g=function(){return new XMLHttpRequest},Gt.prototype.i=function(){return{}},zt=new Gt;var Ht={},Wt={};function Yt(t,e,n){t.L=1,t.v=Te(ye(e)),t.m=n,t.P=!0,Xt(t,null)}function Xt(t,e){t.F=Date.now(),te(t),t.A=ye(t.v);var n=t.A,r=t.R;Array.isArray(r)||(r=[String(r)]),Le(n.i,"t",r),t.C=0,n=t.j.J,t.h=new Qt,t.g=En(t.j,n?e:null,!t.m),0<t.O&&(t.M=new wt(c(t.Y,t,t.g),t.O)),e=t.U,n=t.g,r=t.ca;var s="readystatechange";Array.isArray(s)||(s&&(bt[0]=s.toString()),s=bt);for(var i=0;i<s.length;i++){var o=rt(n,s[i],r||e.handleEvent,!1,e.h||e);if(!o)break;e.g[o.key]=o}e=t.H?k(t.H):{},t.m?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.m,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Ot(),function(t,e,n,r,s,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+c+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+r+") [attempt "+s+"]: "+e+"\n"+n+"\n"+o}))}(t.i,t.u,t.A,t.l,t.R,t.m)}function Jt(t){return!!t.g&&("GET"==t.u&&2!=t.L&&t.j.Ca)}function Zt(t,e){var n=t.C,r=e.indexOf("\n",n);return-1==r?Wt:(n=Number(e.substring(n,r)),isNaN(n)?Ht:(r+=1)+n>e.length?Wt:(e=e.slice(r,r+n),t.C=r+n,e))}function te(t){t.S=Date.now()+t.I,ee(t,t.I)}function ee(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=Ut(c(t.ba,t),e)}function ne(t){t.B&&(s.clearTimeout(t.B),t.B=null)}function re(t){0==t.j.G||t.J||vn(t.j,t)}function se(t){ne(t);var e=t.M;e&&"function"==typeof e.ma&&e.ma(),t.M=null,It(t.U),t.g&&(e=t.g,t.g=null,e.abort(),e.ma())}function ie(t,e){try{var n=t.j;if(0!=n.G&&(n.g==t||le(n.h,t)))if(!t.K&&le(n.h,t)&&3==n.G){try{var r=n.Da.g.parse(e)}catch(l){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;wn(n),un(n)}mn(n),Ft(18)}}else n.za=s[1],0<n.za-n.T&&37500>s[2]&&n.F&&0==n.v&&!n.C&&(n.C=Ut(c(n.Za,n),6e3));if(1>=ce(n.h)&&n.ca){try{n.ca()}catch(l){}n.ca=void 0}}else In(n,11)}else if((t.K||n.g==t)&&wn(n),!S(e))for(s=n.Da.g.parse(e),e=0;e<s.length;e++){let c=s[e];if(n.T=c[0],c=c[1],2==n.G)if("c"==c[0]){n.K=c[1],n.ia=c[2];const e=c[3];null!=e&&(n.la=e,n.j.info("VER="+n.la));const s=c[4];null!=s&&(n.Aa=s,n.j.info("SVER="+n.Aa));const l=c[5];null!=l&&"number"===typeof l&&0<l&&(r=1.5*l,n.L=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=r.h;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(he(i,i.h),i.h=null))}if(r.D){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(r.ya=t,Ie(r.I,r.D,t))}}n.G=3,n.l&&n.l.ua(),n.ba&&(n.R=Date.now()-t.F,n.j.info("Handshake RTT: "+n.R+"ms"));var o=t;if((r=n).qa=_n(r,r.J?r.ia:null,r.W),o.K){de(r.h,o);var a=o,u=r.L;u&&(a.I=u),a.B&&(ne(a),te(a)),r.g=o}else gn(r);0<n.i.length&&ln(n)}else"stop"!=c[0]&&"close"!=c[0]||In(n,7);else 3==n.G&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?In(n,7):an(n):"noop"!=c[0]&&n.l&&n.l.ta(c),n.v=0)}Ot()}catch(l){}}$t.prototype.ca=function(t){t=t.target;const e=this.M;e&&3==nn(t)?e.j():this.Y(t)},$t.prototype.Y=function(t){try{if(t==this.g)t:{const d=nn(this.g);var e=this.g.Ba();this.g.Z();if(!(3>d)&&(3!=d||this.g&&(this.h.h||this.g.oa()||rn(this.g)))){this.J||4!=d||7==e||Ot(),ne(this);var n=this.g.Z();this.X=n;e:if(Jt(this)){var r=rn(this.g);t="";var i=r.length,o=4==nn(this.g);if(!this.h.i){if("undefined"===typeof TextDecoder){se(this),re(this);var a="";break e}this.h.i=new s.TextDecoder}for(e=0;e<i;e++)this.h.h=!0,t+=this.h.i.decode(r[e],{stream:!(o&&e==i-1)});r.length=0,this.h.g+=t,this.C=0,a=this.h.g}else a=this.g.oa();if(this.o=200==n,function(t,e,n,r,s,i,o){t.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.i,this.u,this.A,this.l,this.R,d,n),this.o){if(this.T&&!this.K){e:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!S(u)){var l=u;break e}}l=null}if(!(n=l)){this.o=!1,this.s=3,Ft(12),se(this),re(this);break t}Bt(this.i,this.l,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,ie(this,n)}if(this.P){let t;for(n=!0;!this.J&&this.C<a.length;){if(t=Zt(this,a),t==Wt){4==d&&(this.s=4,Ft(14),n=!1),Bt(this.i,this.l,null,"[Incomplete Response]");break}if(t==Ht){this.s=4,Ft(15),Bt(this.i,this.l,a,"[Invalid Chunk]"),n=!1;break}Bt(this.i,this.l,t,null),ie(this,t)}if(Jt(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=d||0!=a.length||this.h.h||(this.s=1,Ft(16),n=!1),this.o=this.o&&n,n){if(0<a.length&&!this.W){this.W=!0;var h=this.j;h.g==this&&h.ba&&!h.M&&(h.j.info("Great, no buffering proxy detected. Bytes received: "+a.length),pn(h),h.M=!0,Ft(11))}}else Bt(this.i,this.l,a,"[Invalid Chunked Response]"),se(this),re(this)}else Bt(this.i,this.l,a,null),ie(this,a);4==d&&se(this),this.o&&!this.J&&(4==d?vn(this.j,this):(this.o=!1,te(this)))}else(function(t){const e={};t=(t.g&&2<=nn(t)&&t.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<t.length;r++){if(S(t[r]))continue;var n=M(t[r]);const s=n[0];if("string"!==typeof(n=n[1]))continue;n=n.trim();const i=e[s]||[];e[s]=i,i.push(n)}!function(t,e){for(const n in t)e.call(void 0,t[n],n,t)}(e,(function(t){return t.join(", ")}))})(this.g),400==n&&0<a.indexOf("Unknown SID")?(this.s=3,Ft(12)):(this.s=0,Ft(13)),se(this),re(this)}}}catch(d){}},$t.prototype.cancel=function(){this.J=!0,se(this)},$t.prototype.ba=function(){this.B=null;const t=Date.now();0<=t-this.S?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.i,this.A),2!=this.L&&(Ot(),Ft(17)),se(this),this.s=2,re(this)):ee(this,this.S-t)};var oe=class{constructor(t,e){this.g=t,this.map=e}};function ae(t){this.l=t||10,s.PerformanceNavigationTiming?t=0<(t=s.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(s.chrome&&s.chrome.loadTimes&&s.chrome.loadTimes()&&s.chrome.loadTimes().wasFetchedViaSpdy),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function ue(t){return!!t.h||!!t.g&&t.g.size>=t.j}function ce(t){return t.h?1:t.g?t.g.size:0}function le(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function he(t,e){t.g?t.g.add(e):t.h=e}function de(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function fe(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return _(t.i)}function ge(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(i(t)||"string"===typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.na&&"function"==typeof t.na)return t.na();if(!t.V||"function"!=typeof t.V){if("undefined"!==typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!==typeof Set&&t instanceof Set)){if(i(t)||"string"===typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const r in t)e[n++]=r;return e}}}(t),r=function(t){if(t.V&&"function"==typeof t.V)return t.V();if("undefined"!==typeof Map&&t instanceof Map||"undefined"!==typeof Set&&t instanceof Set)return Array.from(t.values());if("string"===typeof t)return t.split("");if(i(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t),s=r.length,o=0;o<s;o++)e.call(void 0,r[o],n&&n[o],t)}ae.prototype.cancel=function(){if(this.i=fe(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}};var me=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function pe(t){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,t instanceof pe){this.h=t.h,we(this,t.j),this.o=t.o,this.g=t.g,ve(this,t.s),this.l=t.l;var e=t.i,n=new Re;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),be(this,n),this.m=t.m}else t&&(e=String(t).match(me))?(this.h=!1,we(this,e[1]||"",!0),this.o=_e(e[2]||""),this.g=_e(e[3]||"",!0),ve(this,e[4]),this.l=_e(e[5]||"",!0),be(this,e[6]||"",!0),this.m=_e(e[7]||"")):(this.h=!1,this.i=new Re(null,this.h))}function ye(t){return new pe(t)}function we(t,e,n){t.j=n?_e(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function ve(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.s=e}else t.s=null}function be(t,e,n){e instanceof Re?(t.i=e,function(t,e){e&&!t.j&&(Me(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Pe(this,e),Le(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=Ee(e,ke)),t.i=new Re(e,t.h))}function Ie(t,e,n){t.i.set(e,n)}function Te(t){return Ie(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function _e(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Ee(t,e,n){return"string"===typeof t?(t=encodeURI(t).replace(e,Se),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Se(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}pe.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Ee(e,Ce,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.o)&&t.push(Ee(e,Ce,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.s)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(Ee(n,"/"==n.charAt(0)?De:Ae,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.m)&&t.push("#",Ee(n,Ne)),t.join("")};var xe,Ce=/[#\/\?@]/g,Ae=/[#\?:]/g,De=/[#\?]/g,ke=/[#\?@]/g,Ne=/#/g;function Re(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Me(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),s=null;if(0<=r){var i=t[n].substring(0,r);s=t[n].substring(r+1)}else i=t[n];e(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Pe(t,e){Me(t),e=Fe(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function Oe(t,e){return Me(t),e=Fe(t,e),t.g.has(e)}function Le(t,e,n){Pe(t,e),0<n.length&&(t.i=null,t.g.set(Fe(t,e),_(n)),t.h+=n.length)}function Fe(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function Ve(t,e,n,r,s){try{s&&(s.onload=null,s.onerror=null,s.onabort=null,s.ontimeout=null),r(n)}catch(i){}}function Ue(){this.g=new Et}function qe(t,e,n){const r=n||"";try{ge(t,(function(t,n){let s=t;o(t)&&(s=Tt(t)),e.push(r+n+"="+encodeURIComponent(s))}))}catch(s){throw e.push(r+"type="+encodeURIComponent("_badmap")),s}}function Be(t){this.l=t.Ub||null,this.j=t.eb||!1}function ze(t,e){ft.call(this),this.D=t,this.o=e,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function je(t){t.j.read().then(t.Pa.bind(t)).catch(t.ga.bind(t))}function Ke(t){t.readyState=4,t.l=null,t.j=null,t.v=null,Ge(t)}function Ge(t){t.onreadystatechange&&t.onreadystatechange.call(t)}function $e(t){let e="";return D(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function Qe(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=$e(n),"string"===typeof t?null!=n&&encodeURIComponent(String(n)):Ie(t,e,n))}function He(t){ft.call(this),this.headers=new Map,this.o=t||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(t=Re.prototype).add=function(t,e){Me(this),this.i=null,t=Fe(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},t.forEach=function(t,e){Me(this),this.g.forEach((function(n,r){n.forEach((function(n){t.call(e,n,r,this)}),this)}),this)},t.na=function(){Me(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let r=0;r<e.length;r++){const s=t[r];for(let t=0;t<s.length;t++)n.push(e[r])}return n},t.V=function(t){Me(this);let e=[];if("string"===typeof t)Oe(this,t)&&(e=e.concat(this.g.get(Fe(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},t.set=function(t,e){return Me(this),this.i=null,Oe(this,t=Fe(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},t.get=function(t,e){return t&&0<(t=this.V(t)).length?String(t[0]):e},t.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var r=e[n];const i=encodeURIComponent(String(r)),o=this.V(r);for(r=0;r<o.length;r++){var s=i;""!==o[r]&&(s+="="+encodeURIComponent(String(o[r]))),t.push(s)}}return this.i=t.join("&")},I(Be,St),Be.prototype.g=function(){return new ze(this.l,this.j)},Be.prototype.i=(xe={},function(){return xe}),I(ze,ft),(t=ze.prototype).open=function(t,e){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=t,this.A=e,this.readyState=1,Ge(this)},t.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.u,method:this.B,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||s).fetch(new Request(this.A,e)).then(this.Sa.bind(this),this.ga.bind(this))},t.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Ke(this)),this.readyState=0},t.Sa=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,Ge(this)),this.g&&(this.readyState=3,Ge(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if("undefined"!==typeof s.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;je(this)}else t.text().then(this.Ra.bind(this),this.ga.bind(this))},t.Pa=function(t){if(this.g){if(this.o&&t.value)this.response.push(t.value);else if(!this.o){var e=t.value?t.value:new Uint8Array(0);(e=this.v.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Ke(this):Ge(this),3==this.readyState&&je(this)}},t.Ra=function(t){this.g&&(this.response=this.responseText=t,Ke(this))},t.Qa=function(t){this.g&&(this.response=t,Ke(this))},t.ga=function(){this.g&&Ke(this)},t.setRequestHeader=function(t,e){this.u.append(t,e)},t.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},t.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(ze.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}}),I(He,ft);var We=/^https?$/i,Ye=["POST","PUT"];function Xe(t,e){t.h=!1,t.g&&(t.j=!0,t.g.abort(),t.j=!1),t.l=e,t.m=5,Je(t),tn(t)}function Je(t){t.A||(t.A=!0,gt(t,"complete"),gt(t,"error"))}function Ze(t){if(t.h&&"undefined"!=typeof r&&(!t.v[1]||4!=nn(t)||2!=t.Z()))if(t.u&&4==nn(t))pt(t.Ea,0,t);else if(gt(t,"readystatechange"),4==nn(t)){t.h=!1;try{const r=t.Z();t:switch(r){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var i;if(i=0===r){var o=String(t.D).match(me)[1]||null;!o&&s.self&&s.self.location&&(o=s.self.location.protocol.slice(0,-1)),i=!We.test(o?o.toLowerCase():"")}n=i}if(n)gt(t,"complete"),gt(t,"success");else{t.m=6;try{var a=2<nn(t)?t.g.statusText:""}catch(u){a=""}t.l=a+" ["+t.Z()+"]",Je(t)}}finally{tn(t)}}}function tn(t,e){if(t.g){en(t);const r=t.g,s=t.v[0]?()=>{}:null;t.g=null,t.v=null,e||gt(t,"ready");try{r.onreadystatechange=s}catch(n){}}}function en(t){t.I&&(s.clearTimeout(t.I),t.I=null)}function nn(t){return t.g?t.g.readyState:0}function rn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.H){case"":case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(T){return null}}function sn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function on(t){this.Aa=0,this.i=[],this.j=new qt,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=sn("failFast",!1,t),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=sn("baseRetryDelayMs",5e3,t),this.cb=sn("retryDelaySeedMs",1e4,t),this.Wa=sn("forwardChannelMaxRetries",2,t),this.wa=sn("forwardChannelRequestTimeoutMs",2e4,t),this.pa=t&&t.xmlHttpFactory||void 0,this.Xa=t&&t.Tb||void 0,this.Ca=t&&t.useFetchStreams||!1,this.L=void 0,this.J=t&&t.supportsCrossDomainXhr||!1,this.K="",this.h=new ae(t&&t.concurrentRequestLimit),this.Da=new Ue,this.P=t&&t.fastHandshake||!1,this.O=t&&t.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=t&&t.Rb||!1,t&&t.xa&&this.j.xa(),t&&t.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&t&&t.detectBufferingProxy||!1,this.ja=void 0,t&&t.longPollingTimeout&&0<t.longPollingTimeout&&(this.ja=t.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function an(t){if(cn(t),3==t.G){var e=t.U++,n=ye(t.I);if(Ie(n,"SID",t.K),Ie(n,"RID",e),Ie(n,"TYPE","terminate"),dn(t,n),(e=new $t(t,t.j,e)).L=2,e.v=Te(ye(n)),n=!1,s.navigator&&s.navigator.sendBeacon)try{n=s.navigator.sendBeacon(e.v.toString(),"")}catch(r){}!n&&s.Image&&((new Image).src=e.v,n=!0),n||(e.g=En(e.j,null),e.g.ea(e.v)),e.F=Date.now(),te(e)}Tn(t)}function un(t){t.g&&(pn(t),t.g.cancel(),t.g=null)}function cn(t){un(t),t.u&&(s.clearTimeout(t.u),t.u=null),wn(t),t.h.cancel(),t.s&&("number"===typeof t.s&&s.clearTimeout(t.s),t.s=null)}function ln(t){if(!ue(t.h)&&!t.s){t.s=!0;var e=t.Ga;V||B(),U||(V(),U=!0),q.add(e,t),t.B=0}}function hn(t,e){var n;n=e?e.l:t.U++;const r=ye(t.I);Ie(r,"SID",t.K),Ie(r,"RID",n),Ie(r,"AID",t.T),dn(t,r),t.m&&t.o&&Qe(r,t.m,t.o),n=new $t(t,t.j,n,t.B+1),null===t.m&&(n.H=t.o),e&&(t.i=e.D.concat(t.i)),e=fn(t,n,1e3),n.I=Math.round(.5*t.wa)+Math.round(.5*t.wa*Math.random()),he(t.h,n),Yt(n,r,e)}function dn(t,e){t.H&&D(t.H,(function(t,n){Ie(e,n,t)})),t.l&&ge({},(function(t,n){Ie(e,n,t)}))}function fn(t,e,n){n=Math.min(t.i.length,n);var r=t.l?c(t.l.Na,t.l,t):null;t:{var s=t.i;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=s[0].g,t.push("ofs="+e)):e=0:t.push("ofs="+e);let o=!0;for(let a=0;a<n;a++){let n=s[a].g;const u=s[a].map;if(n-=e,0>n)e=Math.max(0,s[a].g-100),o=!1;else try{qe(u,t,"req"+n+"_")}catch(i){r&&r(u)}}if(o){r=t.join("&");break t}}}return t=t.i.splice(0,n),e.D=t,r}function gn(t){if(!t.g&&!t.u){t.Y=1;var e=t.Fa;V||B(),U||(V(),U=!0),q.add(e,t),t.v=0}}function mn(t){return!(t.g||t.u||3<=t.v)&&(t.Y++,t.u=Ut(c(t.Fa,t),bn(t,t.v)),t.v++,!0)}function pn(t){null!=t.A&&(s.clearTimeout(t.A),t.A=null)}function yn(t){t.g=new $t(t,t.j,"rpc",t.Y),null===t.m&&(t.g.H=t.o),t.g.O=0;var e=ye(t.qa);Ie(e,"RID","rpc"),Ie(e,"SID",t.K),Ie(e,"AID",t.T),Ie(e,"CI",t.F?"0":"1"),!t.F&&t.ja&&Ie(e,"TO",t.ja),Ie(e,"TYPE","xmlhttp"),dn(t,e),t.m&&t.o&&Qe(e,t.m,t.o),t.L&&(t.g.I=t.L);var n=t.g;t=t.ia,n.L=1,n.v=Te(ye(e)),n.m=null,n.P=!0,Xt(n,t)}function wn(t){null!=t.C&&(s.clearTimeout(t.C),t.C=null)}function vn(t,e){var n=null;if(t.g==e){wn(t),pn(t),t.g=null;var r=2}else{if(!le(t.h,e))return;n=e.D,de(t.h,e),r=1}if(0!=t.G)if(e.o)if(1==r){n=e.m?e.m.length:0,e=Date.now()-e.F;var s=t.B;gt(r=Mt(),new Vt(r,n)),ln(t)}else gn(t);else if(3==(s=e.s)||0==s&&0<e.X||!(1==r&&function(t,e){return!(ce(t.h)>=t.h.j-(t.s?1:0))&&(t.s?(t.i=e.D.concat(t.i),!0):!(1==t.G||2==t.G||t.B>=(t.Va?0:t.Wa))&&(t.s=Ut(c(t.Ga,t,e),bn(t,t.B)),t.B++,!0))}(t,e)||2==r&&mn(t)))switch(n&&0<n.length&&(e=t.h,e.i=e.i.concat(n)),s){case 1:In(t,5);break;case 4:In(t,10);break;case 3:In(t,6);break;default:In(t,2)}}function bn(t,e){let n=t.Ta+Math.floor(Math.random()*t.cb);return t.isActive()||(n*=2),n*e}function In(t,e){if(t.j.info("Error code "+e),2==e){var n=c(t.fb,t),r=t.Xa;const e=!r;r=new pe(r||"//www.google.com/images/cleardot.gif"),s.location&&"http"==s.location.protocol||we(r,"https"),Te(r),e?function(t,e){const n=new qt;if(s.Image){const r=new Image;r.onload=l(Ve,n,"TestLoadImage: loaded",!0,e,r),r.onerror=l(Ve,n,"TestLoadImage: error",!1,e,r),r.onabort=l(Ve,n,"TestLoadImage: abort",!1,e,r),r.ontimeout=l(Ve,n,"TestLoadImage: timeout",!1,e,r),s.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=t}else e(!1)}(r.toString(),n):function(t,e){new qt;const n=new AbortController,r=setTimeout((()=>{n.abort(),Ve(0,0,!1,e)}),1e4);fetch(t,{signal:n.signal}).then((t=>{clearTimeout(r),t.ok?Ve(0,0,!0,e):Ve(0,0,!1,e)})).catch((()=>{clearTimeout(r),Ve(0,0,!1,e)}))}(r.toString(),n)}else Ft(2);t.G=0,t.l&&t.l.sa(e),Tn(t),cn(t)}function Tn(t){if(t.G=0,t.ka=[],t.l){const e=fe(t.h);0==e.length&&0==t.i.length||(E(t.ka,e),E(t.ka,t.i),t.h.i.length=0,_(t.i),t.i.length=0),t.l.ra()}}function _n(t,e,n){var r=n instanceof pe?ye(n):new pe(n);if(""!=r.g)e&&(r.g=e+"."+r.g),ve(r,r.s);else{var i=s.location;r=i.protocol,e=e?e+"."+i.hostname:i.hostname,i=+i.port;var o=new pe(null);r&&we(o,r),e&&(o.g=e),i&&ve(o,i),n&&(o.l=n),r=o}return n=t.D,e=t.ya,n&&e&&Ie(r,n,e),Ie(r,"VER",t.la),dn(t,r),r}function En(t,e,n){if(e&&!t.J)throw Error("Can't create secondary domain capable XhrIo object.");return(e=t.Ca&&!t.pa?new He(new Be({eb:n})):new He(t.pa)).Ha(t.J),e}function Sn(){}function xn(){}function Cn(t,e){ft.call(this),this.g=new on(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.o=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.va&&(t?t["X-WebChannel-Client-Profile"]=e.va:t={"X-WebChannel-Client-Profile":e.va}),this.g.S=t,(t=e&&e.Sb)&&!S(t)&&(this.g.m=t),this.v=e&&e.supportsCrossDomainXhr||!1,this.u=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!S(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new kn(this)}function An(t){Dt.call(this),t.__headers__&&(this.headers=t.__headers__,this.statusCode=t.__status__,delete t.__headers__,delete t.__status__);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Dn(){kt.call(this),this.status=1}function kn(t){this.g=t}(t=He.prototype).Ha=function(t){this.J=t},t.ea=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+t);e=e?e.toUpperCase():"GET",this.D=t,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():zt.g(),this.v=this.o?xt(this.o):xt(zt),this.g.onreadystatechange=c(this.Ea,this);try{this.B=!0,this.g.open(e,String(t),!0),this.B=!1}catch(o){return void Xe(this,o)}if(t=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!==typeof r.keys||"function"!==typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const t of r.keys())n.set(t,r.get(t))}r=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),i=s.FormData&&t instanceof s.FormData,!(0<=Array.prototype.indexOf.call(Ye,e,void 0))||r||i||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[s,a]of n)this.g.setRequestHeader(s,a);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{en(this),this.u=!0,this.g.send(t),this.u=!1}catch(o){Xe(this,o)}},t.abort=function(t){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=t||7,gt(this,"complete"),gt(this,"abort"),tn(this))},t.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),tn(this,!0)),He.aa.N.call(this)},t.Ea=function(){this.s||(this.B||this.u||this.j?Ze(this):this.bb())},t.bb=function(){Ze(this)},t.isActive=function(){return!!this.g},t.Z=function(){try{return 2<nn(this)?this.g.status:-1}catch(xe){return-1}},t.oa=function(){try{return this.g?this.g.responseText:""}catch(xe){return""}},t.Oa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),_t(e)}},t.Ba=function(){return this.m},t.Ka=function(){return"string"===typeof this.l?this.l:String(this.l)},(t=on.prototype).la=8,t.G=1,t.connect=function(t,e,n,r){Ft(0),this.W=t,this.H=e||{},n&&void 0!==r&&(this.H.OSID=n,this.H.OAID=r),this.F=this.X,this.I=_n(this,null,this.W),ln(this)},t.Ga=function(t){if(this.s)if(this.s=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const s=new $t(this,this.j,t);let i=this.o;if(this.S&&(i?(i=k(i),R(i,this.S)):i=this.S),null!==this.m||this.O||(s.H=i,i=null),this.P)t:{for(var e=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.map&&"string"===typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(e+=r)){e=n;break t}if(4096===e||n===this.i.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=fn(this,s,e),Ie(n=ye(this.I),"RID",t),Ie(n,"CVER",22),this.D&&Ie(n,"X-HTTP-Session-Id",this.D),dn(this,n),i&&(this.O?e="headers="+encodeURIComponent(String($e(i)))+"&"+e:this.m&&Qe(n,this.m,i)),he(this.h,s),this.Ua&&Ie(n,"TYPE","init"),this.P?(Ie(n,"$req",e),Ie(n,"SID","null"),s.T=!0,Yt(s,n,null)):Yt(s,n,e),this.G=2}}else 3==this.G&&(t?hn(this,t):0==this.i.length||ue(this.h)||hn(this))},t.Fa=function(){if(this.u=null,yn(this),this.ba&&!(this.M||null==this.g||0>=this.R)){var t=2*this.R;this.j.info("BP detection timer enabled: "+t),this.A=Ut(c(this.ab,this),t)}},t.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Ft(10),un(this),yn(this))},t.Za=function(){null!=this.C&&(this.C=null,un(this),mn(this),Ft(19))},t.fb=function(t){t?(this.j.info("Successfully pinged google.com"),Ft(2)):(this.j.info("Failed to ping google.com"),Ft(1))},t.isActive=function(){return!!this.l&&this.l.isActive(this)},(t=Sn.prototype).ua=function(){},t.ta=function(){},t.sa=function(){},t.ra=function(){},t.isActive=function(){return!0},t.Na=function(){},xn.prototype.g=function(t,e){return new Cn(t,e)},I(Cn,ft),Cn.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Cn.prototype.close=function(){an(this.g)},Cn.prototype.o=function(t){var e=this.g;if("string"===typeof t){var n={};n.__data__=t,t=n}else this.u&&((n={}).__data__=Tt(t),t=n);e.i.push(new oe(e.Ya++,t)),3==e.G&&ln(e)},Cn.prototype.N=function(){this.g.l=null,delete this.j,an(this.g),delete this.g,Cn.aa.N.call(this)},I(An,Dt),I(Dn,kt),I(kn,Sn),kn.prototype.ua=function(){gt(this.g,"a")},kn.prototype.ta=function(t){gt(this.g,new An(t))},kn.prototype.sa=function(t){gt(this.g,new Dn)},kn.prototype.ra=function(){gt(this.g,"b")},xn.prototype.createWebChannel=xn.prototype.g,Cn.prototype.send=Cn.prototype.o,Cn.prototype.open=Cn.prototype.m,Cn.prototype.close=Cn.prototype.close,w=b.createWebChannelTransport=function(){return new xn},y=b.getStatEventTarget=function(){return Mt()},p=b.Event=Nt,m=b.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},jt.NO_ERROR=0,jt.TIMEOUT=8,jt.HTTP_ERROR=6,g=b.ErrorCode=jt,Kt.COMPLETE="complete",f=b.EventType=Kt,Ct.EventType=At,At.OPEN="a",At.CLOSE="b",At.ERROR="c",At.MESSAGE="d",ft.prototype.listen=ft.prototype.K,d=b.WebChannel=Ct,b.FetchXmlHttpFactory=Be,He.prototype.listenOnce=He.prototype.L,He.prototype.getLastError=He.prototype.Ka,He.prototype.getLastErrorCode=He.prototype.Ba,He.prototype.getStatus=He.prototype.Z,He.prototype.getResponseJson=He.prototype.Oa,He.prototype.getResponseText=He.prototype.oa,He.prototype.send=He.prototype.ea,He.prototype.setWithCredentials=He.prototype.Ha,h=b.XhrIo=He}).apply("undefined"!==typeof v?v:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{});const I="@firebase/firestore",T="4.7.10";class _{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}_.UNAUTHENTICATED=new _(null),_.GOOGLE_CREDENTIALS=new _("google-credentials-uid"),_.FIRST_PARTY=new _("first-party-uid"),_.MOCK_USER=new _("mock-user");let E="11.5.0";const S=new a.Vy("@firebase/firestore");function x(){return S.logLevel}function C(t){S.setLogLevel(t)}function A(t){if(S.logLevel<=a.$b.DEBUG){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];const s=n.map(N);S.debug(`Firestore (${E}): ${t}`,...s)}}function D(t){if(S.logLevel<=a.$b.ERROR){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];const s=n.map(N);S.error(`Firestore (${E}): ${t}`,...s)}}function k(t){if(S.logLevel<=a.$b.WARN){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];const s=n.map(N);S.warn(`Firestore (${E}): ${t}`,...s)}}function N(t){if("string"==typeof t)return t;try{return function(t){return JSON.stringify(t)}(t)}catch(e){return t}}function R(){const t=`FIRESTORE (${E}) INTERNAL ASSERTION FAILED: `+(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected state");throw D(t),new Error(t)}function M(t,e){t||R()}function P(t,e){t||R()}function O(t,e){return t}const L={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class F extends u.g{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class V{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class U{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class q{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(_.UNAUTHENTICATED)))}shutdown(){}}class B{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class z{constructor(t){this.t=t,this.currentUser=_.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){M(void 0===this.o);let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new V;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new V,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{A("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.o&&(this.auth.addAuthTokenListener(this.o),i())};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(A("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new V)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(A("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(M("string"==typeof e.accessToken),new U(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const t=this.auth&&this.auth.getUid();return M(null===t||"string"==typeof t),new _(t)}}class j{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=_.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);const t=this.I();return t&&this.T.set("Authorization",t),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class K{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new j(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable((()=>e(_.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class G{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class ${constructor(t,e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,i.xZ)(t)&&t.settings.appCheckToken&&(this.V=t.settings.appCheckToken)}start(t,e){M(void 0===this.o);const n=t=>{null!=t.error&&A("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.R;return this.R=t.token,A("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const r=t=>{A("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit((t=>r(t))),setTimeout((()=>{if(!this.appCheck){const t=this.A.getImmediate({optional:!0});t?r(t):A("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){if(this.V)return Promise.resolve(new G(this.V));const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(M("string"==typeof t.token),this.R=t.token,new G(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class Q{getToken(){return Promise.resolve(new G(""))}invalidateToken(){}start(t,e){}shutdown(){}}function H(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let r=0;r<t;r++)n[r]=Math.floor(256*Math.random());return n}function W(){return new TextEncoder}class Y{static newId(){const t=62*Math.floor(256/62);let e="";for(;e.length<20;){const n=H(40);for(let r=0;r<n.length;++r)e.length<20&&n[r]<t&&(e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return e}}function X(t,e){return t<e?-1:t>e?1:0}function J(t,e){let n=0;for(;n<t.length&&n<e.length;){const r=t.codePointAt(n),s=e.codePointAt(n);if(r!==s){if(r<128&&s<128)return X(r,s);{const i=W(),o=tt(i.encode(Z(t,n)),i.encode(Z(e,n)));return 0!==o?o:X(r,s)}}n+=r>65535?2:1}return X(t.length,e.length)}function Z(t,e){return t.codePointAt(e)>65535?t.substring(e,e+2):t.substring(e,e+1)}function tt(t,e){for(let n=0;n<t.length&&n<e.length;++n)if(t[n]!==e[n])return X(t[n],e[n]);return X(t.length,e.length)}function et(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function nt(t){return t+"\0"}const rt=-62135596800,st=1e6;class it{static now(){return it.fromMillis(Date.now())}static fromDate(t){return it.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor((t-1e3*e)*st);return new it(e,n)}constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new F(L.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new F(L.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<rt)throw new F(L.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new F(L.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/st}_compareTo(t){return this.seconds===t.seconds?X(this.nanoseconds,t.nanoseconds):X(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds-rt;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ot{static fromTimestamp(t){return new ot(t)}static min(){return new ot(new it(0,0))}static max(){return new ot(new it(253402300799,999999999))}constructor(t){this.timestamp=t}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}const at="__name__";class ut{constructor(t,e,n){void 0===e?e=0:e>t.length&&R(),void 0===n?n=t.length-e:n>t.length-e&&R(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===ut.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof ut?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=ut.compareSegments(t.get(r),e.get(r));if(0!==n)return n}return X(t.length,e.length)}static compareSegments(t,e){const n=ut.isNumericId(t),r=ut.isNumericId(e);return n&&!r?-1:!n&&r?1:n&&r?ut.extractNumericId(t).compare(ut.extractNumericId(e)):J(t,e)}static isNumericId(t){return t.startsWith("__id")&&t.endsWith("__")}static extractNumericId(t){return r.fromString(t.substring(4,t.length-2))}}class ct extends ut{construct(t,e,n){return new ct(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(){const t=[];for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(const s of n){if(s.indexOf("//")>=0)throw new F(L.INVALID_ARGUMENT,`Invalid segment (${s}). Paths must not contain // in them.`);t.push(...s.split("/").filter((t=>t.length>0)))}return new ct(t)}static emptyPath(){return new ct([])}}const lt=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ht extends ut{construct(t,e,n){return new ht(t,e,n)}static isValidIdentifier(t){return lt.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ht.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===at}static keyField(){return new ht([at])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new F(L.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new F(L.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new F(L.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new F(L.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new ht(e)}static emptyPath(){return new ht([])}}class dt{constructor(t){this.path=t}static fromPath(t){return new dt(ct.fromString(t))}static fromName(t){return new dt(ct.fromString(t).popFirst(5))}static empty(){return new dt(ct.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===ct.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return ct.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new dt(new ct(t.slice()))}}const ft=-1;class gt{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}function mt(t){return t.fields.find((t=>2===t.kind))}function pt(t){return t.fields.filter((t=>2!==t.kind))}function yt(t,e){let n=X(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(t.fields.length,e.fields.length);++r)if(n=vt(t.fields[r],e.fields[r]),0!==n)return n;return X(t.fields.length,e.fields.length)}gt.UNKNOWN_ID=-1;class wt{constructor(t,e){this.fieldPath=t,this.kind=e}}function vt(t,e){const n=ht.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:X(t.kind,e.kind)}class bt{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new bt(0,_t.min())}}function It(t,e){const n=t.toTimestamp().seconds,r=t.toTimestamp().nanoseconds+1,s=ot.fromTimestamp(1e9===r?new it(n+1,0):new it(n,r));return new _t(s,dt.empty(),e)}function Tt(t){return new _t(t.readTime,t.key,ft)}class _t{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new _t(ot.min(),dt.empty(),ft)}static max(){return new _t(ot.max(),dt.empty(),ft)}}function Et(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=dt.comparator(t.documentKey,e.documentKey),0!==n?n:X(t.largestBatchId,e.largestBatchId))}const St="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class xt{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Ct(t){if(t.code!==L.FAILED_PRECONDITION||t.message!==St)throw t;A("LocalStore","Unexpectedly lost primary lease")}class At{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&R(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new At(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof At?e:At.resolve(e)}catch(t){return At.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):At.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):At.reject(e)}static resolve(t){return new At(((e,n)=>{e(t)}))}static reject(t){return new At(((e,n)=>{n(t)}))}static waitFor(t){return new At(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=At.resolve(!1);for(const n of t)e=e.next((t=>t?At.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}static mapArray(t,e){return new At(((n,r)=>{const s=t.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===s&&n(i)}),(t=>r(t)))}}))}static doWhile(t,e){return new At(((n,r)=>{const s=()=>{!0===t()?e().next((()=>{s()}),r):n()};s()}))}}const Dt="SimpleDb";class kt{static open(t,e,n,r){try{return new kt(e,t.transaction(r,n))}catch(t){throw new Pt(e,t)}}constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.m=new V,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{e.error?this.m.reject(new Pt(t,e.error)):this.m.resolve()},this.transaction.onerror=e=>{const n=Ut(e.target.error);this.m.reject(new Pt(t,n))}}get p(){return this.m.promise}abort(t){t&&this.m.reject(t),this.aborted||(A(Dt,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new Lt(e)}}class Nt{static delete(t){return A(Dt,"Removing database:",t),Ft(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!(0,u.zW)())return!1;if(Nt.v())return!0;const t=(0,u.ZQ)(),e=Nt.C(t),n=0<e&&e<10,r=Rt(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static v(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.__PRIVATE_env)||void 0===t?void 0:t.F)}static M(t,e){return t.store(e)}static C(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}constructor(t,e,n){this.name=t,this.version=e,this.O=n,12.2===Nt.C((0,u.ZQ)())&&D("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(t){return this.db||(A(Dt,"Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new Pt(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new F(L.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new F(L.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Pt(t,r))},r.onupgradeneeded=t=>{A(Dt,'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.O.B(e,r.transaction,t.oldVersion,this.version).next((()=>{A(Dt,"Database upgrade to version "+this.version+" complete")}))}}))),this.L&&(this.db.onversionchange=t=>this.L(t)),this.db}k(t){this.L=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.N(t);const e=kt.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).next((t=>(e.S(),t))).catch((t=>(e.abort(t),At.reject(t)))).toPromise();return i.catch((()=>{})),await e.p,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(A(Dt,"Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}function Rt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class Mt{constructor(t){this.q=t,this.$=!1,this.U=null}get isDone(){return this.$}get K(){return this.U}set cursor(t){this.q=t}done(){this.$=!0}W(t){this.U=t}delete(){return Ft(this.q.delete())}}class Pt extends F{constructor(t,e){super(L.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Ot(t){return"IndexedDbTransactionError"===t.name}class Lt{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(A(Dt,"PUT",this.store.name,t,e),n=this.store.put(e,t)):(A(Dt,"PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Ft(n)}add(t){return A(Dt,"ADD",this.store.name,t,t),Ft(this.store.add(t))}get(t){return Ft(this.store.get(t)).next((e=>(void 0===e&&(e=null),A(Dt,"GET",this.store.name,t,e),e)))}delete(t){return A(Dt,"DELETE",this.store.name,t),Ft(this.store.delete(t))}count(){return A(Dt,"COUNT",this.store.name),Ft(this.store.count())}G(t,e){const n=this.options(t,e),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const t=r.getAll(n.range);return new At(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}{const t=this.cursor(n),e=[];return this.j(t,((t,n)=>{e.push(n)})).next((()=>e))}}H(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new At(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}J(t,e){A(Dt,"DELETE ALL",this.store.name);const n=this.options(t,e);n.Y=!1;const r=this.cursor(n);return this.j(r,((t,e,n)=>n.delete()))}Z(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.j(r,e)}X(t){const e=this.cursor({});return new At(((n,r)=>{e.onerror=t=>{const e=Ut(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}j(t,e){const n=[];return new At(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new Mt(s),o=e(s.primaryKey,s.value,i);if(o instanceof At){const t=o.catch((t=>(i.done(),At.reject(t))));n.push(t)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>At.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.Y?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Ft(t){return new At(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Ut(t.target.error);n(e)}}))}let Vt=!1;function Ut(t){const e=Nt.C((0,u.ZQ)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new F("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Vt||(Vt=!0,setTimeout((()=>{throw t}),0)),t}}return t}const qt="IndexBackfiller";class Bt{constructor(t,e){this.asyncQueue=t,this.ee=e,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(t){A(qt,`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{const t=await this.ee.ne();A(qt,`Documents written: ${t}`)}catch(t){Ot(t)?A(qt,"Ignoring IndexedDB error during index backfill: ",t):await Ct(t)}await this.te(6e4)}))}}class zt{constructor(t,e){this.localStore=t,this.persistence=e}async ne(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.re(e,t)))}re(t,e){const n=new Set;let r=e,s=!0;return At.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return A(qt,`Processing collection: ${e}`),this.ie(t,e,r).next((t=>{r-=t,n.add(e)}));s=!1})))).next((()=>e-r))}ie(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((r=>this.localStore.localDocuments.getNextDocuments(t,e,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(t,s).next((()=>this.se(r,n))).next((n=>(A(qt,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>s.size))}))))}se(t,e){let n=t;return e.changes.forEach(((t,e)=>{const r=Tt(e);Et(r,n)>0&&(n=r)})),new _t(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class jt{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.oe(t),this._e=t=>e.writeSequenceNumber(t))}oe(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this._e&&this._e(t),t}}jt.ae=-1;const Kt=-1;function Gt(t){return null==t}function $t(t){return 0===t&&1/t==-1/0}function Qt(t){return"number"==typeof t&&Number.isInteger(t)&&!$t(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}const Ht="\x01";function Wt(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Xt(e)),e=Yt(t.get(n),e);return Xt(e)}function Yt(t,e){let n=e;const r=t.length;for(let s=0;s<r;s++){const e=t.charAt(s);switch(e){case"\0":n+="\x01\x10";break;case Ht:n+="\x01\x11";break;default:n+=e}}return n}function Xt(t){return t+Ht+"\x01"}function Jt(t){const e=t.length;if(M(e>=2),2===e)return M(t.charAt(0)===Ht&&"\x01"===t.charAt(1)),ct.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf(Ht,i);switch((e<0||e>n)&&R(),t.charAt(e+1)){case"\x01":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=t.substring(i,e),s+="\0";break;case"\x11":s+=t.substring(i,e+1);break;default:R()}i=e+2}return new ct(r)}const Zt="remoteDocuments",te="owner",ee="owner",ne="mutationQueues",re="mutations",se="batchId",ie="userMutationsIndex",oe=["userId","batchId"];function ae(t,e){return[t,Wt(e)]}function ue(t,e,n){return[t,Wt(e),n]}const ce={},le="documentMutations",he="remoteDocumentsV14",de=["prefixPath","collectionGroup","readTime","documentId"],fe="documentKeyIndex",ge=["prefixPath","collectionGroup","documentId"],me="collectionGroupIndex",pe=["collectionGroup","readTime","prefixPath","documentId"],ye="remoteDocumentGlobal",we="remoteDocumentGlobalKey",ve="targets",be="queryTargetsIndex",Ie=["canonicalId","targetId"],Te="targetDocuments",_e=["targetId","path"],Ee="documentTargetsIndex",Se=["path","targetId"],xe="targetGlobalKey",Ce="targetGlobal",Ae="collectionParents",De=["collectionId","parent"],ke="clientMetadata",Ne="bundles",Re="namedQueries",Me="indexConfiguration",Pe="collectionGroupIndex",Oe="indexState",Le=["indexId","uid"],Fe="sequenceNumberIndex",Ve=["uid","sequenceNumber"],Ue="indexEntries",qe=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Be="documentKeyIndex",ze=["indexId","uid","orderedDocumentKey"],je="documentOverlays",Ke=["userId","collectionPath","documentId"],Ge="collectionPathOverlayIndex",$e=["userId","collectionPath","largestBatchId"],Qe="collectionGroupOverlayIndex",He=["userId","collectionGroup","largestBatchId"],We="globals",Ye=[ne,re,le,Zt,ve,te,Ce,Te,ke,ye,Ae,Ne,Re],Xe=[...Ye,je],Je=[ne,re,le,he,ve,te,Ce,Te,ke,ye,Ae,Ne,Re,je],Ze=Je,tn=[...Ze,Me,Oe,Ue],en=tn,nn=[...tn,We];class rn extends xt{constructor(t,e){super(),this.ue=t,this.currentSequenceNumber=e}}function sn(t,e){const n=O(t);return Nt.M(n.ue,e)}function on(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function an(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function un(t,e){const n=[];for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(e(t[r],r,t));return n}function cn(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class ln{constructor(t,e){this.comparator=t,this.root=e||dn.EMPTY}insert(t,e){return new ln(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,dn.BLACK,null,null))}remove(t){return new ln(this.comparator,this.root.remove(t,this.comparator).copy(null,null,dn.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new hn(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new hn(this.root,t,this.comparator,!1)}getReverseIterator(){return new hn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new hn(this.root,t,this.comparator,!0)}}class hn{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class dn{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:dn.RED,this.left=null!=r?r:dn.EMPTY,this.right=null!=s?s:dn.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new dn(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return dn.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return dn.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,dn.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,dn.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw R();if(this.right.isRed())throw R();const t=this.left.check();if(t!==this.right.check())throw R();return t+(this.isRed()?0:1)}}dn.EMPTY=null,dn.RED=!0,dn.BLACK=!1,dn.EMPTY=new class{constructor(){this.size=0}get key(){throw R()}get value(){throw R()}get color(){throw R()}get left(){throw R()}get right(){throw R()}copy(t,e,n,r,s){return this}insert(t,e,n){return new dn(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class fn{constructor(t){this.comparator=t,this.data=new ln(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new gn(this.data.getIterator())}getIteratorFrom(t){return new gn(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof fn))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new fn(this.comparator);return e.data=t,e}}class gn{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function mn(t){return t.hasNext()?t.getNext():void 0}class pn{constructor(t){this.fields=t,t.sort(ht.comparator)}static empty(){return new pn([])}unionWith(t){let e=new fn(ht.comparator);for(const n of this.fields)e=e.add(n);for(const n of t)e=e.add(n);return new pn(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return et(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class yn extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function wn(){return"undefined"!=typeof atob}class vn{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new yn("Invalid base64 string: "+t):t}}(t);return new vn(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new vn(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return X(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}vn.EMPTY_BYTE_STRING=new vn("");const bn=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function In(t){if(M(!!t),"string"==typeof t){let e=0;const n=bn.exec(t);if(M(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:Tn(t.seconds),nanos:Tn(t.nanos)}}function Tn(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function _n(t){return"string"==typeof t?vn.fromBase64String(t):vn.fromUint8Array(t)}const En="server_timestamp",Sn="__type__",xn="__previous_value__",Cn="__local_write_time__";function An(t){var e,n;return(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{})[Sn])||void 0===n?void 0:n.stringValue)===En}function Dn(t){const e=t.mapValue.fields[xn];return An(e)?Dn(e):e}function kn(t){const e=In(t.mapValue.fields[Cn].timestampValue);return new it(e.seconds,e.nanos)}class Nn{constructor(t,e,n,r,s,i,o,a,u){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}const Rn="(default)";class Mn{constructor(t,e){this.projectId=t,this.database=e||Rn}static empty(){return new Mn("","")}get isDefaultDatabase(){return this.database===Rn}isEqual(t){return t instanceof Mn&&t.projectId===this.projectId&&t.database===this.database}}const Pn="__type__",On="__max__",Ln={mapValue:{fields:{__type__:{stringValue:On}}}},Fn="__vector__",Vn="value",Un={nullValue:"NULL_VALUE"};function qn(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?An(t)?4:rr(t)?9007199254740991:er(t)?10:11:R()}function Bn(t,e){if(t===e)return!0;const n=qn(t);if(n!==qn(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return kn(t).isEqual(kn(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=In(t.timestampValue),r=In(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return _n(t.bytesValue).isEqual(_n(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return Tn(t.geoPointValue.latitude)===Tn(e.geoPointValue.latitude)&&Tn(t.geoPointValue.longitude)===Tn(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Tn(t.integerValue)===Tn(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=Tn(t.doubleValue),r=Tn(e.doubleValue);return n===r?$t(n)===$t(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return et(t.arrayValue.values||[],e.arrayValue.values||[],Bn);case 10:case 11:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(on(n)!==on(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!Bn(n[s],r[s])))return!1;return!0}(t,e);default:return R()}}function zn(t,e){return void 0!==(t.values||[]).find((t=>Bn(t,e)))}function jn(t,e){if(t===e)return 0;const n=qn(t),r=qn(e);if(n!==r)return X(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return X(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=Tn(t.integerValue||t.doubleValue),r=Tn(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return Kn(t.timestampValue,e.timestampValue);case 4:return Kn(kn(t),kn(e));case 5:return J(t.stringValue,e.stringValue);case 6:return function(t,e){const n=_n(t),r=_n(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=X(n[s],r[s]);if(0!==t)return t}return X(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=X(Tn(t.latitude),Tn(e.latitude));return 0!==n?n:X(Tn(t.longitude),Tn(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return Gn(t.arrayValue,e.arrayValue);case 10:return function(t,e){var n,r,s,i;const o=t.fields||{},a=e.fields||{},u=null===(n=o[Vn])||void 0===n?void 0:n.arrayValue,c=null===(r=a[Vn])||void 0===r?void 0:r.arrayValue,l=X((null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0,(null===(i=null==c?void 0:c.values)||void 0===i?void 0:i.length)||0);return 0!==l?l:Gn(u,c)}(t.mapValue,e.mapValue);case 11:return function(t,e){if(t===Ln.mapValue&&e===Ln.mapValue)return 0;if(t===Ln.mapValue)return 1;if(e===Ln.mapValue)return-1;const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=J(r[o],i[o]);if(0!==t)return t;const e=jn(n[r[o]],s[i[o]]);if(0!==e)return e}return X(r.length,i.length)}(t.mapValue,e.mapValue);default:throw R()}}function Kn(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return X(t,e);const n=In(t),r=In(e),s=X(n.seconds,r.seconds);return 0!==s?s:X(n.nanos,r.nanos)}function Gn(t,e){const n=t.values||[],r=e.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=jn(n[s],r[s]);if(t)return t}return X(n.length,r.length)}function $n(t){return Qn(t)}function Qn(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=In(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(t){return _n(t).toBase64()}(t.bytesValue):"referenceValue"in t?function(t){return dt.fromName(t).toString()}(t.referenceValue):"geoPointValue"in t?function(t){return`geo(${t.latitude},${t.longitude})`}(t.geoPointValue):"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=Qn(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${Qn(t.fields[s])}`;return n+"}"}(t.mapValue):R()}function Hn(t){switch(qn(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const e=Dn(t);return e?16+Hn(e):16;case 5:return 2*t.stringValue.length;case 6:return _n(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return function(t){return(t.values||[]).reduce(((t,e)=>t+Hn(e)),0)}(t.arrayValue);case 10:case 11:return function(t){let e=0;return an(t.fields,((t,n)=>{e+=t.length+Hn(n)})),e}(t.mapValue);default:throw R()}}function Wn(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Yn(t){return!!t&&"integerValue"in t}function Xn(t){return!!t&&"arrayValue"in t}function Jn(t){return!!t&&"nullValue"in t}function Zn(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function tr(t){return!!t&&"mapValue"in t}function er(t){var e,n;return(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{})[Pn])||void 0===n?void 0:n.stringValue)===Fn}function nr(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return an(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=nr(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=nr(t.arrayValue.values[n]);return e}return Object.assign({},t)}function rr(t){return(((t.mapValue||{}).fields||{}).__type__||{}).stringValue===On}const sr={mapValue:{fields:{[Pn]:{stringValue:Fn},[Vn]:{arrayValue:{}}}}};function ir(t){return"nullValue"in t?Un:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Wn(Mn.empty(),dt.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?er(t)?sr:{mapValue:{}}:R()}function or(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Wn(Mn.empty(),dt.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?sr:"mapValue"in t?er(t)?{mapValue:{}}:Ln:R()}function ar(t,e){const n=jn(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function ur(t,e){const n=jn(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class cr{constructor(t){this.value=t}static empty(){return new cr({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!tr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=nr(e)}setAll(t){let e=ht.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=nr(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());tr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Bn(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];tr(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){an(e,((e,n)=>t[e]=n));for(const r of n)delete t[r]}clone(){return new cr(nr(this.value))}}function lr(t){const e=[];return an(t.fields,((t,n)=>{const r=new ht([t]);if(tr(n)){const t=lr(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new pn(e)}class hr{constructor(t,e,n,r,s,i,o){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(t){return new hr(t,0,ot.min(),ot.min(),ot.min(),cr.empty(),0)}static newFoundDocument(t,e,n,r){return new hr(t,1,e,ot.min(),n,r,0)}static newNoDocument(t,e){return new hr(t,2,e,ot.min(),ot.min(),cr.empty(),0)}static newUnknownDocument(t,e){return new hr(t,3,e,ot.min(),ot.min(),cr.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(ot.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=cr.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=cr.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ot.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof hr&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new hr(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class dr{constructor(t,e){this.position=t,this.inclusive=e}}function fr(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?dt.comparator(dt.fromName(o.referenceValue),n.key):jn(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function gr(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Bn(t.position[n],e.position[n]))return!1;return!0}class mr{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc";this.field=t,this.dir=e}}function pr(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class yr{}class wr extends yr{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new Ar(t,e,n):"array-contains"===e?new Rr(t,n):"in"===e?new Mr(t,n):"not-in"===e?new Pr(t,n):"array-contains-any"===e?new Or(t,n):new wr(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new Dr(t,n):new kr(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(jn(e,this.value)):null!==e&&qn(this.value)===qn(e)&&this.matchesComparison(jn(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return R()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class vr extends yr{constructor(t,e){super(),this.filters=t,this.op=e,this.ce=null}static create(t,e){return new vr(t,e)}matches(t){return br(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function br(t){return"and"===t.op}function Ir(t){return"or"===t.op}function Tr(t){return _r(t)&&br(t)}function _r(t){for(const e of t.filters)if(e instanceof vr)return!1;return!0}function Er(t){if(t instanceof wr)return t.field.canonicalString()+t.op.toString()+$n(t.value);if(Tr(t))return t.filters.map((t=>Er(t))).join(",");{const e=t.filters.map((t=>Er(t))).join(",");return`${t.op}(${e})`}}function Sr(t,e){return t instanceof wr?function(t,e){return e instanceof wr&&t.op===e.op&&t.field.isEqual(e.field)&&Bn(t.value,e.value)}(t,e):t instanceof vr?function(t,e){return e instanceof vr&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,r)=>t&&Sr(n,e.filters[r])),!0)}(t,e):void R()}function xr(t,e){const n=t.filters.concat(e);return vr.create(n,t.op)}function Cr(t){return t instanceof wr?function(t){return`${t.field.canonicalString()} ${t.op} ${$n(t.value)}`}(t):t instanceof vr?function(t){return t.op.toString()+" {"+t.getFilters().map(Cr).join(" ,")+"}"}(t):"Filter"}class Ar extends wr{constructor(t,e,n){super(t,e,n),this.key=dt.fromName(n.referenceValue)}matches(t){const e=dt.comparator(t.key,this.key);return this.matchesComparison(e)}}class Dr extends wr{constructor(t,e){super(t,"in",e),this.keys=Nr("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class kr extends wr{constructor(t,e){super(t,"not-in",e),this.keys=Nr("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Nr(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>dt.fromName(t.referenceValue)))}class Rr extends wr{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Xn(e)&&zn(e.arrayValue,this.value)}}class Mr extends wr{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&zn(this.value.arrayValue,e)}}class Pr extends wr{constructor(t,e){super(t,"not-in",e)}matches(t){if(zn(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!zn(this.value.arrayValue,e)}}class Or extends wr{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Xn(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>zn(this.value.arrayValue,t)))}}class Lr{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.le=null}}function Fr(t){return new Lr(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,arguments.length>6&&void 0!==arguments[6]?arguments[6]:null)}function Vr(t){const e=O(t);if(null===e.le){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>Er(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Gt(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>$n(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>$n(t))).join(",")),e.le=t}return e.le}function Ur(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!pr(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!Sr(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!gr(t.startAt,e.startAt)&&gr(t.endAt,e.endAt)}function qr(t){return dt.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Br(t,e){return t.filters.filter((t=>t instanceof wr&&t.field.isEqual(e)))}function zr(t,e,n){let r=Un,s=!0;for(const i of Br(t,e)){let t=Un,e=!0;switch(i.op){case"<":case"<=":t=ir(i.value);break;case"==":case"in":case">=":t=i.value;break;case">":t=i.value,e=!1;break;case"!=":case"not-in":t=Un}ar({value:r,inclusive:s},{value:t,inclusive:e})<0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];ar({value:r,inclusive:s},{value:t,inclusive:n.inclusive})<0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}function jr(t,e,n){let r=Ln,s=!0;for(const i of Br(t,e)){let t=Ln,e=!0;switch(i.op){case">=":case">":t=or(i.value),e=!1;break;case"==":case"in":case"<=":t=i.value;break;case"<":t=i.value,e=!1;break;case"!=":case"not-in":t=Ln}ur({value:r,inclusive:s},{value:t,inclusive:e})>0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];ur({value:r,inclusive:s},{value:t,inclusive:n.inclusive})>0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}class Kr{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"F",o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function Gr(t,e,n,r,s,i,o,a){return new Kr(t,e,n,r,s,i,o,a)}function $r(t){return new Kr(t)}function Qr(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function Hr(t){return null!==t.collectionGroup}function Wr(t){const e=O(t);if(null===e.he){e.he=[];const t=new Set;for(const s of e.explicitOrderBy)e.he.push(s),t.add(s.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc",r=function(t){let e=new fn(ht.comparator);return t.filters.forEach((t=>{t.getFlattenedFilters().forEach((t=>{t.isInequality()&&(e=e.add(t.field))}))})),e}(e);r.forEach((r=>{t.has(r.canonicalString())||r.isKeyField()||e.he.push(new mr(r,n))})),t.has(ht.keyField().canonicalString())||e.he.push(new mr(ht.keyField(),n))}return e.he}function Yr(t){const e=O(t);return e.Pe||(e.Pe=Jr(e,Wr(t))),e.Pe}function Xr(t){const e=O(t);return e.Te||(e.Te=Jr(e,t.explicitOrderBy)),e.Te}function Jr(t,e){if("F"===t.limitType)return Fr(t.path,t.collectionGroup,e,t.filters,t.limit,t.startAt,t.endAt);{e=e.map((t=>{const e="desc"===t.dir?"asc":"desc";return new mr(t.field,e)}));const n=t.endAt?new dr(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new dr(t.startAt.position,t.startAt.inclusive):null;return Fr(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}}function Zr(t,e){const n=t.filters.concat([e]);return new Kr(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function ts(t,e,n){return new Kr(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function es(t,e){return Ur(Yr(t),Yr(e))&&t.limitType===e.limitType}function ns(t){return`${Vr(Yr(t))}|lt:${t.limitType}`}function rs(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>Cr(t))).join(", ")}]`),Gt(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>$n(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>$n(t))).join(",")),`Target(${e})`}(Yr(t))}; limitType=${t.limitType})`}function ss(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):dt.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of Wr(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const r=fr(t,e,n);return t.inclusive?r<=0:r<0}(t.startAt,Wr(t),e))&&!(t.endAt&&!function(t,e,n){const r=fr(t,e,n);return t.inclusive?r>=0:r>0}(t.endAt,Wr(t),e))}(t,e)}function is(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function os(t){return(e,n)=>{let r=!1;for(const s of Wr(t)){const t=as(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function as(t,e,n){const r=t.field.isKeyField()?dt.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?jn(r,s):R()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return R()}}class us{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return this.inner[n]=[[t,e]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],t))return void(r[s]=[t,e]);r.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(t){an(this.inner,((e,n)=>{for(const[r,s]of n)t(r,s)}))}isEmpty(){return cn(this.inner)}size(){return this.innerSize}}const cs=new ln(dt.comparator);function ls(){return cs}const hs=new ln(dt.comparator);function ds(){let t=hs;for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(const s of n)t=t.insert(s.key,s);return t}function fs(t){let e=hs;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function gs(){return ps()}function ms(){return ps()}function ps(){return new us((t=>t.toString()),((t,e)=>t.isEqual(e)))}const ys=new ln(dt.comparator),ws=new fn(dt.comparator);function vs(){let t=ws;for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(const s of n)t=t.add(s);return t}const bs=new fn(X);function Is(){return bs}function Ts(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:$t(e)?"-0":e}}function _s(t){return{integerValue:""+t}}function Es(t,e){return Qt(e)?_s(e):Ts(t,e)}class Ss{constructor(){this._=void 0}}function xs(t,e,n){return t instanceof Ds?function(t,e){const n={fields:{[Sn]:{stringValue:En},[Cn]:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&An(e)&&(e=Dn(e)),e&&(n.fields[xn]=e),{mapValue:n}}(n,e):t instanceof ks?Ns(t,e):t instanceof Rs?Ms(t,e):function(t,e){const n=As(t,e),r=Os(n)+Os(t.Ie);return Yn(n)&&Yn(t.Ie)?_s(r):Ts(t.serializer,r)}(t,e)}function Cs(t,e,n){return t instanceof ks?Ns(t,e):t instanceof Rs?Ms(t,e):n}function As(t,e){return t instanceof Ps?function(t){return Yn(t)||function(t){return!!t&&"doubleValue"in t}(t)}(e)?e:{integerValue:0}:null}class Ds extends Ss{}class ks extends Ss{constructor(t){super(),this.elements=t}}function Ns(t,e){const n=Ls(e);for(const r of t.elements)n.some((t=>Bn(t,r)))||n.push(r);return{arrayValue:{values:n}}}class Rs extends Ss{constructor(t){super(),this.elements=t}}function Ms(t,e){let n=Ls(e);for(const r of t.elements)n=n.filter((t=>!Bn(t,r)));return{arrayValue:{values:n}}}class Ps extends Ss{constructor(t,e){super(),this.serializer=t,this.Ie=e}}function Os(t){return Tn(t.integerValue||t.doubleValue)}function Ls(t){return Xn(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Fs{constructor(t,e){this.field=t,this.transform=e}}class Vs{constructor(t,e){this.version=t,this.transformResults=e}}class Us{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Us}static exists(t){return new Us(void 0,t)}static updateTime(t){return new Us(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function qs(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Bs{}function zs(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Js(t.key,Us.none()):new Qs(t.key,t.data,Us.none());{const n=t.data,r=cr.empty();let s=new fn(ht.comparator);for(let t of e.fields)if(!s.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?r.delete(t):r.set(t,e),s=s.add(t)}return new Hs(t.key,r,new pn(s.toArray()),Us.none())}}function js(t,e,n){t instanceof Qs?function(t,e,n){const r=t.value.clone(),s=Ys(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Hs?function(t,e,n){if(!qs(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Ys(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Ws(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ks(t,e,n,r){return t instanceof Qs?function(t,e,n,r){if(!qs(t.precondition,e))return n;const s=t.value.clone(),i=Xs(t.fieldTransforms,r,e);return s.setAll(i),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null}(t,e,n,r):t instanceof Hs?function(t,e,n,r){if(!qs(t.precondition,e))return n;const s=Xs(t.fieldTransforms,r,e),i=e.data;return i.setAll(Ws(t)),i.setAll(s),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,r):function(t,e,n){return qs(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Gs(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=As(r.transform,t||null);null!=s&&(null===n&&(n=cr.empty()),n.set(r.field,s))}return n||null}function $s(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&et(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof ks&&e instanceof ks||t instanceof Rs&&e instanceof Rs?et(t.elements,e.elements,Bn):t instanceof Ps&&e instanceof Ps?Bn(t.Ie,e.Ie):t instanceof Ds&&e instanceof Ds}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Qs extends Bs{constructor(t,e,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Hs extends Bs{constructor(t,e,n,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Ws(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Ys(t,e,n){const r=new Map;M(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,Cs(o,a,n[s]))}return r}function Xs(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,xs(t,i,e))}return r}class Js extends Bs{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Zs extends Bs{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class ti{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let r=0;r<this.mutations.length;r++){const e=this.mutations[r];e.key.isEqual(t.key)&&js(e,t,n[r])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ks(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Ks(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=ms();return this.mutations.forEach((r=>{const s=t.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=e.has(r.key)?null:o;const a=zs(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(ot.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),vs())}isEqual(t){return this.batchId===t.batchId&&et(this.mutations,t.mutations,((t,e)=>$s(t,e)))&&et(this.baseMutations,t.baseMutations,((t,e)=>$s(t,e)))}}class ei{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){M(t.mutations.length===n.length);let r=ys;const s=t.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new ei(t,e,n,r)}}class ni{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class ri{constructor(t,e,n){this.alias=t,this.aggregateType=e,this.fieldPath=n}}class si{constructor(t,e){this.count=t,this.unchangedNames=e}}var ii,oi;function ai(t){switch(t){case L.OK:return R();case L.CANCELLED:case L.UNKNOWN:case L.DEADLINE_EXCEEDED:case L.RESOURCE_EXHAUSTED:case L.INTERNAL:case L.UNAVAILABLE:case L.UNAUTHENTICATED:return!1;case L.INVALID_ARGUMENT:case L.NOT_FOUND:case L.ALREADY_EXISTS:case L.PERMISSION_DENIED:case L.FAILED_PRECONDITION:case L.ABORTED:case L.OUT_OF_RANGE:case L.UNIMPLEMENTED:case L.DATA_LOSS:return!0;default:return R()}}function ui(t){if(void 0===t)return D("GRPC error has no .code"),L.UNKNOWN;switch(t){case ii.OK:return L.OK;case ii.CANCELLED:return L.CANCELLED;case ii.UNKNOWN:return L.UNKNOWN;case ii.DEADLINE_EXCEEDED:return L.DEADLINE_EXCEEDED;case ii.RESOURCE_EXHAUSTED:return L.RESOURCE_EXHAUSTED;case ii.INTERNAL:return L.INTERNAL;case ii.UNAVAILABLE:return L.UNAVAILABLE;case ii.UNAUTHENTICATED:return L.UNAUTHENTICATED;case ii.INVALID_ARGUMENT:return L.INVALID_ARGUMENT;case ii.NOT_FOUND:return L.NOT_FOUND;case ii.ALREADY_EXISTS:return L.ALREADY_EXISTS;case ii.PERMISSION_DENIED:return L.PERMISSION_DENIED;case ii.FAILED_PRECONDITION:return L.FAILED_PRECONDITION;case ii.ABORTED:return L.ABORTED;case ii.OUT_OF_RANGE:return L.OUT_OF_RANGE;case ii.UNIMPLEMENTED:return L.UNIMPLEMENTED;case ii.DATA_LOSS:return L.DATA_LOSS;default:return R()}}(oi=ii||(ii={}))[oi.OK=0]="OK",oi[oi.CANCELLED=1]="CANCELLED",oi[oi.UNKNOWN=2]="UNKNOWN",oi[oi.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",oi[oi.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",oi[oi.NOT_FOUND=5]="NOT_FOUND",oi[oi.ALREADY_EXISTS=6]="ALREADY_EXISTS",oi[oi.PERMISSION_DENIED=7]="PERMISSION_DENIED",oi[oi.UNAUTHENTICATED=16]="UNAUTHENTICATED",oi[oi.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",oi[oi.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",oi[oi.ABORTED=10]="ABORTED",oi[oi.OUT_OF_RANGE=11]="OUT_OF_RANGE",oi[oi.UNIMPLEMENTED=12]="UNIMPLEMENTED",oi[oi.INTERNAL=13]="INTERNAL",oi[oi.UNAVAILABLE=14]="UNAVAILABLE",oi[oi.DATA_LOSS=15]="DATA_LOSS";let ci=null;const li=new r([4294967295,4294967295],0);function hi(t){const e=W().encode(t),n=new s;return n.update(e),new Uint8Array(n.digest())}function di(t){const e=new DataView(t.buffer),n=e.getUint32(0,!0),s=e.getUint32(4,!0),i=e.getUint32(8,!0),o=e.getUint32(12,!0);return[new r([n,s],0),new r([i,o],0)]}class fi{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new gi(`Invalid padding: ${e}`);if(n<0)throw new gi(`Invalid hash count: ${n}`);if(t.length>0&&0===this.hashCount)throw new gi(`Invalid hash count: ${n}`);if(0===t.length&&0!==e)throw new gi(`Invalid padding when bitmap length is 0: ${e}`);this.Ee=8*t.length-e,this.de=r.fromNumber(this.Ee)}Ae(t,e,n){let s=t.add(e.multiply(r.fromNumber(n)));return 1===s.compare(li)&&(s=new r([s.getBits(0),s.getBits(1)],0)),s.modulo(this.de).toNumber()}Re(t){return!!(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(0===this.Ee)return!1;const e=hi(t),[n,r]=di(e);for(let s=0;s<this.hashCount;s++){const t=this.Ae(n,r,s);if(!this.Re(t))return!1}return!0}static create(t,e,n){const r=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),i=new fi(s,r,e);return n.forEach((t=>i.insert(t))),i}insert(t){if(0===this.Ee)return;const e=hi(t),[n,r]=di(e);for(let s=0;s<this.hashCount;s++){const t=this.Ae(n,r,s);this.Ve(t)}}Ve(t){const e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}}class gi extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class mi{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const r=new Map;return r.set(t,pi.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new mi(ot.min(),r,new ln(X),ls(),vs())}}class pi{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new pi(n,e,vs(),vs(),vs())}}class yi{constructor(t,e,n,r){this.me=t,this.removedTargetIds=e,this.key=n,this.fe=r}}class wi{constructor(t,e){this.targetId=t,this.ge=e}}class vi{constructor(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vn.EMPTY_BYTE_STRING,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class bi{constructor(){this.pe=0,this.ye=_i(),this.we=vn.EMPTY_BYTE_STRING,this.Se=!1,this.be=!0}get current(){return this.Se}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.be}Ce(t){t.approximateByteSize()>0&&(this.be=!0,this.we=t)}Fe(){let t=vs(),e=vs(),n=vs();return this.ye.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:R()}})),new pi(this.we,this.Se,t,e,n)}Me(){this.be=!1,this.ye=_i()}xe(t,e){this.be=!0,this.ye=this.ye.insert(t,e)}Oe(t){this.be=!0,this.ye=this.ye.remove(t)}Ne(){this.pe+=1}Be(){this.pe-=1,M(this.pe>=0)}Le(){this.be=!0,this.Se=!0}}class Ii{constructor(t){this.ke=t,this.qe=new Map,this.Qe=ls(),this.$e=Ti(),this.Ue=Ti(),this.Ke=new ln(X)}We(t){for(const e of t.me)t.fe&&t.fe.isFoundDocument()?this.Ge(e,t.fe):this.ze(e,t.key,t.fe);for(const e of t.removedTargetIds)this.ze(e,t.key,t.fe)}je(t){this.forEachTarget(t,(e=>{const n=this.He(e);switch(t.state){case 0:this.Je(e)&&n.Ce(t.resumeToken);break;case 1:n.Be(),n.De||n.Me(),n.Ce(t.resumeToken);break;case 2:n.Be(),n.De||this.removeTarget(e);break;case 3:this.Je(e)&&(n.Le(),n.Ce(t.resumeToken));break;case 4:this.Je(e)&&(this.Ye(e),n.Ce(t.resumeToken));break;default:R()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.qe.forEach(((t,n)=>{this.Je(n)&&e(n)}))}Ze(t){const e=t.targetId,n=t.ge.count,r=this.Xe(e);if(r){const s=r.target;if(qr(s))if(0===n){const t=new dt(s.path);this.ze(e,t,hr.newNoDocument(t,ot.min()))}else M(1===n);else{const r=this.et(e);if(r!==n){const n=this.tt(t),s=n?this.nt(n,t,r):1;if(0!==s){this.Ye(e);const t=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(e,t)}null==ci||ci.rt(function(t,e,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:t,existenceFilterCount:e.count,databaseId:n.database,projectId:n.projectId},d=e.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:t=>{var e;return null!==(e=null==r?void 0:r.mightContain(t))&&void 0!==e&&e}}),h}(r,t.ge,this.ke.it(),n,s))}}}}tt(t){const e=t.ge.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=e;let i,o;try{i=_n(n).toUint8Array()}catch(t){if(t instanceof yn)return k("Decoding the base64 bloom filter in existence filter failed ("+t.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw t}try{o=new fi(i,r,s)}catch(t){return k(t instanceof gi?"BloomFilter error: ":"Applying bloom filter failed: ",t),null}return 0===o.Ee?null:o}nt(t,e,n){return e.ge.count===n-this.st(t,e.targetId)?0:2}st(t,e){const n=this.ke.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const s=this.ke.it(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;t.mightContain(i)||(this.ze(e,n,null),r++)})),r}ot(t){const e=new Map;this.qe.forEach(((n,r)=>{const s=this.Xe(r);if(s){if(n.current&&qr(s.target)){const e=new dt(s.target.path);this._t(e).has(r)||this.ut(r,e)||this.ze(r,e,hr.newNoDocument(e,t))}n.ve&&(e.set(r,n.Fe()),n.Me())}}));let n=vs();this.Ue.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.Xe(t);return!e||"TargetPurposeLimboResolution"===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))})),this.Qe.forEach(((e,n)=>n.setReadTime(t)));const r=new mi(t,e,this.Ke,this.Qe,n);return this.Qe=ls(),this.$e=Ti(),this.Ue=Ti(),this.Ke=new ln(X),r}Ge(t,e){if(!this.Je(t))return;const n=this.ut(t,e.key)?2:0;this.He(t).xe(e.key,n),this.Qe=this.Qe.insert(e.key,e),this.$e=this.$e.insert(e.key,this._t(e.key).add(t)),this.Ue=this.Ue.insert(e.key,this.ct(e.key).add(t))}ze(t,e,n){if(!this.Je(t))return;const r=this.He(t);this.ut(t,e)?r.xe(e,1):r.Oe(e),this.Ue=this.Ue.insert(e,this.ct(e).delete(t)),this.Ue=this.Ue.insert(e,this.ct(e).add(t)),n&&(this.Qe=this.Qe.insert(e,n))}removeTarget(t){this.qe.delete(t)}et(t){const e=this.He(t).Fe();return this.ke.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Ne(t){this.He(t).Ne()}He(t){let e=this.qe.get(t);return e||(e=new bi,this.qe.set(t,e)),e}ct(t){let e=this.Ue.get(t);return e||(e=new fn(X),this.Ue=this.Ue.insert(t,e)),e}_t(t){let e=this.$e.get(t);return e||(e=new fn(X),this.$e=this.$e.insert(t,e)),e}Je(t){const e=null!==this.Xe(t);return e||A("WatchChangeAggregator","Detected inactive target",t),e}Xe(t){const e=this.qe.get(t);return e&&e.De?null:this.ke.lt(t)}Ye(t){this.qe.set(t,new bi),this.ke.getRemoteKeysForTarget(t).forEach((e=>{this.ze(t,e,null)}))}ut(t,e){return this.ke.getRemoteKeysForTarget(t).has(e)}}function Ti(){return new ln(dt.comparator)}function _i(){return new ln(dt.comparator)}const Ei={asc:"ASCENDING",desc:"DESCENDING"},Si={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},xi={and:"AND",or:"OR"};class Ci{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Ai(t,e){return t.useProto3Json||Gt(e)?e:{value:e}}function Di(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function ki(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function Ni(t,e){return Di(t,e.toTimestamp())}function Ri(t){return M(!!t),ot.fromTimestamp(function(t){const e=In(t);return new it(e.seconds,e.nanos)}(t))}function Mi(t,e){return Pi(t,e).canonicalString()}function Pi(t,e){const n=function(t){return new ct(["projects",t.projectId,"databases",t.database])}(t).child("documents");return void 0===e?n:n.child(e)}function Oi(t){const e=ct.fromString(t);return M(so(e)),e}function Li(t,e){return Mi(t.databaseId,e.path)}function Fi(t,e){const n=Oi(e);if(n.get(1)!==t.databaseId.projectId)throw new F(L.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new F(L.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new dt(Bi(n))}function Vi(t,e){return Mi(t.databaseId,e)}function Ui(t){const e=Oi(t);return 4===e.length?ct.emptyPath():Bi(e)}function qi(t){return new ct(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Bi(t){return M(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function zi(t,e,n){return{name:Li(t,e),fields:n.value.mapValue.fields}}function ji(t,e,n){const r=Fi(t,e.name),s=Ri(e.updateTime),i=e.createTime?Ri(e.createTime):ot.min(),o=new cr({mapValue:{fields:e.fields}}),a=hr.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Ki(t,e){let n;if(e instanceof Qs)n={update:zi(t,e.key,e.value)};else if(e instanceof Js)n={delete:Li(t,e.key)};else if(e instanceof Hs)n={update:zi(t,e.key,e.data),updateMask:ro(e.fieldMask)};else{if(!(e instanceof Zs))return R();n={verify:Li(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof Ds)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ks)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Rs)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Ps)return{fieldPath:e.field.canonicalString(),increment:n.Ie};throw R()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Ni(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:R()}(t,e.precondition)),n}function Gi(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Us.updateTime(Ri(t.updateTime)):void 0!==t.exists?Us.exists(t.exists):Us.none()}(e.currentDocument):Us.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)M("REQUEST_TIME"===e.setToServerValue),n=new Ds;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new ks(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Rs(t)}else"increment"in e?n=new Ps(t,e.increment):R();const r=ht.fromServerFormat(e.fieldPath);return new Fs(r,n)}(t,e))):[];if(e.update){e.update.name;const s=Fi(t,e.update.name),i=new cr({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new pn(e.map((t=>ht.fromServerFormat(t))))}(e.updateMask);return new Hs(s,i,t,n,r)}return new Qs(s,i,n,r)}if(e.delete){const r=Fi(t,e.delete);return new Js(r,n)}if(e.verify){const r=Fi(t,e.verify);return new Zs(r,n)}return R()}function $i(t,e){return{documents:[Vi(t,e.path)]}}function Qi(t,e){const n={structuredQuery:{}},r=e.path;let s;null!==e.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=Vi(t,s);const i=function(t){if(0!==t.length)return no(vr.create(t,"and"))}(e.filters);i&&(n.structuredQuery.where=i);const o=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:to(t.field),direction:Xi(t.dir)}}(t)))}(e.orderBy);o&&(n.structuredQuery.orderBy=o);const a=Ai(t,e.limit);return null!==a&&(n.structuredQuery.limit=a),e.startAt&&(n.structuredQuery.startAt=function(t){return{before:t.inclusive,values:t.position}}(e.startAt)),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),{ht:n,parent:s}}function Hi(t,e,n,r){const{ht:s,parent:i}=Qi(t,e),o={},a=[];let u=0;return n.forEach((t=>{const e=r?t.alias:"aggregate_"+u++;o[e]=t.alias,"count"===t.aggregateType?a.push({alias:e,count:{}}):"avg"===t.aggregateType?a.push({alias:e,avg:{field:to(t.fieldPath)}}):"sum"===t.aggregateType&&a.push({alias:e,sum:{field:to(t.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:a,structuredQuery:s.structuredQuery},parent:s.parent},Pt:o,parent:i}}function Wi(t){let e=Ui(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){M(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function(t){const e=Yi(t);return e instanceof vr&&Tr(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=function(t){return t.map((t=>function(t){return new mr(eo(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t)))}(n.orderBy));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,Gt(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new dr(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new dr(n,e)}(n.endAt)),Gr(e,s,o,i,a,"F",u,c)}function Yi(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=eo(t.unaryFilter.field);return wr.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=eo(t.unaryFilter.field);return wr.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=eo(t.unaryFilter.field);return wr.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=eo(t.unaryFilter.field);return wr.create(s,"!=",{nullValue:"NULL_VALUE"});default:return R()}}(t):void 0!==t.fieldFilter?function(t){return wr.create(eo(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return R()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return vr.create(t.compositeFilter.filters.map((t=>Yi(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return R()}}(t.compositeFilter.op))}(t):R()}function Xi(t){return Ei[t]}function Ji(t){return Si[t]}function Zi(t){return xi[t]}function to(t){return{fieldPath:t.canonicalString()}}function eo(t){return ht.fromServerFormat(t.fieldPath)}function no(t){return t instanceof wr?function(t){if("=="===t.op){if(Zn(t.value))return{unaryFilter:{field:to(t.field),op:"IS_NAN"}};if(Jn(t.value))return{unaryFilter:{field:to(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Zn(t.value))return{unaryFilter:{field:to(t.field),op:"IS_NOT_NAN"}};if(Jn(t.value))return{unaryFilter:{field:to(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:to(t.field),op:Ji(t.op),value:t.value}}}(t):t instanceof vr?function(t){const e=t.getFilters().map((t=>no(t)));return 1===e.length?e[0]:{compositeFilter:{op:Zi(t.op),filters:e}}}(t):R()}function ro(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function so(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class io{constructor(t,e,n,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ot.min(),i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ot.min(),o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:vn.EMPTY_BYTE_STRING,a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(t){return new io(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new io(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new io(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new io(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}class oo{constructor(t){this.Tt=t}}function ao(t,e){const n=e.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:uo(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(t,e){return{name:Li(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Di(t,e.version.toTimestamp()),createTime:Di(t,e.createTime.toTimestamp())}}(t.Tt,e);else if(e.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:co(e.version)};else{if(!e.isUnknownDocument())return R();r.unknownDocument={path:n.path.toArray(),version:co(e.version)}}return r}function uo(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function co(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function lo(t){const e=new it(t.seconds,t.nanoseconds);return ot.fromTimestamp(e)}function ho(t,e){const n=(e.baseMutations||[]).map((e=>Gi(t.Tt,e)));for(let i=0;i<e.mutations.length-1;++i){const t=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const n=e.mutations[i+1];t.updateTransforms=n.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map((e=>Gi(t.Tt,e))),s=it.fromMillis(e.localWriteTimeMs);return new ti(e.batchId,s,n,r)}function fo(t){const e=lo(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?lo(t.lastLimboFreeSnapshotVersion):ot.min();let r;return r=function(t){return void 0!==t.documents}(t.query)?function(t){return M(1===t.documents.length),Yr($r(Ui(t.documents[0])))}(t.query):function(t){return Yr(Wi(t))}(t.query),new io(r,t.targetId,"TargetPurposeListen",t.lastListenSequenceNumber,e,n,vn.fromBase64String(t.resumeToken))}function go(t,e){const n=co(e.snapshotVersion),r=co(e.lastLimboFreeSnapshotVersion);let s;s=qr(e.target)?$i(t.Tt,e.target):Qi(t.Tt,e.target).ht;const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Vr(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function mo(t){const e=Wi({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?ts(e,e.limit,"L"):e}function po(t,e){return new ni(e.largestBatchId,Gi(t.Tt,e.overlayMutation))}function yo(t,e){const n=e.path.lastSegment();return[t,Wt(e.path.popLast()),n]}function wo(t,e,n,r){return{indexId:t,uid:e,sequenceNumber:n,readTime:co(r.readTime),documentKey:Wt(r.documentKey.path),largestBatchId:r.largestBatchId}}class vo{getBundleMetadata(t,e){return bo(t).get(e).next((t=>{if(t)return function(t){return{id:t.bundleId,createTime:lo(t.createTime),version:t.version}}(t)}))}saveBundleMetadata(t,e){return bo(t).put(function(t){return{bundleId:t.id,createTime:co(Ri(t.createTime)),version:t.version}}(e))}getNamedQuery(t,e){return Io(t).get(e).next((t=>{if(t)return function(t){return{name:t.name,query:mo(t.bundledQuery),readTime:lo(t.readTime)}}(t)}))}saveNamedQuery(t,e){return Io(t).put(function(t){return{name:t.name,readTime:co(Ri(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function bo(t){return sn(t,Ne)}function Io(t){return sn(t,Re)}class To{constructor(t,e){this.serializer=t,this.userId=e}static It(t,e){const n=e.uid||"";return new To(t,n)}getOverlay(t,e){return _o(t).get(yo(this.userId,e)).next((t=>t?po(this.serializer,t):null))}getOverlays(t,e){const n=gs();return At.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const r=[];return n.forEach(((n,s)=>{const i=new ni(e,s);r.push(this.Et(t,i))})),At.waitFor(r)}removeOverlaysForBatchId(t,e,n){const r=new Set;e.forEach((t=>r.add(Wt(t.getCollectionPath()))));const s=[];return r.forEach((e=>{const r=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(_o(t).J(Ge,r))})),At.waitFor(s)}getOverlaysForCollection(t,e,n){const r=gs(),s=Wt(e),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return _o(t).G(Ge,i).next((t=>{for(const e of t){const t=po(this.serializer,e);r.set(t.getKey(),t)}return r}))}getOverlaysForCollectionGroup(t,e,n,r){const s=gs();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return _o(t).Z({index:Qe,range:o},((t,e,n)=>{const o=po(this.serializer,e);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}Et(t,e){return _o(t).put(function(t,e,n){const[r,s,i]=yo(e,n.mutation.key);return{userId:e,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ki(t.Tt,n.mutation)}}(this.serializer,this.userId,e))}}function _o(t){return sn(t,je)}class Eo{dt(t){return sn(t,We)}getSessionToken(t){return this.dt(t).get("sessionToken").next((t=>{const e=null==t?void 0:t.value;return e?vn.fromUint8Array(e):vn.EMPTY_BYTE_STRING}))}setSessionToken(t,e){return this.dt(t).put({name:"sessionToken",value:e.toUint8Array()})}}class So{constructor(){}At(t,e){this.Rt(t,e),e.Vt()}Rt(t,e){if("nullValue"in t)this.ft(e,5);else if("booleanValue"in t)this.ft(e,10),e.gt(t.booleanValue?1:0);else if("integerValue"in t)this.ft(e,15),e.gt(Tn(t.integerValue));else if("doubleValue"in t){const n=Tn(t.doubleValue);isNaN(n)?this.ft(e,13):(this.ft(e,15),$t(n)?e.gt(0):e.gt(n))}else if("timestampValue"in t){let n=t.timestampValue;this.ft(e,20),"string"==typeof n&&(n=In(n)),e.yt(`${n.seconds||""}`),e.gt(n.nanos||0)}else if("stringValue"in t)this.wt(t.stringValue,e),this.St(e);else if("bytesValue"in t)this.ft(e,30),e.bt(_n(t.bytesValue)),this.St(e);else if("referenceValue"in t)this.Dt(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ft(e,45),e.gt(n.latitude||0),e.gt(n.longitude||0)}else"mapValue"in t?rr(t)?this.ft(e,Number.MAX_SAFE_INTEGER):er(t)?this.vt(t.mapValue,e):(this.Ct(t.mapValue,e),this.St(e)):"arrayValue"in t?(this.Ft(t.arrayValue,e),this.St(e)):R()}wt(t,e){this.ft(e,25),this.Mt(t,e)}Mt(t,e){e.yt(t)}Ct(t,e){const n=t.fields||{};this.ft(e,55);for(const r of Object.keys(n))this.wt(r,e),this.Rt(n[r],e)}vt(t,e){var n,r;const s=t.fields||{};this.ft(e,53);const i=Vn,o=(null===(r=null===(n=s[i].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.ft(e,15),e.gt(Tn(o)),this.wt(i,e),this.Rt(s[i],e)}Ft(t,e){const n=t.values||[];this.ft(e,50);for(const r of n)this.Rt(r,e)}Dt(t,e){this.ft(e,37),dt.fromName(t).path.forEach((t=>{this.ft(e,60),this.Mt(t,e)}))}ft(t,e){t.gt(e)}St(t){t.gt(2)}}So.xt=new So;const xo=255;function Co(t){if(0===t)return 8;let e=0;return t>>4||(e+=4,t<<=4),t>>6||(e+=2,t<<=2),t>>7||(e+=1),e}function Ao(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const r=Co(255&t[n]);if(e+=r,8!==r)break}return e}(t);return Math.ceil(e/8)}class Do{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Nt(n.value),n=e.next();this.Bt()}Lt(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.kt(n.value),n=e.next();this.qt()}Qt(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Nt(t);else if(t<2048)this.Nt(960|t>>>6),this.Nt(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Nt(480|t>>>12),this.Nt(128|63&t>>>6),this.Nt(128|63&t);else{const t=e.codePointAt(0);this.Nt(240|t>>>18),this.Nt(128|63&t>>>12),this.Nt(128|63&t>>>6),this.Nt(128|63&t)}}this.Bt()}$t(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.kt(t);else if(t<2048)this.kt(960|t>>>6),this.kt(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.kt(480|t>>>12),this.kt(128|63&t>>>6),this.kt(128|63&t);else{const t=e.codePointAt(0);this.kt(240|t>>>18),this.kt(128|63&t>>>12),this.kt(128|63&t>>>6),this.kt(128|63&t)}}this.qt()}Ut(t){const e=this.Kt(t),n=Ao(e);this.Wt(1+n),this.buffer[this.position++]=255&n;for(let r=e.length-n;r<e.length;++r)this.buffer[this.position++]=255&e[r]}Gt(t){const e=this.Kt(t),n=Ao(e);this.Wt(1+n),this.buffer[this.position++]=~(255&n);for(let r=e.length-n;r<e.length;++r)this.buffer[this.position++]=~(255&e[r])}zt(){this.jt(xo),this.jt(255)}Ht(){this.Jt(xo),this.Jt(255)}reset(){this.position=0}seed(t){this.Wt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Yt(){return this.buffer.slice(0,this.position)}Kt(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=!!(128&e[0]);e[0]^=n?255:128;for(let r=1;r<e.length;++r)e[r]^=n?255:0;return e}Nt(t){const e=255&t;0===e?(this.jt(0),this.jt(255)):e===xo?(this.jt(xo),this.jt(0)):this.jt(e)}kt(t){const e=255&t;0===e?(this.Jt(0),this.Jt(255)):e===xo?(this.Jt(xo),this.Jt(0)):this.Jt(t)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(t){this.Wt(1),this.buffer[this.position++]=t}Jt(t){this.Wt(1),this.buffer[this.position++]=~t}Wt(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class ko{constructor(t){this.Zt=t}bt(t){this.Zt.Ot(t)}yt(t){this.Zt.Qt(t)}gt(t){this.Zt.Ut(t)}Vt(){this.Zt.zt()}}class No{constructor(t){this.Zt=t}bt(t){this.Zt.Lt(t)}yt(t){this.Zt.$t(t)}gt(t){this.Zt.Gt(t)}Vt(){this.Zt.Ht()}}class Ro{constructor(){this.Zt=new Do,this.Xt=new ko(this.Zt),this.en=new No(this.Zt)}seed(t){this.Zt.seed(t)}tn(t){return 0===t?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class Mo{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}nn(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new Mo(this.indexId,this.documentKey,this.arrayValue,n)}}function Po(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Oo(t.arrayValue,e.arrayValue),0!==n?n:(n=Oo(t.directionalValue,e.directionalValue),0!==n?n:dt.comparator(t.documentKey,e.documentKey)))}function Oo(t,e){for(let n=0;n<t.length&&n<e.length;++n){const r=t[n]-e[n];if(0!==r)return r}return t.length-e.length}class Lo{constructor(t){this.rn=new fn(((t,e)=>ht.comparator(t.field,e.field))),this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.sn=t.orderBy,this._n=[];for(const e of t.filters){const t=e;t.isInequality()?this.rn=this.rn.add(t):this._n.push(t)}}get an(){return this.rn.size>1}un(t){if(M(t.collectionGroup===this.collectionId),this.an)return!1;const e=mt(t);if(void 0!==e&&!this.cn(e))return!1;const n=pt(t);let r=new Set,s=0,i=0;for(;s<n.length&&this.cn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.rn.size>0){const t=this.rn.getIterator().getNext();if(!r.has(t.field.canonicalString())){const e=n[s];if(!this.ln(t,e)||!this.hn(this.sn[i++],e))return!1}++s}for(;s<n.length;++s){const t=n[s];if(i>=this.sn.length||!this.hn(this.sn[i++],t))return!1}return!0}Pn(){if(this.an)return null;let t=new fn(ht.comparator);const e=[];for(const n of this._n)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)e.push(new wt(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new wt(n.field,0))}for(const n of this.sn)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new wt(n.field,"asc"===n.dir?0:1)));return new gt(gt.UNKNOWN_ID,this.collectionId,e,bt.empty())}cn(t){for(const e of this._n)if(this.ln(e,t))return!0;return!1}ln(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}hn(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function Fo(t){var e,n;if(M(t instanceof wr||t instanceof vr),t instanceof wr){if(t instanceof Mr){const r=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>wr.create(t.field,"==",e))))||[];return vr.create(r,"or")}return t}const r=t.filters.map((t=>Fo(t)));return vr.create(r,t.op)}function Vo(t){if(0===t.getFilters().length)return[];const e=zo(Fo(t));return M(Bo(e)),Uo(e)||qo(e)?[e]:e.getFilters()}function Uo(t){return t instanceof wr}function qo(t){return t instanceof vr&&Tr(t)}function Bo(t){return Uo(t)||qo(t)||function(t){if(t instanceof vr&&Ir(t)){for(const e of t.getFilters())if(!Uo(e)&&!qo(e))return!1;return!0}return!1}(t)}function zo(t){if(M(t instanceof wr||t instanceof vr),t instanceof wr)return t;if(1===t.filters.length)return zo(t.filters[0]);const e=t.filters.map((t=>zo(t)));let n=vr.create(e,t.op);return n=Go(n),Bo(n)?n:(M(n instanceof vr),M(br(n)),M(n.filters.length>1),n.filters.reduce(((t,e)=>jo(t,e))))}function jo(t,e){let n;return M(t instanceof wr||t instanceof vr),M(e instanceof wr||e instanceof vr),n=t instanceof wr?e instanceof wr?function(t,e){return vr.create([t,e],"and")}(t,e):Ko(t,e):e instanceof wr?Ko(e,t):function(t,e){if(M(t.filters.length>0&&e.filters.length>0),br(t)&&br(e))return xr(t,e.getFilters());const n=Ir(t)?t:e,r=Ir(t)?e:t,s=n.filters.map((t=>jo(t,r)));return vr.create(s,"or")}(t,e),Go(n)}function Ko(t,e){if(br(e))return xr(e,t.getFilters());{const n=e.filters.map((e=>jo(t,e)));return vr.create(n,"or")}}function Go(t){if(M(t instanceof wr||t instanceof vr),t instanceof wr)return t;const e=t.getFilters();if(1===e.length)return Go(e[0]);if(_r(t))return t;const n=e.map((t=>Go(t))),r=[];return n.forEach((e=>{e instanceof wr?r.push(e):e instanceof vr&&(e.op===t.op?r.push(...e.filters):r.push(e))})),1===r.length?r[0]:vr.create(r,t.op)}class $o{constructor(){this.Tn=new Qo}addToCollectionParentIndex(t,e){return this.Tn.add(e),At.resolve()}getCollectionParents(t,e){return At.resolve(this.Tn.getEntries(e))}addFieldIndex(t,e){return At.resolve()}deleteFieldIndex(t,e){return At.resolve()}deleteAllFieldIndexes(t){return At.resolve()}createTargetIndexes(t,e){return At.resolve()}getDocumentsMatchingTarget(t,e){return At.resolve(null)}getIndexType(t,e){return At.resolve(0)}getFieldIndexes(t,e){return At.resolve([])}getNextCollectionGroupToUpdate(t){return At.resolve(null)}getMinOffset(t,e){return At.resolve(_t.min())}getMinOffsetFromCollectionGroup(t,e){return At.resolve(_t.min())}updateCollectionGroup(t,e,n){return At.resolve()}updateIndexEntries(t,e){return At.resolve()}}class Qo{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new fn(ct.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new fn(ct.comparator)).toArray()}}const Ho="IndexedDbIndexManager",Wo=new Uint8Array(0);class Yo{constructor(t,e){this.databaseId=e,this.In=new Qo,this.En=new us((t=>Vr(t)),((t,e)=>Ur(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.In.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.In.add(e)}));const s={collectionId:n,parent:Wt(r)};return Xo(t).put(s)}return At.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[nt(e),""],!1,!0);return Xo(t).G(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(Jt(r.parent))}return n}))}addFieldIndex(t,e){const n=Zo(t),r=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete r.indexId;const s=n.add(r);if(e.indexState){const n=ta(t);return s.next((t=>{n.put(wo(t,this.uid,e.indexState.sequenceNumber,e.indexState.offset))}))}return s.next()}deleteFieldIndex(t,e){const n=Zo(t),r=ta(t),s=Jo(t);return n.delete(e.indexId).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}deleteAllFieldIndexes(t){const e=Zo(t),n=Jo(t),r=ta(t);return e.J().next((()=>n.J())).next((()=>r.J()))}createTargetIndexes(t,e){return At.forEach(this.dn(e),(e=>this.getIndexType(t,e).next((n=>{if(0===n||1===n){const n=new Lo(e).Pn();if(null!=n)return this.addFieldIndex(t,n)}}))))}getDocumentsMatchingTarget(t,e){const n=Jo(t);let r=!0;const s=new Map;return At.forEach(this.dn(e),(e=>this.An(t,e).next((t=>{r&&(r=!!t),s.set(e,t)})))).next((()=>{if(r){let t=vs();const r=[];return At.forEach(s,((s,i)=>{A(Ho,`Using index ${function(t){return`id=${t.indexId}|cg=${t.collectionGroup}|f=${t.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`}(s)} to execute ${Vr(e)}`);const o=function(t,e){const n=mt(e);if(void 0===n)return null;for(const r of Br(t,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),a=function(t,e){const n=new Map;for(const r of pt(e))for(const e of Br(t,r.fieldPath))switch(e.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,s),u=function(t,e){const n=[];let r=!0;for(const s of pt(e)){const e=0===s.kind?zr(t,s.fieldPath,t.startAt):jr(t,s.fieldPath,t.startAt);n.push(e.value),r&&(r=e.inclusive)}return new dr(n,r)}(i,s),c=function(t,e){const n=[];let r=!0;for(const s of pt(e)){const e=0===s.kind?jr(t,s.fieldPath,t.endAt):zr(t,s.fieldPath,t.endAt);n.push(e.value),r&&(r=e.inclusive)}return new dr(n,r)}(i,s),l=this.Rn(s,i,u),h=this.Rn(s,i,c),d=this.Vn(s,i,a),f=this.mn(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return At.forEach(f,(s=>n.H(s,e.limit).next((e=>{e.forEach((e=>{const n=dt.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),r.push(n))}))}))))})).next((()=>r))}return At.resolve(null)}))}dn(t){let e=this.En.get(t);return e||(e=0===t.filters.length?[t]:Vo(vr.create(t.filters,"and")).map((e=>Fr(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.En.set(t,e),e)}mn(t,e,n,r,s,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,s.length),u=a/(null!=e?e.length:1),c=[];for(let l=0;l<a;++l){const a=e?this.fn(e[l/u]):Wo,h=this.gn(t,a,n[l%u],r),d=this.pn(t,a,s[l%u],i),f=o.map((e=>this.gn(t,a,e,!0)));c.push(...this.createRange(h,d,f))}return c}gn(t,e,n,r){const s=new Mo(t,dt.empty(),e,n);return r?s:s.nn()}pn(t,e,n,r){const s=new Mo(t,dt.empty(),e,n);return r?s.nn():s}An(t,e){const n=new Lo(e),r=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,r).next((t=>{let e=null;for(const r of t)n.un(r)&&(!e||r.fields.length>e.fields.length)&&(e=r);return e}))}getIndexType(t,e){let n=2;const r=this.dn(e);return At.forEach(r,(e=>this.An(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new fn(ht.comparator),n=!1;for(const r of t.filters)for(const t of r.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const r of t.orderBy)r.field.isKeyField()||(e=e.add(r.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&r.length>1&&2===n?1:n))}yn(t,e){const n=new Ro;for(const r of pt(t)){const t=e.data.field(r.fieldPath);if(null==t)return null;const s=n.tn(r.kind);So.xt.At(t,s)}return n.Yt()}fn(t){const e=new Ro;return So.xt.At(t,e.tn(0)),e.Yt()}wn(t,e){const n=new Ro;return So.xt.At(Wn(this.databaseId,e),n.tn(function(t){const e=pt(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Yt()}Vn(t,e,n){if(null===n)return[];let r=[];r.push(new Ro);let s=0;for(const i of pt(t)){const t=n[s++];for(const n of r)if(this.Sn(e,i.fieldPath)&&Xn(t))r=this.bn(r,i,t);else{const e=n.tn(i.kind);So.xt.At(t,e)}}return this.Dn(r)}Rn(t,e,n){return this.Vn(t,e,n.position)}Dn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Yt();return e}bn(t,e,n){const r=[...t],s=[];for(const i of n.arrayValue.values||[])for(const t of r){const n=new Ro;n.seed(t.Yt()),So.xt.At(i,n.tn(e.kind)),s.push(n)}return s}Sn(t,e){return!!t.filters.find((t=>t instanceof wr&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=Zo(t),r=ta(t);return(e?n.G(Pe,IDBKeyRange.bound(e,e)):n.G()).next((t=>{const e=[];return At.forEach(t,(t=>r.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new bt(e.sequenceNumber,new _t(lo(e.readTime),new dt(Jt(e.documentKey)),e.largestBatchId)):bt.empty(),r=t.fields.map((t=>{let[e,n]=t;return new wt(ht.fromServerFormat(e),n)}));return new gt(t.indexId,t.collectionGroup,r,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:X(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const r=Zo(t),s=ta(t);return this.vn(t).next((t=>r.G(Pe,IDBKeyRange.bound(e,e)).next((e=>At.forEach(e,(e=>s.put(wo(e.indexId,this.uid,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return At.forEach(e,((e,r)=>{const s=n.get(e.collectionGroup);return(s?At.resolve(s):this.getFieldIndexes(t,e.collectionGroup)).next((s=>(n.set(e.collectionGroup,s),At.forEach(s,(n=>this.Cn(t,e,n).next((e=>{const s=this.Fn(r,n);return e.isEqual(s)?At.resolve():this.Mn(t,r,n,e,s)})))))))}))}xn(t,e,n,r){return Jo(t).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.wn(n,e.key),documentKey:e.key.path.toArray()})}On(t,e,n,r){return Jo(t).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.wn(n,e.key),e.key.path.toArray()])}Cn(t,e,n){const r=Jo(t);let s=new fn(Po);return r.Z({index:Be,range:IDBKeyRange.only([n.indexId,this.uid,this.wn(n,e)])},((t,r)=>{s=s.add(new Mo(n.indexId,e,r.arrayValue,r.directionalValue))})).next((()=>s))}Fn(t,e){let n=new fn(Po);const r=this.yn(e,t);if(null==r)return n;const s=mt(e);if(null!=s){const i=t.data.field(s.fieldPath);if(Xn(i))for(const s of i.arrayValue.values||[])n=n.add(new Mo(e.indexId,t.key,this.fn(s),r))}else n=n.add(new Mo(e.indexId,t.key,Wo,r));return n}Mn(t,e,n,r,s){A(Ho,"Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,r,s){const i=t.getIterator(),o=e.getIterator();let a=mn(i),u=mn(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const r=n(a,u);r<0?e=!0:r>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(r(u),u=mn(o)):e?(s(a),a=mn(i)):(a=mn(i),u=mn(o))}}(r,s,Po,(r=>{i.push(this.xn(t,e,n,r))}),(r=>{i.push(this.On(t,e,n,r))})),At.waitFor(i)}vn(t){let e=1;return ta(t).Z({index:Fe,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,r)=>{r.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Po(t,e))).filter(((t,e,n)=>!e||0!==Po(t,n[e-1])));const r=[];r.push(t);for(const i of n){const n=Po(i,t),s=Po(i,e);if(0===n)r[0]=t.nn();else if(n>0&&s<0)r.push(i),r.push(i.nn());else if(s>0)break}r.push(e);const s=[];for(let i=0;i<r.length;i+=2){if(this.Nn(r[i],r[i+1]))return[];const t=[r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,Wo,[]],e=[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,Wo,[]];s.push(IDBKeyRange.bound(t,e))}return s}Nn(t,e){return Po(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(ea)}getMinOffset(t,e){return At.mapArray(this.dn(e),(e=>this.An(t,e).next((t=>t||R())))).next(ea)}}function Xo(t){return sn(t,Ae)}function Jo(t){return sn(t,Ue)}function Zo(t){return sn(t,Me)}function ta(t){return sn(t,Oe)}function ea(t){M(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let r=1;r<t.length;r++){const s=t[r].indexState.offset;Et(s,e)<0&&(e=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new _t(e.readTime,e.documentKey,n)}const na={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},ra=41943040;class sa{static withCacheSize(t){return new sa(t,sa.DEFAULT_COLLECTION_PERCENTILE,sa.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}}function ia(t,e,n){const r=t.store(re),s=t.store(le),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Z({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{M(1===a)})));const c=[];for(const l of n.mutations){const t=ue(e,l.key.path,n.batchId);i.push(s.delete(t)),c.push(l.key)}return At.waitFor(i).next((()=>c))}function oa(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw R();e=t.noDocument}return JSON.stringify(e).length}sa.DEFAULT_COLLECTION_PERCENTILE=10,sa.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,sa.DEFAULT=new sa(ra,sa.DEFAULT_COLLECTION_PERCENTILE,sa.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),sa.DISABLED=new sa(-1,0,0);class aa{constructor(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.Bn={}}static It(t,e,n,r){M(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new aa(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ca(t).Z({index:ie,range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=la(t),i=ca(t);return i.add({}).next((o=>{M("number"==typeof o);const a=new ti(o,e,n,r),u=function(t,e,n){const r=n.baseMutations.map((e=>Ki(t.Tt,e))),s=n.mutations.map((e=>Ki(t.Tt,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new fn(((t,e)=>X(t.canonicalString(),e.canonicalString())));for(const t of r){const e=ue(this.userId,t.key.path,o);l=l.add(t.key.path.popLast()),c.push(i.put(u)),c.push(s.put(e,ce))}return l.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Bn[o]=a.keys()})),At.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return ca(t).get(e).next((t=>t?(M(t.userId===this.userId),ho(this.serializer,t)):null))}Ln(t,e){return this.Bn[e]?At.resolve(this.Bn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Bn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ca(t).Z({index:ie,range:r},((t,e,r)=>{e.userId===this.userId&&(M(e.batchId>=n),s=ho(this.serializer,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=Kt;return ca(t).Z({index:ie,range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,Kt],[this.userId,Number.POSITIVE_INFINITY]);return ca(t).G(ie,e).next((t=>t.map((t=>ho(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ae(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return la(t).Z({range:r},((n,r,i)=>{const[o,a,u]=n,c=Jt(a);if(o===this.userId&&e.path.isEqual(c))return ca(t).get(u).next((t=>{if(!t)throw R();M(t.userId===this.userId),s.push(ho(this.serializer,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new fn(X);const r=[];return e.forEach((e=>{const s=ae(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=la(t).Z({range:i},((t,r,s)=>{const[i,o,a]=t,u=Jt(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),At.waitFor(r).next((()=>this.kn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=ae(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new fn(X);return la(t).Z({range:i},((t,e,s)=>{const[i,a,u]=t,c=Jt(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.kn(t,o)))}kn(t,e){const n=[],r=[];return e.forEach((e=>{r.push(ca(t).get(e).next((t=>{if(null===t)throw R();M(t.userId===this.userId),n.push(ho(this.serializer,t))})))})),At.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return ia(t.ue,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.qn(e.batchId)})),At.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}qn(t){delete this.Bn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return At.resolve();const n=IDBKeyRange.lowerBound(function(t){return[t]}(this.userId)),r=[];return la(t).Z({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=Jt(t[1]);r.push(e)}else n.done()})).next((()=>{M(0===r.length)}))}))}containsKey(t,e){return ua(t,this.userId,e)}Qn(t){return ha(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:Kt,lastStreamToken:""}))}}function ua(t,e,n){const r=ae(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return la(t).Z({range:i,Y:!0},((t,n,r)=>{const[i,a,u]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function ca(t){return sn(t,re)}function la(t){return sn(t,le)}function ha(t){return sn(t,ne)}class da{constructor(t){this.$n=t}next(){return this.$n+=2,this.$n}static Un(){return new da(0)}static Kn(){return new da(-1)}}class fa{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Wn(t).next((e=>{const n=new da(e.highestTargetId);return e.highestTargetId=n.next(),this.Gn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Wn(t).next((t=>ot.fromTimestamp(new it(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Wn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Wn(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.Gn(t,r))))}addTargetData(t,e){return this.zn(t,e).next((()=>this.Wn(t).next((n=>(n.targetCount+=1,this.jn(e,n),this.Gn(t,n))))))}updateTargetData(t,e){return this.zn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>ga(t).delete(e.targetId))).next((()=>this.Wn(t))).next((e=>(M(e.targetCount>0),e.targetCount-=1,this.Gn(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return ga(t).Z(((i,o)=>{const a=fo(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>At.waitFor(s))).next((()=>r))}forEachTarget(t,e){return ga(t).Z(((t,n)=>{const r=fo(n);e(r)}))}Wn(t){return ma(t).get(xe).next((t=>(M(null!==t),t)))}Gn(t,e){return ma(t).put(xe,e)}zn(t,e){return ga(t).put(go(this.serializer,e))}jn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Wn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Vr(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return ga(t).Z({range:r,index:be},((t,n,r)=>{const i=fo(n);Ur(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=pa(t);return e.forEach((e=>{const i=Wt(e.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(t,n,e))})),At.waitFor(r)}removeMatchingKeys(t,e,n){const r=pa(t);return At.forEach(e,(e=>{const s=Wt(e.path);return At.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=pa(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=pa(t);let s=vs();return r.Z({range:n,Y:!0},((t,e,n)=>{const r=Jt(t[1]),i=new dt(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Wt(e.path),r=IDBKeyRange.bound([n],[nt(n)],!1,!0);let s=0;return pa(t).Z({index:Ee,Y:!0,range:r},((t,e,n)=>{let[r,i]=t;0!==r&&(s++,n.done())})).next((()=>s>0))}lt(t,e){return ga(t).get(e).next((t=>t?fo(t):null))}}function ga(t){return sn(t,ve)}function ma(t){return sn(t,Ce)}function pa(t){return sn(t,Te)}const ya="LruGarbageCollector",wa=1048576;function va(t,e){let[n,r]=t,[s,i]=e;const o=X(n,s);return 0===o?X(r,i):o}class ba{constructor(t){this.Hn=t,this.buffer=new fn(va),this.Jn=0}Yn(){return++this.Jn}Zn(t){const e=[t,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();va(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Ia{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(t){A(ya,`Garbage collection scheduled in ${t}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Ot(t)?A(ya,"Ignoring IndexedDB error during garbage collection: ",t):await Ct(t)}await this.er(3e5)}))}}class Ta{constructor(t,e){this.tr=t,this.params=e}calculateTargetCount(t,e){return this.tr.nr(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return At.resolve(jt.ae);const n=new ba(e);return this.tr.forEachTarget(t,(t=>n.Zn(t.sequenceNumber))).next((()=>this.tr.rr(t,(t=>n.Zn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.tr.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.tr.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(A("LruGarbageCollector","Garbage collection skipped; disabled"),At.resolve(na)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(A("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),na):this.ir(t,e)))}getCacheSize(t){return this.tr.getCacheSize(t)}ir(t,e){let n,r,s,i,o,u,c;const l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(A("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,i=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,u=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),x()<=a.$b.DEBUG&&A("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-l}ms\n\tDetermined least recently used ${r} in `+(o-i)+"ms\n"+`\tRemoved ${s} targets in `+(u-o)+"ms\n"+`\tRemoved ${t} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),At.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}function _a(t,e){return new Ta(t,e)}class Ea{constructor(t,e){this.db=t,this.garbageCollector=_a(this,e)}nr(t){const e=this.sr(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}sr(t){let e=0;return this.rr(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}rr(t,e){return this._r(t,((t,n)=>e(n)))}addReference(t,e,n){return Sa(t,n)}removeReference(t,e,n){return Sa(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Sa(t,e)}ar(t,e){return function(t,e){let n=!1;return ha(t).X((r=>ua(t,r,e).next((t=>(t&&(n=!0),At.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this._r(t,((i,o)=>{if(o<=e){const e=this.ar(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i,ot.min()),pa(t).delete(function(t){return[0,Wt(t.path)]}(i)))))}));r.push(e)}})).next((()=>At.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Sa(t,e)}_r(t,e){const n=pa(t);let r,s=jt.ae;return n.Z({index:Ee},((t,n)=>{let[i,o]=t,{path:a,sequenceNumber:u}=n;0===i?(s!==jt.ae&&e(new dt(Jt(r)),s),s=u,r=a):s=jt.ae})).next((()=>{s!==jt.ae&&e(new dt(Jt(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Sa(t,e){return pa(t).put(function(t,e){return{targetId:0,path:Wt(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class xa{constructor(){this.changes=new us((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,hr.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?At.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Ca{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Na(t).put(n)}removeEntry(t,e,n){return Na(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],uo(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.ur(t,n))))}getEntry(t,e){let n=hr.newInvalidDocument(e);return Na(t).Z({index:fe,range:IDBKeyRange.only(Ra(e))},((t,r)=>{n=this.cr(e,r)})).next((()=>n))}lr(t,e){let n={size:0,document:hr.newInvalidDocument(e)};return Na(t).Z({index:fe,range:IDBKeyRange.only(Ra(e))},((t,r)=>{n={document:this.cr(e,r),size:oa(r)}})).next((()=>n))}getEntries(t,e){let n=ls();return this.hr(t,e,((t,e)=>{const r=this.cr(t,e);n=n.insert(t,r)})).next((()=>n))}Pr(t,e){let n=ls(),r=new ln(dt.comparator);return this.hr(t,e,((t,e)=>{const s=this.cr(t,e);n=n.insert(t,s),r=r.insert(t,oa(e))})).next((()=>({documents:n,Tr:r})))}hr(t,e,n){if(e.isEmpty())return At.resolve();let r=new fn(Pa);e.forEach((t=>r=r.add(t)));const s=IDBKeyRange.bound(Ra(r.first()),Ra(r.last())),i=r.getIterator();let o=i.getNext();return Na(t).Z({index:fe,range:s},((t,e,r)=>{const s=dt.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Pa(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.W(Ra(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(t,e,n,r,s){const i=e.path,o=[i.popLast().toArray(),i.lastSegment(),uo(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Na(t).G(IDBKeyRange.bound(o,a,!0)).next((t=>{null==s||s.incrementDocumentReadCount(t.length);let n=ls();for(const s of t){const t=this.cr(dt.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);t.isFoundDocument()&&(ss(e,t)||r.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,r){let s=ls();const i=Ma(e,n),o=Ma(e,_t.max());return Na(t).Z({index:me,range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.cr(dt.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(t){return new Da(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return ka(t).get(we).next((t=>(M(!!t),t)))}ur(t,e){return ka(t).put(we,e)}cr(t,e){if(e){const t=function(t,e){let n;if(e.document)n=ji(t.Tt,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=dt.fromSegments(e.noDocument.path),r=lo(e.noDocument.readTime);n=hr.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return R();{const t=dt.fromSegments(e.unknownDocument.path),r=lo(e.unknownDocument.version);n=hr.newUnknownDocument(t,r)}}return e.readTime&&n.setReadTime(function(t){const e=new it(t[0],t[1]);return ot.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual(ot.min()))return t}return hr.newInvalidDocument(t)}}function Aa(t){return new Ca(t)}class Da extends xa{constructor(t,e){super(),this.Ir=t,this.trackRemovals=e,this.Er=new us((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new fn(((t,e)=>X(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Er.get(s);if(e.push(this.Ir.removeEntry(t,s,o.readTime)),i.isValidDocument()){const a=ao(this.Ir.serializer,i);r=r.add(s.path.popLast());const u=oa(a);n+=u-o.size,e.push(this.Ir.addEntry(t,s,a))}else if(n-=o.size,this.trackRemovals){const n=ao(this.Ir.serializer,i.convertToNoDocument(ot.min()));e.push(this.Ir.addEntry(t,s,n))}})),r.forEach((n=>{e.push(this.Ir.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Ir.updateMetadata(t,n)),At.waitFor(e)}getFromCache(t,e){return this.Ir.lr(t,e).next((t=>(this.Er.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.Ir.Pr(t,e).next((t=>{let{documents:e,Tr:n}=t;return n.forEach(((t,n)=>{this.Er.set(t,{size:n,readTime:e.get(t).readTime})})),e}))}}function ka(t){return sn(t,ye)}function Na(t){return sn(t,he)}function Ra(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Ma(t,e){const n=e.documentKey.path.toArray();return[t,uo(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Pa(t,e){const n=t.path.toArray(),r=e.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=X(n[i],r[i]),s)return s;return s=X(n.length,r.length),s||(s=X(n[n.length-2],r[r.length-2]),s||X(n[n.length-1],r[r.length-1]))}class Oa{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class La{constructor(t,e,n,r){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((r=>(n=r,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&Ks(n.mutation,t,pn.empty(),it.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,vs()).next((()=>e))))}getLocalViewOfDocuments(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vs();const r=gs();return this.populateOverlays(t,r,e).next((()=>this.computeViews(t,e,r,n).next((t=>{let e=ds();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=gs();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,vs())))}populateOverlays(t,e,n){const r=[];return n.forEach((t=>{e.has(t)||r.push(t)})),this.documentOverlayCache.getOverlays(t,r).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,r){let s=ls();const i=ps(),o=ps();return e.forEach(((t,e)=>{const o=n.get(e.key);r.has(e.key)&&(void 0===o||o.mutation instanceof Hs)?s=s.insert(e.key,e):void 0!==o?(i.set(e.key,o.mutation.getFieldMask()),Ks(o.mutation,e,o.mutation.getFieldMask(),it.now())):i.set(e.key,pn.empty())})),this.recalculateAndSaveOverlays(t,s).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Oa(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=ps();let r=new ln(((t,e)=>t-e)),s=vs();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const s of t)s.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||pn.empty();o=s.applyToLocalView(i,o),n.set(t,o);const a=(r.get(s.batchId)||vs()).add(t);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=ms();u.forEach((t=>{if(!s.has(t)){const r=zs(e.get(t),n.get(t));null!==r&&c.set(t,r),s=s.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return At.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n,r){return function(t){return dt.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Hr(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,r):this.getDocumentsMatchingCollectionQuery(t,e,n,r)}getNextDocuments(t,e,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,r-s.size):At.resolve(gs());let o=ft,a=s;return i.next((e=>At.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(e)?At.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,s))).next((()=>this.computeViews(t,a,e,vs()))).next((t=>({batchId:o,changes:fs(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new dt(e)).next((t=>{let e=ds();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n,r){const s=e.collectionGroup;let i=ds();return this.indexManager.getCollectionParents(t,s).next((o=>At.forEach(o,(o=>{const a=function(t,e){return new Kr(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,o.child(s));return this.getDocumentsMatchingCollectionQuery(t,a,n,r).next((t=>{t.forEach(((t,e)=>{i=i.insert(t,e)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(t,e,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,r)))).next((t=>{s.forEach(((e,n)=>{const r=n.getKey();null===t.get(r)&&(t=t.insert(r,hr.newInvalidDocument(r)))}));let n=ds();return t.forEach(((t,r)=>{const i=s.get(t);void 0!==i&&Ks(i.mutation,r,pn.empty(),it.now()),ss(e,r)&&(n=n.insert(t,r))})),n}))}}class Fa{constructor(t){this.serializer=t,this.dr=new Map,this.Ar=new Map}getBundleMetadata(t,e){return At.resolve(this.dr.get(e))}saveBundleMetadata(t,e){return this.dr.set(e.id,function(t){return{id:t.id,version:t.version,createTime:Ri(t.createTime)}}(e)),At.resolve()}getNamedQuery(t,e){return At.resolve(this.Ar.get(e))}saveNamedQuery(t,e){return this.Ar.set(e.name,function(t){return{name:t.name,query:mo(t.bundledQuery),readTime:Ri(t.readTime)}}(e)),At.resolve()}}class Va{constructor(){this.overlays=new ln(dt.comparator),this.Rr=new Map}getOverlay(t,e){return At.resolve(this.overlays.get(e))}getOverlays(t,e){const n=gs();return At.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,r)=>{this.Et(t,e,r)})),At.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.Rr.get(n);return void 0!==r&&(r.forEach((t=>this.overlays=this.overlays.remove(t))),this.Rr.delete(n)),At.resolve()}getOverlaysForCollection(t,e,n){const r=gs(),s=e.length+1,i=new dt(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===s&&t.largestBatchId>n&&r.set(t.getKey(),t)}return At.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new ln(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=gs(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=gs(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=r)););return At.resolve(o)}Et(t,e,n){const r=this.overlays.get(n.key);if(null!==r){const t=this.Rr.get(r.largestBatchId).delete(n.key);this.Rr.set(r.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new ni(e,n));let s=this.Rr.get(e);void 0===s&&(s=vs(),this.Rr.set(e,s)),this.Rr.set(e,s.add(n.key))}}class Ua{constructor(){this.sessionToken=vn.EMPTY_BYTE_STRING}getSessionToken(t){return At.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,At.resolve()}}class qa{constructor(){this.Vr=new fn(Ba.mr),this.gr=new fn(Ba.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(t,e){const n=new Ba(t,e);this.Vr=this.Vr.add(n),this.gr=this.gr.add(n)}yr(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.wr(new Ba(t,e))}Sr(t,e){t.forEach((t=>this.removeReference(t,e)))}br(t){const e=new dt(new ct([])),n=new Ba(e,t),r=new Ba(e,t+1),s=[];return this.gr.forEachInRange([n,r],(t=>{this.wr(t),s.push(t.key)})),s}Dr(){this.Vr.forEach((t=>this.wr(t)))}wr(t){this.Vr=this.Vr.delete(t),this.gr=this.gr.delete(t)}vr(t){const e=new dt(new ct([])),n=new Ba(e,t),r=new Ba(e,t+1);let s=vs();return this.gr.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Ba(t,0),n=this.Vr.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Ba{constructor(t,e){this.key=t,this.Cr=e}static mr(t,e){return dt.comparator(t.key,e.key)||X(t.Cr,e.Cr)}static pr(t,e){return X(t.Cr,e.Cr)||dt.comparator(t.key,e.key)}}class za{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.Fr=1,this.Mr=new fn(Ba.mr)}checkEmpty(t){return At.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,r){const s=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new ti(s,e,n,r);this.mutationQueue.push(i);for(const o of r)this.Mr=this.Mr.add(new Ba(o.key,s)),this.indexManager.addToCollectionParentIndex(t,o.key.path.popLast());return At.resolve(i)}lookupMutationBatch(t,e){return At.resolve(this.Or(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.Nr(n),s=r<0?0:r;return At.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return At.resolve(0===this.mutationQueue.length?Kt:this.Fr-1)}getAllMutationBatches(t){return At.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Ba(e,0),r=new Ba(e,Number.POSITIVE_INFINITY),s=[];return this.Mr.forEachInRange([n,r],(t=>{const e=this.Or(t.Cr);s.push(e)})),At.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new fn(X);return e.forEach((t=>{const e=new Ba(t,0),r=new Ba(t,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([e,r],(t=>{n=n.add(t.Cr)}))})),At.resolve(this.Br(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;dt.isDocumentKey(s)||(s=s.child(""));const i=new Ba(new dt(s),0);let o=new fn(X);return this.Mr.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.Cr)),!0)}),i),At.resolve(this.Br(o))}Br(t){const e=[];return t.forEach((t=>{const n=this.Or(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){M(0===this.Lr(e.batchId,"removed")),this.mutationQueue.shift();let n=this.Mr;return At.forEach(e.mutations,(r=>{const s=new Ba(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.Mr=n}))}qn(t){}containsKey(t,e){const n=new Ba(e,0),r=this.Mr.firstAfterOrEqual(n);return At.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.mutationQueue.length,At.resolve()}Lr(t,e){return this.Nr(t)}Nr(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}Or(t){const e=this.Nr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class ja{constructor(t){this.kr=t,this.docs=new ln(dt.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),s=r?r.size:0,i=this.kr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return At.resolve(n?n.document.mutableCopy():hr.newInvalidDocument(e))}getEntries(t,e){let n=ls();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():hr.newInvalidDocument(t))})),At.resolve(n)}getDocumentsMatchingQuery(t,e,n,r){let s=ls();const i=e.path,o=new dt(i.child("__id-9223372036854775808__")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:t,value:{document:o}}=a.getNext();if(!i.isPrefixOf(t.path))break;t.path.length>i.length+1||Et(Tt(o),n)<=0||(r.has(o.key)||ss(e,o))&&(s=s.insert(o.key,o.mutableCopy()))}return At.resolve(s)}getAllFromCollectionGroup(t,e,n,r){R()}qr(t,e){return At.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Ka(this)}getSize(t){return At.resolve(this.size)}}class Ka extends xa{constructor(t){super(),this.Ir=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?e.push(this.Ir.addEntry(t,r)):this.Ir.removeEntry(n)})),At.waitFor(e)}getFromCache(t,e){return this.Ir.getEntry(t,e)}getAllFromCache(t,e){return this.Ir.getEntries(t,e)}}class Ga{constructor(t){this.persistence=t,this.Qr=new us((t=>Vr(t)),Ur),this.lastRemoteSnapshotVersion=ot.min(),this.highestTargetId=0,this.$r=0,this.Ur=new qa,this.targetCount=0,this.Kr=da.Un()}forEachTarget(t,e){return this.Qr.forEach(((t,n)=>e(n))),At.resolve()}getLastRemoteSnapshotVersion(t){return At.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return At.resolve(this.$r)}allocateTargetId(t){return this.highestTargetId=this.Kr.next(),At.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.$r&&(this.$r=e),At.resolve()}zn(t){this.Qr.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Kr=new da(e),this.highestTargetId=e),t.sequenceNumber>this.$r&&(this.$r=t.sequenceNumber)}addTargetData(t,e){return this.zn(e),this.targetCount+=1,At.resolve()}updateTargetData(t,e){return this.zn(e),At.resolve()}removeTargetData(t,e){return this.Qr.delete(e.target),this.Ur.br(e.targetId),this.targetCount-=1,At.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Qr.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Qr.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),At.waitFor(s).next((()=>r))}getTargetCount(t){return At.resolve(this.targetCount)}getTargetData(t,e){const n=this.Qr.get(e)||null;return At.resolve(n)}addMatchingKeys(t,e,n){return this.Ur.yr(e,n),At.resolve()}removeMatchingKeys(t,e,n){this.Ur.Sr(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),At.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Ur.br(e),At.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Ur.vr(e);return At.resolve(n)}containsKey(t,e){return At.resolve(this.Ur.containsKey(e))}}class $a{constructor(t,e){this.Wr={},this.overlays={},this.Gr=new jt(0),this.zr=!1,this.zr=!0,this.jr=new Ua,this.referenceDelegate=t(this),this.Hr=new Ga(this),this.indexManager=new $o,this.remoteDocumentCache=function(t){return new ja(t)}((t=>this.referenceDelegate.Jr(t))),this.serializer=new oo(e),this.Yr=new Fa(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Va,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Wr[t.toKey()];return n||(n=new za(e,this.referenceDelegate),this.Wr[t.toKey()]=n),n}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(t,e,n){A("MemoryPersistence","Starting transaction:",t);const r=new Qa(this.Gr.next());return this.referenceDelegate.Zr(),n(r).next((t=>this.referenceDelegate.Xr(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}ei(t,e){return At.or(Object.values(this.Wr).map((n=>()=>n.containsKey(t,e))))}}class Qa extends xt{constructor(t){super(),this.currentSequenceNumber=t}}class Ha{constructor(t){this.persistence=t,this.ti=new qa,this.ni=null}static ri(t){return new Ha(t)}get ii(){if(this.ni)return this.ni;throw R()}addReference(t,e,n){return this.ti.addReference(n,e),this.ii.delete(n.toString()),At.resolve()}removeReference(t,e,n){return this.ti.removeReference(n,e),this.ii.add(n.toString()),At.resolve()}markPotentiallyOrphaned(t,e){return this.ii.add(e.toString()),At.resolve()}removeTarget(t,e){this.ti.br(e.targetId).forEach((t=>this.ii.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.ii.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Zr(){this.ni=new Set}Xr(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return At.forEach(this.ii,(n=>{const r=dt.fromPath(n);return this.si(t,r).next((t=>{t||e.removeEntry(r,ot.min())}))})).next((()=>(this.ni=null,e.apply(t))))}updateLimboDocument(t,e){return this.si(t,e).next((t=>{t?this.ii.delete(e.toString()):this.ii.add(e.toString())}))}Jr(t){return 0}si(t,e){return At.or([()=>At.resolve(this.ti.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.ei(t,e)])}}class Wa{constructor(t,e){this.persistence=t,this.oi=new us((t=>Wt(t.path)),((t,e)=>t.isEqual(e))),this.garbageCollector=_a(this,e)}static ri(t,e){return new Wa(t,e)}Zr(){}Xr(t){return At.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}nr(t){const e=this.sr(t);return this.persistence.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}sr(t){let e=0;return this.rr(t,(t=>{e++})).next((()=>e))}rr(t,e){return At.forEach(this.oi,((n,r)=>this.ar(t,n,r).next((t=>t?At.resolve():e(r)))))}removeTargets(t,e,n){return this.persistence.getTargetCache().removeTargets(t,e,n)}removeOrphanedDocuments(t,e){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.qr(t,(r=>this.ar(t,r,e).next((t=>{t||(n++,s.removeEntry(r,ot.min()))})))).next((()=>s.apply(t))).next((()=>n))}markPotentiallyOrphaned(t,e){return this.oi.set(e,t.currentSequenceNumber),At.resolve()}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,n)}addReference(t,e,n){return this.oi.set(n,t.currentSequenceNumber),At.resolve()}removeReference(t,e,n){return this.oi.set(n,t.currentSequenceNumber),At.resolve()}updateLimboDocument(t,e){return this.oi.set(e,t.currentSequenceNumber),At.resolve()}Jr(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=Hn(t.data.value)),e}ar(t,e,n){return At.or([()=>this.persistence.ei(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const t=this.oi.get(e);return At.resolve(void 0!==t&&t>n)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}class Ya{constructor(t){this.serializer=t}B(t,e,n,r){const s=new kt("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore(te)}(t),function(t){t.createObjectStore(ne,{keyPath:"userId"});t.createObjectStore(re,{keyPath:se,autoIncrement:!0}).createIndex(ie,oe,{unique:!0}),t.createObjectStore(le)}(t),Xa(t),function(t){t.createObjectStore(Zt)}(t));let i=At.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore(Te),t.deleteObjectStore(ve),t.deleteObjectStore(Ce)}(t),Xa(t)),i=i.next((()=>function(t){const e=t.store(Ce),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ot.min().toTimestamp(),targetCount:0};return e.put(xe,n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store(re).G().next((n=>{t.deleteObjectStore(re),t.createObjectStore(re,{keyPath:se,autoIncrement:!0}).createIndex(ie,oe,{unique:!0});const r=e.store(re),s=n.map((t=>r.put(t)));return At.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore(ke,{keyPath:"clientId"})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this._i(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore(ye)}(t),this.ai(s))))),n<7&&r>=7&&(i=i.next((()=>this.ui(s)))),n<8&&r>=8&&(i=i.next((()=>this.ci(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&r>=10&&(i=i.next((()=>this.li(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore(Ne,{keyPath:"bundleId"})}(t),function(t){t.createObjectStore(Re,{keyPath:"name"})}(t)}))),n<12&&r>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore(je,{keyPath:Ke});e.createIndex(Ge,$e,{unique:!1}),e.createIndex(Qe,He,{unique:!1})}(t)}))),n<13&&r>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore(he,{keyPath:de});e.createIndex(fe,ge),e.createIndex(me,pe)}(t))).next((()=>this.hi(t,s))).next((()=>t.deleteObjectStore(Zt)))),n<14&&r>=14&&(i=i.next((()=>this.Pi(t,s)))),n<15&&r>=15&&(i=i.next((()=>function(t){t.createObjectStore(Me,{keyPath:"indexId",autoIncrement:!0}).createIndex(Pe,"collectionGroup",{unique:!1});t.createObjectStore(Oe,{keyPath:Le}).createIndex(Fe,Ve,{unique:!1});t.createObjectStore(Ue,{keyPath:qe}).createIndex(Be,ze,{unique:!1})}(t)))),n<16&&r>=16&&(i=i.next((()=>{e.objectStore(Oe).clear()})).next((()=>{e.objectStore(Ue).clear()}))),n<17&&r>=17&&(i=i.next((()=>{!function(t){t.createObjectStore(We,{keyPath:"name"})}(t)}))),i}ai(t){let e=0;return t.store(Zt).Z(((t,n)=>{e+=oa(n)})).next((()=>{const n={byteSize:e};return t.store(ye).put(we,n)}))}_i(t){const e=t.store(ne),n=t.store(re);return e.G().next((e=>At.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,Kt],[e.userId,e.lastAcknowledgedBatchId]);return n.G(ie,r).next((n=>At.forEach(n,(n=>{M(n.userId===e.userId);const r=ho(this.serializer,n);return ia(t,e.userId,r).next((()=>{}))}))))}))))}ui(t){const e=t.store(Te),n=t.store(Zt);return t.store(Ce).get(xe).next((t=>{const r=[];return n.Z(((n,s)=>{const i=new ct(n),o=function(t){return[0,Wt(t)]}(i);r.push(e.get(o).next((n=>n?At.resolve():(n=>e.put({targetId:0,path:Wt(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>At.waitFor(r)))}))}ci(t,e){t.createObjectStore(Ae,{keyPath:De});const n=e.store(Ae),r=new Qo,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Wt(r)})}};return e.store(Zt).Z({Y:!0},((t,e)=>{const n=new ct(t);return s(n.popLast())})).next((()=>e.store(le).Z({Y:!0},((t,e)=>{let[n,r,i]=t;const o=Jt(r);return s(o.popLast())}))))}li(t){const e=t.store(ve);return e.Z(((t,n)=>{const r=fo(n),s=go(this.serializer,r);return e.put(s)}))}hi(t,e){const n=e.store(Zt),r=[];return n.Z(((t,n)=>{const s=e.store(he),i=function(t){return t.document?new dt(ct.fromString(t.document.name).popFirst(5)):t.noDocument?dt.fromSegments(t.noDocument.path):t.unknownDocument?dt.fromSegments(t.unknownDocument.path):R()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>At.waitFor(r)))}Pi(t,e){const n=e.store(re),r=Aa(this.serializer),s=new $a(Ha.ri,this.serializer.Tt);return n.G().next((t=>{const n=new Map;return t.forEach((t=>{var e;let r=null!==(e=n.get(t.userId))&&void 0!==e?e:vs();ho(this.serializer,t).keys().forEach((t=>r=r.add(t))),n.set(t.userId,r)})),At.forEach(n,((t,n)=>{const i=new _(n),o=To.It(this.serializer,i),a=s.getIndexManager(i),u=aa.It(i,this.serializer,a,s.referenceDelegate);return new La(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new rn(e,jt.ae),t).next()}))}))}}function Xa(t){t.createObjectStore(Te,{keyPath:_e}).createIndex(Ee,Se,{unique:!0}),t.createObjectStore(ve,{keyPath:"targetId"}).createIndex(be,Ie,{unique:!0}),t.createObjectStore(Ce)}const Ja="IndexedDbPersistence",Za=18e5,tu=5e3,eu="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",nu="main";class ru{constructor(t,e,n,r,s,i,o,a,u,c){let l=arguments.length>10&&void 0!==arguments[10]?arguments[10]:17;if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Ti=s,this.window=i,this.document=o,this.Ii=u,this.Ei=c,this.di=l,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=t=>Promise.resolve(),!ru.D())throw new F(L.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ea(this,r),this.gi=e+nu,this.serializer=new oo(a),this.pi=new Nt(this.gi,this.di,new Ya(this.serializer)),this.jr=new Eo,this.Hr=new fa(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Aa(this.serializer),this.Yr=new vo,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===c&&D(Ja,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new F(L.FAILED_PRECONDITION,eu);return this.Si(),this.bi(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Hr.getHighestSequenceNumber(t)))})).then((t=>{this.Gr=new jt(t,this.Ii)})).then((()=>{this.zr=!0})).catch((t=>(this.pi&&this.pi.close(),Promise.reject(t))))}Ci(t){return this.fi=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.pi.k((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Ti.enqueueAndForget((async()=>{this.started&&await this.wi()})))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>iu(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Fi(t).next((t=>{t||(this.isPrimary=!1,this.Ti.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Mi(t))).next((e=>this.isPrimary&&!e?this.xi(t).next((()=>!1)):!!e&&this.Oi(t).next((()=>!0)))))).catch((t=>{if(Ot(t))return A(Ja,"Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return A(Ja,"Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Ti.enqueueRetryable((()=>this.fi(t))),this.isPrimary=t}))}Fi(t){return su(t).get(ee).next((t=>At.resolve(this.Ni(t))))}Bi(t){return iu(t).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,Za)){this.mi=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=sn(t,ke);return e.G().next((t=>{const n=this.qi(t,Za),r=t.filter((t=>-1===n.indexOf(t)));return At.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.yi)for(const e of t)this.yi.removeItem(this.Qi(e.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.wi().then((()=>this.Li())).then((()=>this.Di()))))}Ni(t){return!!t&&t.ownerId===this.clientId}Mi(t){return this.Ei?At.resolve(!0):su(t).get(ee).next((e=>{if(null!==e&&this.ki(e.leaseTimestampMs,tu)&&!this.$i(e.ownerId)){if(this.Ni(e)&&this.networkEnabled)return!0;if(!this.Ni(e)){if(!e.allowTabSynchronization)throw new F(L.FAILED_PRECONDITION,eu);return!1}}return!(!this.networkEnabled||!this.inForeground)||iu(t).G().next((t=>void 0===this.qi(t,tu).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&A(Ja,`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.zr=!1,this.Ui(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ki(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[te,ke],(t=>{const e=new rn(t,jt.ae);return this.xi(e).next((()=>this.Bi(e)))})),this.pi.close(),this.Gi()}qi(t,e){return t.filter((t=>this.ki(t.updateTimeMs,e)&&!this.$i(t.clientId)))}zi(){return this.runTransaction("getActiveClients","readonly",(t=>iu(t).G().next((t=>this.qi(t,Za).map((t=>t.clientId))))))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(t,e){return aa.It(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new Yo(t,this.serializer.Tt.databaseId)}getDocumentOverlayCache(t){return To.It(this.serializer,t)}getBundleCache(){return this.Yr}runTransaction(t,e,n){A(Ja,"Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite",s=function(t){return 17===t?nn:16===t?en:15===t?tn:14===t?Ze:13===t?Je:12===t?Xe:11===t?Ye:void R()}(this.di);let i;return this.pi.runTransaction(t,r,s,(r=>(i=new rn(r,this.Gr?this.Gr.next():jt.ae),"readwrite-primary"===e?this.Fi(i).next((t=>!!t||this.Mi(i))).next((e=>{if(!e)throw D(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable((()=>this.fi(!1))),new F(L.FAILED_PRECONDITION,St);return n(i)})).next((t=>this.Oi(i).next((()=>t)))):this.ji(i).next((()=>n(i)))))).then((t=>(i.raiseOnCommittedEvent(),t)))}ji(t){return su(t).get(ee).next((t=>{if(null!==t&&this.ki(t.leaseTimestampMs,tu)&&!this.$i(t.ownerId)&&!this.Ni(t)&&!(this.Ei||this.allowTabSynchronization&&t.allowTabSynchronization))throw new F(L.FAILED_PRECONDITION,eu)}))}Oi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return su(t).put(ee,e)}static D(){return Nt.D()}xi(t){const e=su(t);return e.get(ee).next((t=>this.Ni(t)?(A(Ja,"Releasing primary lease."),e.delete(ee)):At.resolve()))}ki(t,e){const n=Date.now();return!(t<n-e)&&(!(t>n)||(D(`Detected an update time that is in the future: ${t} > ${n}`),!1))}Si(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.wi())))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ki(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}bi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Ai=()=>{this.Ui();const t=/(?:Version|Mobile)\/1[456]/;(0,u.nr)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(t){var e;try{const n=null!==(null===(e=this.yi)||void 0===e?void 0:e.getItem(this.Qi(t)));return A(Ja,`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return D(Ja,"Failed to get zombied client id.",t),!1}}Ui(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(t){D("Failed to set zombie client id.",t)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(t){}}Qi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function su(t){return sn(t,te)}function iu(t){return sn(t,ke)}function ou(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class au{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Hi=n,this.Ji=r}static Yi(t,e){let n=vs(),r=vs();for(const s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new au(t,e.fromCache,n,r)}}class uu{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}class cu{constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,u.nr)()?8:Rt((0,u.ZQ)())>0?6:4}initialize(t,e){this.ns=t,this.indexManager=e,this.Zi=!0}getDocumentsMatchingQuery(t,e,n,r){const s={result:null};return this.rs(t,e).next((t=>{s.result=t})).next((()=>{if(!s.result)return this.ss(t,e,r,n).next((t=>{s.result=t}))})).next((()=>{if(s.result)return;const n=new uu;return this._s(t,e,n).next((r=>{if(s.result=r,this.Xi)return this.us(t,e,n,r.size)}))})).next((()=>s.result))}us(t,e,n,r){return n.documentReadCount<this.es?(x()<=a.$b.DEBUG&&A("QueryEngine","SDK will not create cache indexes for query:",rs(e),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),At.resolve()):(x()<=a.$b.DEBUG&&A("QueryEngine","Query:",rs(e),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ts*r?(x()<=a.$b.DEBUG&&A("QueryEngine","The SDK decides to create cache indexes for query:",rs(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Yr(e))):At.resolve())}rs(t,e){if(Qr(e))return At.resolve(null);let n=Yr(e);return this.indexManager.getIndexType(t,n).next((r=>0===r?null:(null!==e.limit&&1===r&&(e=ts(e,null,"F"),n=Yr(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((r=>{const s=vs(...r);return this.ns.getDocuments(t,s).next((r=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.cs(e,r);return this.ls(e,i,s,n.readTime)?this.rs(t,ts(e,null,"F")):this.hs(t,i,e,n)}))))})))))}ss(t,e,n,r){return Qr(e)||r.isEqual(ot.min())?At.resolve(null):this.ns.getDocuments(t,n).next((s=>{const i=this.cs(e,s);return this.ls(e,i,n,r)?At.resolve(null):(x()<=a.$b.DEBUG&&A("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),rs(e)),this.hs(t,i,e,It(r,ft)).next((t=>t)))}))}cs(t,e){let n=new fn(os(t));return e.forEach(((e,r)=>{ss(t,r)&&(n=n.add(r))})),n}ls(t,e,n,r){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const s="F"===t.limitType?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}_s(t,e,n){return x()<=a.$b.DEBUG&&A("QueryEngine","Using full collection scan to execute query:",rs(e)),this.ns.getDocumentsMatchingQuery(t,e,_t.min(),n)}hs(t,e,n,r){return this.ns.getDocumentsMatchingQuery(t,n,r).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}const lu="LocalStore",hu=3e8;class du{constructor(t,e,n,r){this.persistence=t,this.Ps=e,this.serializer=r,this.Ts=new ln(X),this.Is=new us((t=>Vr(t)),Ur),this.Es=new Map,this.ds=t.getRemoteDocumentCache(),this.Hr=t.getTargetCache(),this.Yr=t.getBundleCache(),this.As(n)}As(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new La(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Ts)))}}function fu(t,e,n,r){return new du(t,e,n,r)}async function gu(t,e){const n=O(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let r;return n.mutationQueue.getAllMutationBatches(t).next((s=>(r=s,n.As(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const s=[],i=[];let o=vs();for(const t of r){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({Rs:t,removedBatchIds:s,addedBatchIds:i})))}))}))}function mu(t){const e=O(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Hr.getLastRemoteSnapshotVersion(t)))}function pu(t,e,n){let r=vs(),s=vs();return n.forEach((t=>r=r.add(t))),e.getEntries(t,r).next((t=>{let r=ls();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(ot.min())?(e.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),r=r.insert(n,i)):A(lu,"Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Vs:r,fs:s}}))}function yu(t,e){const n=O(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=Kt),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function wu(t,e){const n=O(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.Hr.getTargetData(t,e).next((s=>s?(r=s,At.resolve(r)):n.Hr.allocateTargetId(t).next((s=>(r=new io(e,s,"TargetPurposeListen",t.currentSequenceNumber),n.Hr.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.Ts.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Ts=n.Ts.insert(t.targetId,t),n.Is.set(e,t.targetId)),t}))}async function vu(t,e,n){const r=O(t),s=r.Ts.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!Ot(t))throw t;A(lu,`Failed to update sequence numbers for target ${e}: ${t}`)}r.Ts=r.Ts.remove(e),r.Is.delete(s.target)}function bu(t,e,n){const r=O(t);let s=ot.min(),i=vs();return r.persistence.runTransaction("Execute query","readwrite",(t=>function(t,e,n){const r=O(t),s=r.Is.get(n);return void 0!==s?At.resolve(r.Ts.get(s)):r.Hr.getTargetData(e,n)}(r,t,Yr(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.Hr.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.Ps.getDocumentsMatchingQuery(t,e,n?s:ot.min(),n?i:vs()))).next((t=>(_u(r,is(e),t),{documents:t,gs:i})))))}function Iu(t,e){const n=O(t),r=O(n.Hr),s=n.Ts.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r.lt(t,e).next((t=>t?t.target:null))))}function Tu(t,e){const n=O(t),r=n.Es.get(e)||ot.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.ds.getAllFromCollectionGroup(t,e,It(r,ft),Number.MAX_SAFE_INTEGER))).then((t=>(_u(n,e,t),t)))}function _u(t,e,n){let r=t.Es.get(e)||ot.min();n.forEach(((t,e)=>{e.readTime.compareTo(r)>0&&(r=e.readTime)})),t.Es.set(e,r)}async function Eu(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vs();const r=await wu(t,Yr(mo(e.bundledQuery))),s=O(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Ri(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Yr.saveNamedQuery(t,e);const o=r.withResumeToken(vn.EMPTY_BYTE_STRING,i);return s.Ts=s.Ts.insert(o.targetId,o),s.Hr.updateTargetData(t,o).next((()=>s.Hr.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.Hr.addMatchingKeys(t,n,r.targetId))).next((()=>s.Yr.saveNamedQuery(t,e)))}))}const Su="firestore_clients";function xu(t,e){return`${Su}_${t}_${e}`}const Cu="firestore_mutations";function Au(t,e,n){let r=`${Cu}_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}const Du="firestore_targets";function ku(t,e){return`${Du}_${t}_${e}`}const Nu="SharedClientState";class Ru{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Ss(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new F(r.error.code,r.error.message))),i?new Ru(t,e,r.state,s):(D(Nu,`Failed to parse mutation state for ID '${e}': ${n}`),null)}bs(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Mu{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Ss(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new F(n.error.code,n.error.message))),s?new Mu(t,n.state,r):(D(Nu,`Failed to parse target state for ID '${t}': ${e}`),null)}bs(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Pu{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Ss(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Is();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Qt(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Pu(t,s):(D(Nu,`Failed to parse client data for instance '${t}': ${e}`),null)}}class Ou{constructor(t,e){this.clientId=t,this.onlineState=e}static Ss(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Ou(e.clientId,e.onlineState):(D(Nu,`Failed to parse online state: ${t}`),null)}}class Lu{constructor(){this.activeTargetIds=Is()}Ds(t){this.activeTargetIds=this.activeTargetIds.add(t)}vs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}bs(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Fu{constructor(t,e,n,r,s){this.window=t,this.Ti=e,this.persistenceKey=n,this.Cs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new ln(X),this.started=!1,this.Os=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ns=xu(this.persistenceKey,this.Cs),this.Bs=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.xs=this.xs.insert(this.Cs,new Lu),this.Ls=new RegExp(`^${Su}_${i}_([^_]*)$`),this.ks=new RegExp(`^${Cu}_${i}_(\\d+)(?:_(.*))?$`),this.qs=new RegExp(`^${Du}_${i}_(\\d+)$`),this.Qs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.$s=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.Fs)}static D(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.zi();for(const n of t){if(n===this.Cs)continue;const t=this.getItem(xu(this.persistenceKey,n));if(t){const e=Pu.Ss(n,t);e&&(this.xs=this.xs.insert(e.clientId,e))}}this.Us();const e=this.storage.getItem(this.Qs);if(e){const t=this.Ks(e);t&&this.Ws(t)}for(const n of this.Os)this.Ms(n);this.Os=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Bs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(t){let e=!1;return this.xs.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.zs(t,"pending")}updateMutationState(t,e,n){this.zs(t,e,n),this.js(t)}addLocalQueryTarget(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n="not-current";if(this.isActiveQueryTarget(t)){const e=this.storage.getItem(ku(this.persistenceKey,t));if(e){const r=Mu.Ss(t,e);r&&(n=r.state)}}return e&&this.Hs.Ds(t),this.Us(),n}removeLocalQueryTarget(t){this.Hs.vs(t),this.Us()}isLocalQueryTarget(t){return this.Hs.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(ku(this.persistenceKey,t))}updateQueryState(t,e,n){this.Js(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.js(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Ys(t)}notifyBundleLoaded(t){this.Zs(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return A(Nu,"READ",t,e),e}setItem(t,e){A(Nu,"SET",t,e),this.storage.setItem(t,e)}removeItem(t){A(Nu,"REMOVE",t),this.storage.removeItem(t)}Ms(t){const e=t;if(e.storageArea===this.storage){if(A(Nu,"EVENT",e.key,e.newValue),e.key===this.Ns)return void D("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.Ls.test(e.key)){if(null==e.newValue){const t=this.Xs(e.key);return this.eo(t,null)}{const t=this.no(e.key,e.newValue);if(t)return this.eo(t.clientId,t)}}else if(this.ks.test(e.key)){if(null!==e.newValue){const t=this.ro(e.key,e.newValue);if(t)return this.io(t)}}else if(this.qs.test(e.key)){if(null!==e.newValue){const t=this.so(e.key,e.newValue);if(t)return this.oo(t)}}else if(e.key===this.Qs){if(null!==e.newValue){const t=this.Ks(e.newValue);if(t)return this.Ws(t)}}else if(e.key===this.Bs){const t=function(t){let e=jt.ae;if(null!=t)try{const n=JSON.parse(t);M("number"==typeof n),e=n}catch(t){D(Nu,"Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==jt.ae&&this.sequenceNumberHandler(t)}else if(e.key===this.$s){const t=this._o(e.newValue);await Promise.all(t.map((t=>this.syncEngine.ao(t))))}}else this.Os.push(e)}))}}get Hs(){return this.xs.get(this.Cs)}Us(){this.setItem(this.Ns,this.Hs.bs())}zs(t,e,n){const r=new Ru(this.currentUser,t,e,n),s=Au(this.persistenceKey,this.currentUser,t);this.setItem(s,r.bs())}js(t){const e=Au(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Ys(t){const e={clientId:this.Cs,onlineState:t};this.storage.setItem(this.Qs,JSON.stringify(e))}Js(t,e,n){const r=ku(this.persistenceKey,t),s=new Mu(t,e,n);this.setItem(r,s.bs())}Zs(t){const e=JSON.stringify(Array.from(t));this.setItem(this.$s,e)}Xs(t){const e=this.Ls.exec(t);return e?e[1]:null}no(t,e){const n=this.Xs(t);return Pu.Ss(n,e)}ro(t,e){const n=this.ks.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return Ru.Ss(new _(s),r,e)}so(t,e){const n=this.qs.exec(t),r=Number(n[1]);return Mu.Ss(r,e)}Ks(t){return Ou.Ss(t)}_o(t){return JSON.parse(t)}async io(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.uo(t.batchId,t.state,t.error);A(Nu,`Ignoring mutation for non-active user ${t.user.uid}`)}oo(t){return this.syncEngine.co(t.targetId,t.state,t.error)}eo(t,e){const n=e?this.xs.insert(t,e):this.xs.remove(t),r=this.Gs(this.xs),s=this.Gs(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.lo(i,o).then((()=>{this.xs=n}))}Ws(t){this.xs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Gs(t){let e=Is();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Vu{constructor(){this.ho=new Lu,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.ho.Ds(t),this.Po[t]||"not-current"}updateQueryState(t,e,n){this.Po[t]=e}removeLocalQueryTarget(t){this.ho.vs(t)}isLocalQueryTarget(t){return this.ho.activeTargetIds.has(t)}clearQueryState(t){delete this.Po[t]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(t){return this.ho.activeTargetIds.has(t)}start(){return this.ho=new Lu,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class Uu{To(t){}shutdown(){}}const qu="ConnectivityMonitor";class Bu{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(t){this.Vo.push(t)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){A(qu,"Network connectivity changed: AVAILABLE");for(const t of this.Vo)t(0)}Ro(){A(qu,"Network connectivity changed: UNAVAILABLE");for(const t of this.Vo)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let zu=null;function ju(){return null===zu?zu=268435456+Math.round(2147483648*Math.random()):zu++,"0x"+zu.toString(16)}const Ku="RestConnection",Gu={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class $u{get fo(){return!1}constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=e+"://"+t.host,this.yo=`projects/${n}/databases/${r}`,this.wo=this.databaseId.database===Rn?`project_id=${n}`:`project_id=${n}&database_id=${r}`}So(t,e,n,r,s){const i=ju(),o=this.bo(t,e.toUriEncodedString());A(Ku,`Sending RPC '${t}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(a,r,s),this.vo(t,o,a,n).then((e=>(A(Ku,`Received RPC '${t}' ${i}: `,e),e)),(e=>{throw k(Ku,`RPC '${t}' ${i} failed with error: `,e,"url: ",o,"request:",n),e}))}Co(t,e,n,r,s,i){return this.So(t,e,n,r,s)}Do(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+E,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}bo(t,e){const n=Gu[t];return`${this.po}/v1/${e}:${n}`}terminate(){}}class Qu{constructor(t){this.Fo=t.Fo,this.Mo=t.Mo}xo(t){this.Oo=t}No(t){this.Bo=t}Lo(t){this.ko=t}onMessage(t){this.qo=t}close(){this.Mo()}send(t){this.Fo(t)}Qo(){this.Oo()}$o(){this.Bo()}Uo(t){this.ko(t)}Ko(t){this.qo(t)}}const Hu="WebChannelConnection";class Wu extends $u{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}vo(t,e,n,r){const s=ju();return new Promise(((i,o)=>{const a=new h;a.setWithCredentials(!0),a.listenOnce(f.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case g.NO_ERROR:const e=a.getResponseJson();A(Hu,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(e)),i(e);break;case g.TIMEOUT:A(Hu,`RPC '${t}' ${s} timed out`),o(new F(L.DEADLINE_EXCEEDED,"Request time out"));break;case g.HTTP_ERROR:const n=a.getStatus();if(A(Hu,`RPC '${t}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let t=a.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(L).indexOf(e)>=0?e:L.UNKNOWN}(e.status);o(new F(t,e.message))}else o(new F(L.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new F(L.UNAVAILABLE,"Connection failed."));break;default:R()}}finally{A(Hu,`RPC '${t}' ${s} completed.`)}}));const u=JSON.stringify(r);A(Hu,`RPC '${t}' ${s} sending request:`,r),a.send(e,"POST",u,n,15)}))}Wo(t,e,n){const r=ju(),s=[this.po,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=w(),o=y(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Do(a.initMessageHeaders,e,n),a.encodeInitMessageHeaders=!0;const c=s.join("");A(Hu,`Creating RPC '${t}' stream ${r}: ${c}`,a);const l=i.createWebChannel(c,a);let h=!1,f=!1;const g=new Qu({Fo:e=>{f?A(Hu,`Not sending because RPC '${t}' stream ${r} is closed:`,e):(h||(A(Hu,`Opening RPC '${t}' stream ${r} transport.`),l.open(),h=!0),A(Hu,`RPC '${t}' stream ${r} sending:`,e),l.send(e))},Mo:()=>l.close()}),v=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return v(l,d.EventType.OPEN,(()=>{f||(A(Hu,`RPC '${t}' stream ${r} transport opened.`),g.Qo())})),v(l,d.EventType.CLOSE,(()=>{f||(f=!0,A(Hu,`RPC '${t}' stream ${r} transport closed`),g.Uo())})),v(l,d.EventType.ERROR,(e=>{f||(f=!0,k(Hu,`RPC '${t}' stream ${r} transport errored:`,e),g.Uo(new F(L.UNAVAILABLE,"The operation could not be completed")))})),v(l,d.EventType.MESSAGE,(e=>{var n;if(!f){const s=e.data[0];M(!!s);const i=s,o=(null==i?void 0:i.error)||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){A(Hu,`RPC '${t}' stream ${r} received error:`,o);const e=o.status;let n=function(t){const e=ii[t];if(void 0!==e)return ui(e)}(e),s=o.message;void 0===n&&(n=L.INTERNAL,s="Unknown error status: "+e+" with message "+o.message),f=!0,g.Uo(new F(n,s)),l.close()}else A(Hu,`RPC '${t}' stream ${r} received:`,s),g.Ko(s)}})),v(o,p.STAT_EVENT,(e=>{e.stat===m.PROXY?A(Hu,`RPC '${t}' stream ${r} detected buffering proxy`):e.stat===m.NOPROXY&&A(Hu,`RPC '${t}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{g.$o()}),0),g}}function Yu(){return"undefined"!=typeof window?window:null}function Xu(){return"undefined"!=typeof document?document:null}function Ju(t){return new Ci(t,!0)}class Zu{constructor(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.5,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6e4;this.Ti=t,this.timerId=e,this.Go=n,this.zo=r,this.jo=s,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(t){this.cancel();const e=Math.floor(this.Ho+this.e_()),n=Math.max(0,Date.now()-this.Yo),r=Math.max(0,e-n);r>0&&A("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ho} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,r,(()=>(this.Yo=Date.now(),t()))),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}const tc="PersistentStream";class ec{constructor(t,e,n,r,s,i,o,a){this.Ti=t,this.n_=n,this.r_=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new Zu(t,e)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,(()=>this.T_())))}I_(t){this.E_(),this.stream.send(t)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(t,e){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==t?this.a_.reset():e&&e.code===L.RESOURCE_EXHAUSTED?(D(e.toString()),D("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):e&&e.code===L.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Lo(e)}A_(){}auth(){this.state=1;const t=this.R_(this.i_),e=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((t=>{let[n,r]=t;this.i_===e&&this.V_(n,r)}),(e=>{t((()=>{const t=new F(L.UNKNOWN,"Fetching auth token failed: "+e.message);return this.m_(t)}))}))}V_(t,e){const n=this.R_(this.i_);this.stream=this.f_(t,e),this.stream.xo((()=>{n((()=>this.listener.xo()))})),this.stream.No((()=>{n((()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,(()=>(this.c_()&&(this.state=3),Promise.resolve()))),this.listener.No())))})),this.stream.Lo((t=>{n((()=>this.m_(t)))})),this.stream.onMessage((t=>{n((()=>1==++this.__?this.g_(t):this.onNext(t)))}))}l_(){this.state=5,this.a_.Xo((async()=>{this.state=0,this.start()}))}m_(t){return A(tc,`close with error: ${t}`),this.stream=null,this.close(4,t)}R_(t){return e=>{this.Ti.enqueueAndForget((()=>this.i_===t?e():(A(tc,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class nc extends ec{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s}f_(t,e){return this.connection.Wo("Listen",t,e)}g_(t){return this.onNext(t)}onNext(t){this.a_.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:R()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.useProto3Json?(M(void 0===e||"string"==typeof e),vn.fromBase64String(e||"")):(M(void 0===e||e instanceof Buffer||e instanceof Uint8Array),vn.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?L.UNKNOWN:ui(t.code);return new F(e,t.message||"")}(o);n=new vi(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Fi(t,r.document.name),i=Ri(r.document.updateTime),o=r.document.createTime?Ri(r.document.createTime):ot.min(),a=new cr({mapValue:{fields:r.document.fields}}),u=hr.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new yi(c,l,u.key,u)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Fi(t,r.document),i=r.readTime?Ri(r.readTime):ot.min(),o=hr.newNoDocument(s,i),a=r.removedTargetIds||[];n=new yi([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Fi(t,r.document),i=r.removedTargetIds||[];n=new yi([],i,s,null)}else{if(!("filter"in e))return R();{e.filter;const t=e.filter;t.targetId;const{count:r=0,unchangedNames:s}=t,i=new si(r,s),o=t.targetId;n=new wi(o,i)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return ot.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?ot.min():e.readTime?Ri(e.readTime):ot.min()}(t);return this.listener.p_(e,n)}y_(t){const e={};e.database=qi(this.serializer),e.addTarget=function(t,e){let n;const r=e.target;if(n=qr(r)?{documents:$i(t,r)}:{query:Qi(t,r).ht},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0){n.resumeToken=ki(t,e.resumeToken);const r=Ai(t,e.expectedCount);null!==r&&(n.expectedCount=r)}else if(e.snapshotVersion.compareTo(ot.min())>0){n.readTime=Di(t,e.snapshotVersion.toTimestamp());const r=Ai(t,e.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,t);const n=function(t,e){const n=function(t){switch(t){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return R()}}(e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.I_(e)}w_(t){const e={};e.database=qi(this.serializer),e.removeTarget=t,this.I_(e)}}class rc extends ec{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s}get S_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.S_&&this.b_([])}f_(t,e){return this.connection.Wo("Write",t,e)}g_(t){return M(!!t.streamToken),this.lastStreamToken=t.streamToken,M(!t.writeResults||0===t.writeResults.length),this.listener.D_()}onNext(t){M(!!t.streamToken),this.lastStreamToken=t.streamToken,this.a_.reset();const e=function(t,e){return t&&t.length>0?(M(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Ri(t.updateTime):Ri(e);return n.isEqual(ot.min())&&(n=Ri(e)),new Vs(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Ri(t.commitTime);return this.listener.v_(n,e)}C_(){const t={};t.database=qi(this.serializer),this.I_(t)}b_(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Ki(this.serializer,t)))};this.I_(e)}}class sc{}class ic extends sc{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=r,this.F_=!1}M_(){if(this.F_)throw new F(L.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,n,r){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((s=>{let[i,o]=s;return this.connection.So(t,Pi(e,n),r,i,o)})).catch((t=>{throw"FirebaseError"===t.name?(t.code===L.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new F(L.UNKNOWN,t.toString())}))}Co(t,e,n,r,s){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((i=>{let[o,a]=i;return this.connection.Co(t,Pi(e,n),r,o,a,s)})).catch((t=>{throw"FirebaseError"===t.name?(t.code===L.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new F(L.UNKNOWN,t.toString())}))}terminate(){this.F_=!0,this.connection.terminate()}}class oc{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve()))))}q_(t){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.L_("Offline")))}set(t){this.Q_(),this.x_=0,"Online"===t&&(this.N_=!1),this.L_(t)}L_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}k_(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(D(e),this.N_=!1):A("OnlineStateTracker",e)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}const ac="RemoteStore";class uc{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.U_=[],this.K_=new Map,this.W_=new Set,this.G_=[],this.z_=s,this.z_.To((t=>{n.enqueueAndForget((async()=>{yc(this)&&(A(ac,"Restarting streams for network reachability change."),await async function(t){const e=O(t);e.W_.add(4),await lc(e),e.j_.set("Unknown"),e.W_.delete(4),await cc(e)}(this))}))})),this.j_=new oc(n,r)}}async function cc(t){if(yc(t))for(const e of t.G_)await e(!0)}async function lc(t){for(const e of t.G_)await e(!1)}function hc(t,e){const n=O(t);n.K_.has(e.targetId)||(n.K_.set(e.targetId,e),pc(n)?mc(n):Lc(n).c_()&&fc(n,e))}function dc(t,e){const n=O(t),r=Lc(n);n.K_.delete(e),r.c_()&&gc(n,e),0===n.K_.size&&(r.c_()?r.P_():yc(n)&&n.j_.set("Unknown"))}function fc(t,e){if(t.H_.Ne(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(ot.min())>0){const n=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(n)}Lc(t).y_(e)}function gc(t,e){t.H_.Ne(e),Lc(t).w_(e)}function mc(t){t.H_=new Ii({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),lt:e=>t.K_.get(e)||null,it:()=>t.datastore.serializer.databaseId}),Lc(t).start(),t.j_.B_()}function pc(t){return yc(t)&&!Lc(t).u_()&&t.K_.size>0}function yc(t){return 0===O(t).W_.size}function wc(t){t.H_=void 0}async function vc(t){t.j_.set("Online")}async function bc(t){t.K_.forEach(((e,n)=>{fc(t,e)}))}async function Ic(t,e){wc(t),pc(t)?(t.j_.q_(e),mc(t)):t.j_.set("Unknown")}async function Tc(t,e,n){if(t.j_.set("Online"),e instanceof vi&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.K_.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.K_.delete(r),t.H_.removeTarget(r))}(t,e)}catch(n){A(ac,"Failed to remove targets %s: %s ",e.targetIds.join(","),n),await _c(t,n)}else if(e instanceof yi?t.H_.We(e):e instanceof wi?t.H_.Ze(e):t.H_.je(e),!n.isEqual(ot.min()))try{const e=await mu(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.H_.ot(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.K_.get(r);s&&t.K_.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach(((e,n)=>{const r=t.K_.get(e);if(!r)return;t.K_.set(e,r.withResumeToken(vn.EMPTY_BYTE_STRING,r.snapshotVersion)),gc(t,e);const s=new io(r.target,e,n,r.sequenceNumber);fc(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){A(ac,"Failed to raise snapshot:",e),await _c(t,e)}}async function _c(t,e,n){if(!Ot(e))throw e;t.W_.add(1),await lc(t),t.j_.set("Offline"),n||(n=()=>mu(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{A(ac,"Retrying IndexedDB access"),await n(),t.W_.delete(1),await cc(t)}))}function Ec(t,e){return e().catch((n=>_c(t,n,e)))}async function Sc(t){const e=O(t),n=Fc(e);let r=e.U_.length>0?e.U_[e.U_.length-1].batchId:Kt;for(;xc(e);)try{const t=await yu(e.localStore,r);if(null===t){0===e.U_.length&&n.P_();break}r=t.batchId,Cc(e,t)}catch(t){await _c(e,t)}Ac(e)&&Dc(e)}function xc(t){return yc(t)&&t.U_.length<10}function Cc(t,e){t.U_.push(e);const n=Fc(t);n.c_()&&n.S_&&n.b_(e.mutations)}function Ac(t){return yc(t)&&!Fc(t).u_()&&t.U_.length>0}function Dc(t){Fc(t).start()}async function kc(t){Fc(t).C_()}async function Nc(t){const e=Fc(t);for(const n of t.U_)e.b_(n.mutations)}async function Rc(t,e,n){const r=t.U_.shift(),s=ei.from(r,e,n);await Ec(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await Sc(t)}async function Mc(t,e){e&&Fc(t).S_&&await async function(t,e){if(function(t){return ai(t)&&t!==L.ABORTED}(e.code)){const n=t.U_.shift();Fc(t).h_(),await Ec(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Sc(t)}}(t,e),Ac(t)&&Dc(t)}async function Pc(t,e){const n=O(t);n.asyncQueue.verifyOperationInProgress(),A(ac,"RemoteStore received new credentials");const r=yc(n);n.W_.add(3),await lc(n),r&&n.j_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.W_.delete(3),await cc(n)}async function Oc(t,e){const n=O(t);e?(n.W_.delete(2),await cc(n)):e||(n.W_.add(2),await lc(n),n.j_.set("Unknown"))}function Lc(t){return t.J_||(t.J_=function(t,e,n){const r=O(t);return r.M_(),new nc(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{xo:vc.bind(null,t),No:bc.bind(null,t),Lo:Ic.bind(null,t),p_:Tc.bind(null,t)}),t.G_.push((async e=>{e?(t.J_.h_(),pc(t)?mc(t):t.j_.set("Unknown")):(await t.J_.stop(),wc(t))}))),t.J_}function Fc(t){return t.Y_||(t.Y_=function(t,e,n){const r=O(t);return r.M_(),new rc(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{xo:()=>Promise.resolve(),No:kc.bind(null,t),Lo:Mc.bind(null,t),D_:Nc.bind(null,t),v_:Rc.bind(null,t)}),t.G_.push((async e=>{e?(t.Y_.h_(),await Sc(t)):(await t.Y_.stop(),t.U_.length>0&&(A(ac,`Stopping write stream with ${t.U_.length} pending writes`),t.U_=[]))}))),t.Y_}class Vc{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new V,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new Vc(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new F(L.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Uc(t,e){if(D("AsyncQueue",`${e}: ${t}`),Ot(t))return new F(L.UNAVAILABLE,`${e}: ${t}`);throw t}class qc{static emptySet(t){return new qc(t.comparator)}constructor(t){this.comparator=t?(e,n)=>t(e,n)||dt.comparator(e.key,n.key):(t,e)=>dt.comparator(t.key,e.key),this.keyedMap=ds(),this.sortedSet=new ln(this.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof qc))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new qc;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Bc{constructor(){this.Z_=new ln(dt.comparator)}track(t){const e=t.doc.key,n=this.Z_.get(e);n?0!==t.type&&3===n.type?this.Z_=this.Z_.insert(e,t):3===t.type&&1!==n.type?this.Z_=this.Z_.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Z_=this.Z_.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Z_=this.Z_.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Z_=this.Z_.remove(e):1===t.type&&2===n.type?this.Z_=this.Z_.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Z_=this.Z_.insert(e,{type:2,doc:t.doc}):R():this.Z_=this.Z_.insert(e,t)}X_(){const t=[];return this.Z_.inorderTraversal(((e,n)=>{t.push(n)})),t}}class zc{constructor(t,e,n,r,s,i,o,a,u){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(t,e,n,r,s){const i=[];return e.forEach((t=>{i.push({type:0,doc:t})})),new zc(t,e,qc.emptySet(e),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&es(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0}}class jc{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some((t=>t.ra()))}}class Kc{constructor(){this.queries=Gc(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(t,e){const n=O(t),r=n.queries;n.queries=Gc(),r.forEach(((t,n)=>{for(const r of n.ta)r.onError(e)}))}(this,new F(L.ABORTED,"Firestore shutting down"))}}function Gc(){return new us((t=>ns(t)),es)}async function $c(t,e){const n=O(t);let r=3;const s=e.query;let i=n.queries.get(s);i?!i.na()&&e.ra()&&(r=2):(i=new jc,r=e.ra()?0:1);try{switch(r){case 0:i.ea=await n.onListen(s,!0);break;case 1:i.ea=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(t){const n=Uc(t,`Initialization of query '${rs(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.ta.push(e),e.sa(n.onlineState),i.ea&&e.oa(i.ea)&&Yc(n)}async function Qc(t,e){const n=O(t),r=e.query;let s=3;const i=n.queries.get(r);if(i){const t=i.ta.indexOf(e);t>=0&&(i.ta.splice(t,1),0===i.ta.length?s=e.ra()?0:1:!i.na()&&e.ra()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function Hc(t,e){const n=O(t);let r=!1;for(const s of e){const t=s.query,e=n.queries.get(t);if(e){for(const t of e.ta)t.oa(s)&&(r=!0);e.ea=s}}r&&Yc(n)}function Wc(t,e,n){const r=O(t),s=r.queries.get(e);if(s)for(const i of s.ta)i.onError(n);r.queries.delete(e)}function Yc(t){t.ia.forEach((t=>{t.next()}))}var Xc,Jc;(Jc=Xc||(Xc={}))._a="default",Jc.Cache="cache";class Zc{constructor(t,e,n){this.query=t,this.aa=e,this.ua=!1,this.ca=null,this.onlineState="Unknown",this.options=n||{}}oa(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new zc(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.ua?this.la(t)&&(this.aa.next(t),e=!0):this.ha(t,this.onlineState)&&(this.Pa(t),e=!0),this.ca=t,e}onError(t){this.aa.error(t)}sa(t){this.onlineState=t;let e=!1;return this.ca&&!this.ua&&this.ha(this.ca,t)&&(this.Pa(this.ca),e=!0),e}ha(t,e){if(!t.fromCache)return!0;if(!this.ra())return!0;const n="Offline"!==e;return(!this.options.Ta||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}la(t){if(t.docChanges.length>0)return!0;const e=this.ca&&this.ca.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Pa(t){t=zc.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.ua=!0,this.aa.next(t)}ra(){return this.options.source!==Xc.Cache}}class tl{constructor(t,e){this.Ia=t,this.byteLength=e}Ea(){return"metadata"in this.Ia}}class el{constructor(t){this.serializer=t}ps(t){return Fi(this.serializer,t)}ys(t){return t.metadata.exists?ji(this.serializer,t.document,!1):hr.newNoDocument(this.ps(t.metadata.name),this.ws(t.metadata.readTime))}ws(t){return Ri(t)}}class nl{constructor(t,e,n){this.da=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=rl(t)}Aa(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.Ia.namedQuery)this.queries.push(t.Ia.namedQuery);else if(t.Ia.documentMetadata){this.documents.push({metadata:t.Ia.documentMetadata}),t.Ia.documentMetadata.exists||++e;const n=ct.fromString(t.Ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.Ia.document&&(this.documents[this.documents.length-1].document=t.Ia.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}Ra(t){const e=new Map,n=new el(this.serializer);for(const r of t)if(r.metadata.queries){const t=n.ps(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||vs()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=O(t);let i=vs(),o=ls();for(const c of n){const t=e.ps(c.metadata.name);c.document&&(i=i.add(t));const n=e.ys(c);n.setReadTime(e.ws(c.metadata.readTime)),o=o.insert(t,n)}const a=s.ds.newChangeBuffer({trackRemovals:!0}),u=await wu(s,function(t){return Yr($r(ct.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>pu(t,a,o).next((e=>(a.apply(t),e))).next((e=>s.Hr.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.Hr.addMatchingKeys(t,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(t,e.Vs,e.fs))).next((()=>e.Vs))))))}(this.localStore,new el(this.serializer),this.documents,this.da.id),e=this.Ra(this.documents);for(const n of this.queries)await Eu(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Va:this.collectionGroups,ma:t}}}function rl(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class sl{constructor(t){this.key=t}}class il{constructor(t){this.key=t}}class ol{constructor(t,e){this.query=t,this.fa=e,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=vs(),this.mutatedKeys=vs(),this.ya=os(t),this.wa=new qc(this.ya)}get Sa(){return this.fa}ba(t,e){const n=e?e.Da:new Bc,r=e?e.wa:this.wa;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const c=r.get(t),l=ss(this.query,e)?e:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.va(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.ya(l,a)>0||u&&this.ya(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{wa:i,Da:n,ls:o,mutatedKeys:s}}va(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,r){const s=this.wa;this.wa=t.wa,this.mutatedKeys=t.mutatedKeys;const i=t.Da.X_();i.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return R()}};return n(t)-n(e)}(t.type,e.type)||this.ya(t.doc,e.doc))),this.Ca(n),r=null!=r&&r;const o=e&&!r?this.Fa():[],a=0===this.pa.size&&this.current&&!r?1:0,u=a!==this.ga;return this.ga=a,0!==i.length||u?{snapshot:new zc(this.query,t.wa,s,i,t.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),Ma:o}:{Ma:o}}sa(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({wa:this.wa,Da:new Bc,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(t){return!this.fa.has(t)&&!!this.wa.has(t)&&!this.wa.get(t).hasLocalMutations}Ca(t){t&&(t.addedDocuments.forEach((t=>this.fa=this.fa.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.fa=this.fa.delete(t))),this.current=t.current)}Fa(){if(!this.current)return[];const t=this.pa;this.pa=vs(),this.wa.forEach((t=>{this.xa(t.key)&&(this.pa=this.pa.add(t.key))}));const e=[];return t.forEach((t=>{this.pa.has(t)||e.push(new il(t))})),this.pa.forEach((n=>{t.has(n)||e.push(new sl(n))})),e}Oa(t){this.fa=t.gs,this.pa=vs();const e=this.ba(t.documents);return this.applyChanges(e,!0)}Na(){return zc.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}const al="SyncEngine";class ul{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class cl{constructor(t){this.key=t,this.Ba=!1}}class ll{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.La={},this.ka=new us((t=>ns(t)),es),this.qa=new Map,this.Qa=new Set,this.$a=new ln(dt.comparator),this.Ua=new Map,this.Ka=new qa,this.Wa={},this.Ga=new Map,this.za=da.Kn(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function hl(t,e){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const r=ql(t);let s;const i=r.ka.get(e);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.Na()):s=await fl(r,e,n,!0),s}async function dl(t,e){const n=ql(t);await fl(n,e,!0,!1)}async function fl(t,e,n,r){const s=await wu(t.localStore,Yr(e)),i=s.targetId,o=t.sharedClientState.addLocalQueryTarget(i,n);let a;return r&&(a=await gl(t,e,i,"current"===o,s.resumeToken)),t.isPrimaryClient&&n&&hc(t.remoteStore,s),a}async function gl(t,e,n,r,s){t.Ha=(e,n,r)=>async function(t,e,n,r){let s=e.view.ba(n);s.ls&&(s=await bu(t.localStore,e.query,!1).then((t=>{let{documents:n}=t;return e.view.ba(n,s)})));const i=r&&r.targetChanges.get(e.targetId),o=r&&null!=r.targetMismatches.get(e.targetId),a=e.view.applyChanges(s,t.isPrimaryClient,i,o);return xl(t,e.targetId,a.Ma),a.snapshot}(t,e,n,r);const i=await bu(t.localStore,e,!0),o=new ol(e,i.gs),a=o.ba(i.documents),u=pi.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState,s),c=o.applyChanges(a,t.isPrimaryClient,u);xl(t,n,c.Ma);const l=new ul(e,n,o);return t.ka.set(e,l),t.qa.has(n)?t.qa.get(n).push(e):t.qa.set(n,[e]),c.snapshot}async function ml(t,e,n){const r=O(t),s=r.ka.get(e),i=r.qa.get(s.targetId);if(i.length>1)return r.qa.set(s.targetId,i.filter((t=>!es(t,e)))),void r.ka.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(s.targetId),r.sharedClientState.isActiveQueryTarget(s.targetId)||await vu(r.localStore,s.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(s.targetId),n&&dc(r.remoteStore,s.targetId),El(r,s.targetId)})).catch(Ct)):(El(r,s.targetId),await vu(r.localStore,s.targetId,!0))}async function pl(t,e){const n=O(t),r=n.ka.get(e),s=n.qa.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),dc(n.remoteStore,r.targetId))}async function yl(t,e){const n=O(t);try{const t=await function(t,e){const n=O(t),r=e.snapshotVersion;let s=n.Ts;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.ds.newChangeBuffer({trackRemovals:!0});s=n.Ts;const o=[];e.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Hr.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Hr.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);null!==e.targetMismatches.get(a)?c=c.withResumeToken(vn.EMPTY_BYTE_STRING,ot.min()).withLastLimboFreeSnapshotVersion(ot.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||(e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=hu||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)}(u,c,i)&&o.push(n.Hr.updateTargetData(t,c))}));let a=ls(),u=vs();if(e.documentUpdates.forEach((r=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(pu(t,i,e.documentUpdates).next((t=>{a=t.Vs,u=t.fs}))),!r.isEqual(ot.min())){const e=n.Hr.getLastRemoteSnapshotVersion(t).next((e=>n.Hr.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return At.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.Ts=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Ua.get(e);r&&(M(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.Ba=!0:t.modifiedDocuments.size>0?M(r.Ba):t.removedDocuments.size>0&&(M(r.Ba),r.Ba=!1))})),await Dl(n,t,e)}catch(t){await Ct(t)}}function wl(t,e,n){const r=O(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.ka.forEach(((n,r)=>{const s=r.view.sa(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=O(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const s of n.ta)s.sa(e)&&(r=!0)})),r&&Yc(n)}(r.eventManager,e),t.length&&r.La.p_(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function vl(t,e,n){const r=O(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Ua.get(e),i=s&&s.key;if(i){let t=new ln(dt.comparator);t=t.insert(i,hr.newNoDocument(i,ot.min()));const n=vs().add(i),s=new mi(ot.min(),new Map,new ln(X),t,n);await yl(r,s),r.$a=r.$a.remove(i),r.Ua.delete(e),Al(r)}else await vu(r.localStore,e,!1).then((()=>El(r,e,n))).catch(Ct)}async function bl(t,e){const n=O(t),r=e.batch.batchId;try{const t=await function(t,e){const n=O(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.ds.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=At.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);M(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),r.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=vs();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(n.localStore,e);_l(n,r,null),Tl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Dl(n,t)}catch(t){await Ct(t)}}async function Il(t,e,n){const r=O(t);try{const t=await function(t,e){const n=O(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(M(null!==e),r=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,r))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(r.localStore,e);_l(r,e,n),Tl(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Dl(r,t)}catch(n){await Ct(n)}}function Tl(t,e){(t.Ga.get(e)||[]).forEach((t=>{t.resolve()})),t.Ga.delete(e)}function _l(t,e,n){const r=O(t);let s=r.Wa[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Wa[r.currentUser.toKey()]=s}}function El(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.qa.get(e))t.ka.delete(r),n&&t.La.Ja(r,n);t.qa.delete(e),t.isPrimaryClient&&t.Ka.br(e).forEach((e=>{t.Ka.containsKey(e)||Sl(t,e)}))}function Sl(t,e){t.Qa.delete(e.path.canonicalString());const n=t.$a.get(e);null!==n&&(dc(t.remoteStore,n),t.$a=t.$a.remove(e),t.Ua.delete(n),Al(t))}function xl(t,e,n){for(const r of n)r instanceof sl?(t.Ka.addReference(r.key,e),Cl(t,r)):r instanceof il?(A(al,"Document no longer in limbo: "+r.key),t.Ka.removeReference(r.key,e),t.Ka.containsKey(r.key)||Sl(t,r.key)):R()}function Cl(t,e){const n=e.key,r=n.path.canonicalString();t.$a.get(n)||t.Qa.has(r)||(A(al,"New document in limbo: "+n),t.Qa.add(r),Al(t))}function Al(t){for(;t.Qa.size>0&&t.$a.size<t.maxConcurrentLimboResolutions;){const e=t.Qa.values().next().value;t.Qa.delete(e);const n=new dt(ct.fromString(e)),r=t.za.next();t.Ua.set(r,new cl(n)),t.$a=t.$a.insert(n,r),hc(t.remoteStore,new io(Yr($r(n.path)),r,"TargetPurposeLimboResolution",jt.ae))}}async function Dl(t,e,n){const r=O(t),s=[],i=[],o=[];r.ka.isEmpty()||(r.ka.forEach(((t,a)=>{o.push(r.Ha(a,e,n).then((t=>{var e;if((t||n)&&r.isPrimaryClient){const s=t?!t.fromCache:null===(e=null==n?void 0:n.targetChanges.get(a.targetId))||void 0===e?void 0:e.current;r.sharedClientState.updateQueryState(a.targetId,s?"current":"not-current")}if(t){s.push(t);const e=au.Yi(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.La.p_(s),await async function(t,e){const n=O(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>At.forEach(e,(e=>At.forEach(e.Hi,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>At.forEach(e.Ji,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!Ot(t))throw t;A(lu,"Failed to update sequence numbers: "+t)}for(const r of e){const t=r.targetId;if(!r.fromCache){const e=n.Ts.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.Ts=n.Ts.insert(t,s)}}}(r.localStore,i))}async function kl(t,e){const n=O(t);if(!n.currentUser.isEqual(e)){A(al,"User change. New user:",e.toKey());const t=await gu(n.localStore,e);n.currentUser=e,function(t,e){t.Ga.forEach((t=>{t.forEach((t=>{t.reject(new F(L.CANCELLED,e))}))})),t.Ga.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Dl(n,t.Rs)}}function Nl(t,e){const n=O(t),r=n.Ua.get(e);if(r&&r.Ba)return vs().add(r.key);{let t=vs();const r=n.qa.get(e);if(!r)return t;for(const e of r){const r=n.ka.get(e);t=t.unionWith(r.view.Sa)}return t}}async function Rl(t,e){const n=O(t),r=await bu(n.localStore,e.query,!0),s=e.view.Oa(r);return n.isPrimaryClient&&xl(n,e.targetId,s.Ma),s}async function Ml(t,e){const n=O(t);return Tu(n.localStore,e).then((t=>Dl(n,t)))}async function Pl(t,e,n,r){const s=O(t),i=await function(t,e){const n=O(t),r=O(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.Ln(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):At.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await Sc(s.remoteStore):"acknowledged"===n||"rejected"===n?(_l(s,e,r||null),Tl(s,e),function(t,e){O(O(t).mutationQueue).qn(e)}(s.localStore,e)):R(),await Dl(s,i)):A(al,"Cannot apply mutation batch with id: "+e)}async function Ol(t,e,n){const r=O(t),s=[],i=[];for(const o of e){let t;const e=r.qa.get(o);if(e&&0!==e.length){t=await wu(r.localStore,Yr(e[0]));for(const t of e){const e=r.ka.get(t),n=await Rl(r,e);n.snapshot&&i.push(n.snapshot)}}else{const e=await Iu(r.localStore,o);t=await wu(r.localStore,e),await gl(r,Ll(e),o,!1,t.resumeToken)}s.push(t)}return r.La.p_(i),s}function Ll(t){return Gr(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Fl(t){return function(t){return O(O(t).persistence).zi()}(O(t).localStore)}async function Vl(t,e,n,r){const s=O(t);if(s.ja)return void A(al,"Ignoring unexpected query state notification.");const i=s.qa.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await Tu(s.localStore,is(i[0])),r=mi.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,vn.EMPTY_BYTE_STRING);await Dl(s,t,r);break}case"rejected":await vu(s.localStore,e,!0),El(s,e,r);break;default:R()}}async function Ul(t,e,n){const r=ql(t);if(r.ja){for(const t of e){if(r.qa.has(t)&&r.sharedClientState.isActiveQueryTarget(t)){A(al,"Adding an already active target "+t);continue}const e=await Iu(r.localStore,t),n=await wu(r.localStore,e);await gl(r,Ll(e),n.targetId,!1,n.resumeToken),hc(r.remoteStore,n)}for(const t of n)r.qa.has(t)&&await vu(r.localStore,t,!1).then((()=>{dc(r.remoteStore,t),El(r,t)})).catch(Ct)}}function ql(t){const e=O(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=yl.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Nl.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=vl.bind(null,e),e.La.p_=Hc.bind(null,e.eventManager),e.La.Ja=Wc.bind(null,e.eventManager),e}function Bl(t){const e=O(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=bl.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Il.bind(null,e),e}class zl{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(t){this.serializer=Ju(t.databaseInfo.databaseId),this.sharedClientState=this.Za(t),this.persistence=this.Xa(t),await this.persistence.start(),this.localStore=this.eu(t),this.gcScheduler=this.tu(t,this.localStore),this.indexBackfillerScheduler=this.nu(t,this.localStore)}tu(t,e){return null}nu(t,e){return null}eu(t){return fu(this.persistence,new cu,t.initialUser,this.serializer)}Xa(t){return new $a(Ha.ri,this.serializer)}Za(t){return new Vu}async terminate(){var t,e;null===(t=this.gcScheduler)||void 0===t||t.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}zl.provider={build:()=>new zl};class jl extends zl{constructor(t){super(),this.cacheSizeBytes=t}tu(t,e){M(this.persistence.referenceDelegate instanceof Wa);const n=this.persistence.referenceDelegate.garbageCollector;return new Ia(n,t.asyncQueue,e)}Xa(t){const e=void 0!==this.cacheSizeBytes?sa.withCacheSize(this.cacheSizeBytes):sa.DEFAULT;return new $a((t=>Wa.ri(t,e)),this.serializer)}}class Kl extends zl{constructor(t,e,n){super(),this.ru=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.ru.initialize(this,t),await Bl(this.ru.syncEngine),await Sc(this.ru.remoteStore),await this.persistence.Ci((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}eu(t){return fu(this.persistence,new cu,t.initialUser,this.serializer)}tu(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Ia(n,t.asyncQueue,e)}nu(t,e){const n=new zt(e,this.persistence);return new Bt(t.asyncQueue,n)}Xa(t){const e=ou(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?sa.withCacheSize(this.cacheSizeBytes):sa.DEFAULT;return new ru(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Yu(),Xu(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(t){return new Vu}}class Gl extends Kl{constructor(t,e){super(t,e,!1),this.ru=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.ru.syncEngine;this.sharedClientState instanceof Fu&&(this.sharedClientState.syncEngine={uo:Pl.bind(null,e),co:Vl.bind(null,e),lo:Ul.bind(null,e),zi:Fl.bind(null,e),ao:Ml.bind(null,e)},await this.sharedClientState.start()),await this.persistence.Ci((async t=>{await async function(t,e){const n=O(t);if(ql(n),Bl(n),!0===e&&!0!==n.ja){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Ol(n,t.toArray());n.ja=!0,await Oc(n.remoteStore,!0);for(const r of e)hc(n.remoteStore,r)}else if(!1===e&&!1!==n.ja){const t=[];let e=Promise.resolve();n.qa.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(El(n,s),vu(n.localStore,s,!0)))),dc(n.remoteStore,s)})),await e,await Ol(n,t),function(t){const e=O(t);e.Ua.forEach(((t,n)=>{dc(e.remoteStore,n)})),e.Ka.Dr(),e.Ua=new Map,e.$a=new ln(dt.comparator)}(n),n.ja=!1,await Oc(n.remoteStore,!1)}}(this.ru.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}Za(t){const e=Yu();if(!Fu.D(e))throw new F(L.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=ou(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Fu(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class $l{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>wl(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=kl.bind(null,this.syncEngine),await Oc(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Kc}createDatastore(t){const e=Ju(t.databaseInfo.databaseId),n=function(t){return new Wu(t)}(t.databaseInfo);return function(t,e,n,r){return new ic(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(t,e,n,r,s){return new uc(t,e,n,r,s)}(this.localStore,this.datastore,t.asyncQueue,(t=>wl(this.syncEngine,t,0)),Bu.D()?new Bu:new Uu)}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new ll(t,e,n,r,s,i);return o&&(a.ja=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t,e;await async function(t){const e=O(t);A(ac,"RemoteStore shutting down."),e.W_.add(5),await lc(e),e.z_.shutdown(),e.j_.set("Unknown")}(this.remoteStore),null===(t=this.datastore)||void 0===t||t.terminate(),null===(e=this.eventManager)||void 0===e||e.terminate()}}function Ql(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10240,n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}$l.provider={build:()=>new $l};class Hl{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.iu(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.iu(this.observer.error,t):D("Uncaught Error in snapshot listener:",t.toString()))}su(){this.muted=!0}iu(t,e){setTimeout((()=>{this.muted||t(e)}),0)}}class Wl{constructor(t,e){this.ou=t,this.serializer=e,this.metadata=new V,this.buffer=new Uint8Array,this._u=new TextDecoder("utf-8"),this.au().then((t=>{t&&t.Ea()?this.metadata.resolve(t.Ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.Ia)}`))}),(t=>this.metadata.reject(t)))}close(){return this.ou.cancel()}async getMetadata(){return this.metadata.promise}async Ya(){return await this.getMetadata(),this.au()}async au(){const t=await this.uu();if(null===t)return null;const e=this._u.decode(t),n=Number(e);isNaN(n)&&this.cu(`length string (${e}) is not valid number`);const r=await this.lu(n);return new tl(JSON.parse(r),t.length+n)}hu(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async uu(){for(;this.hu()<0&&!await this.Pu(););if(0===this.buffer.length)return null;const t=this.hu();t<0&&this.cu("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async lu(t){for(;this.buffer.length<t;)await this.Pu()&&this.cu("Reached the end of bundle when more is expected.");const e=this._u.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}cu(t){throw this.ou.cancel(),new Error(`Invalid bundle format: ${t}`)}async Pu(){const t=await this.ou.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Yl{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new F(L.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const e=await async function(t,e){const n=O(t),r={documents:e.map((t=>Li(n.serializer,t)))},s=await n.Co("BatchGetDocuments",n.serializer.databaseId,ct.emptyPath(),r,e.length),i=new Map;s.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){M(!!e.found),e.found.name,e.found.updateTime;const n=Fi(t,e.found.name),r=Ri(e.found.updateTime),s=e.found.createTime?Ri(e.found.createTime):ot.min(),i=new cr({mapValue:{fields:e.found.fields}});return hr.newFoundDocument(n,r,s,i)}(t,e):"missing"in e?function(t,e){M(!!e.missing),M(!!e.readTime);const n=Fi(t,e.missing),r=Ri(e.readTime);return hr.newNoDocument(n,r)}(t,e):R()}(n.serializer,t);i.set(e.key.toString(),e)}));const o=[];return e.forEach((t=>{const e=i.get(t.toString());M(!!e),o.push(e)})),o}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastTransactionError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Js(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=dt.fromPath(e);this.mutations.push(new Zs(n,this.precondition(n)))})),await async function(t,e){const n=O(t),r={writes:e.map((t=>Ki(n.serializer,t)))};await n.So("Commit",n.serializer.databaseId,ct.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw R();e=ot.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new F(L.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(ot.min())?Us.exists(!1):Us.updateTime(e):Us.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(ot.min()))throw new F(L.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Us.updateTime(e)}return Us.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Xl{constructor(t,e,n,r,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=r,this.deferred=s,this.Tu=n.maxAttempts,this.a_=new Zu(this.asyncQueue,"transaction_retry")}Iu(){this.Tu-=1,this.Eu()}Eu(){this.a_.Xo((async()=>{const t=new Yl(this.datastore),e=this.du(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Au(t)}))))})).catch((t=>{this.Au(t)}))}))}du(t){try{const e=this.updateFunction(t);return!Gt(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Au(t){this.Tu>0&&this.Ru(t)?(this.Tu-=1,this.asyncQueue.enqueueAndForget((()=>(this.Eu(),Promise.resolve())))):this.deferred.reject(t)}Ru(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!ai(e)}return!1}}const Jl="FirestoreClient";class Zl{constructor(t,e,n,r,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=_.UNAUTHENTICATED,this.clientId=Y.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,(async t=>{A(Jl,"Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(A(Jl,"Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();const t=new V;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=Uc(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function th(t,e){t.asyncQueue.verifyOperationInProgress(),A(Jl,"Initializing OfflineComponentProvider");const n=t.configuration;await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await gu(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function eh(t,e){t.asyncQueue.verifyOperationInProgress();const n=await nh(t);A(Jl,"Initializing OnlineComponentProvider"),await e.initialize(n,t.configuration),t.setCredentialChangeListener((t=>Pc(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>Pc(e.remoteStore,n))),t._onlineComponents=e}async function nh(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){A(Jl,"Using user provided OfflineComponentProvider");try{await th(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!function(t){return"FirebaseError"===t.name?t.code===L.FAILED_PRECONDITION||t.code===L.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(n))throw n;k("Error using user provided cache. Falling back to memory cache: "+n),await th(t,new zl)}}else A(Jl,"Using default OfflineComponentProvider"),await th(t,new jl(void 0));return t._offlineComponents}async function rh(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(A(Jl,"Using user provided OnlineComponentProvider"),await eh(t,t._uninitializedComponentsProvider._online)):(A(Jl,"Using default OnlineComponentProvider"),await eh(t,new $l))),t._onlineComponents}function sh(t){return nh(t).then((t=>t.persistence))}function ih(t){return nh(t).then((t=>t.localStore))}function oh(t){return rh(t).then((t=>t.remoteStore))}function ah(t){return rh(t).then((t=>t.syncEngine))}function uh(t){return rh(t).then((t=>t.datastore))}async function ch(t){const e=await rh(t),n=e.eventManager;return n.onListen=hl.bind(null,e.syncEngine),n.onUnlisten=ml.bind(null,e.syncEngine),n.onFirstRemoteStoreListen=dl.bind(null,e.syncEngine),n.onLastRemoteStoreUnlisten=pl.bind(null,e.syncEngine),n}function lh(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=new V;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new Hl({next:a=>{i.su(),e.enqueueAndForget((()=>Qc(t,o)));const u=a.docs.has(n);!u&&a.fromCache?s.reject(new F(L.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&a.fromCache&&r&&"server"===r.source?s.reject(new F(L.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(a)},error:t=>s.reject(t)}),o=new Zc($r(n.path),i,{includeMetadataChanges:!0,Ta:!0});return $c(t,o)}(await ch(t),t.asyncQueue,e,n,r))),r.promise}function hh(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=new V;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new Hl({next:n=>{i.su(),e.enqueueAndForget((()=>Qc(t,o))),n.fromCache&&"server"===r.source?s.reject(new F(L.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new Zc(n,i,{includeMetadataChanges:!0,Ta:!0});return $c(t,o)}(await ch(t),t.asyncQueue,e,n,r))),r.promise}function dh(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?W().encode(t):t,function(t,e){return new Wl(t,e)}(function(t,e){if(t instanceof Uint8Array)return Ql(t,e);if(t instanceof ArrayBuffer)return Ql(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Ju(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=O(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=O(t),r=Ri(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Yr.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(rl(r));const s=new nl(r,t.localStore,e.serializer);let i=await e.Ya();for(;i;){const t=await s.Aa(i);t&&n._updateProgress(t),i=await e.Ya()}const o=await s.complete();return await Dl(t,o.ma,void 0),await function(t,e){const n=O(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Yr.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Va)}catch(t){return k(al,`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(r,e,n).then((t=>{r.sharedClientState.notifyBundleLoaded(t)}))}(await ah(t),s,r)}))}function fh(t){const e={};return void 0!==t.timeoutSeconds&&(e.timeoutSeconds=t.timeoutSeconds),e}const gh=new Map;function mh(t,e,n){if(!n)throw new F(L.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function ph(t,e,n,r){if(!0===e&&!0===r)throw new F(L.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function yh(t){if(!dt.isDocumentKey(t))throw new F(L.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function wh(t){if(dt.isDocumentKey(t))throw new F(L.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function vh(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":R()}function bh(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new F(L.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=vh(t);throw new F(L.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Ih(t,e){if(e<=0)throw new F(L.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}const Th="firestore.googleapis.com",_h=!0;class Eh{constructor(t){var e,n;if(void 0===t.host){if(void 0!==t.ssl)throw new F(L.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=Th,this.ssl=_h}else this.host=t.host,this.ssl=null!==(e=t.ssl)&&void 0!==e?e:_h;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=ra;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<wa)throw new F(L.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}ph("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=fh(null!==(n=t.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(t){if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new F(L.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new F(L.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(t.timeoutSeconds>30)throw new F(L.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(t,e){return t.timeoutSeconds===e.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Sh{constructor(t,e,n,r){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Eh({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new F(L.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new F(L.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Eh(t),this._emulatorOptions=t.emulatorOptions||{},void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new q;switch(t.type){case"firstParty":return new K(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new F(L.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=gh.get(t);e&&(A("ComponentProvider","Removing Datastore"),gh.delete(t),e.terminate())}(this),Promise.resolve()}}function xh(t,e,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};var s;const i=(t=bh(t,Sh))._getSettings(),o=Object.assign(Object.assign({},i),{emulatorOptions:t._getEmulatorOptions()}),a=`${e}:${n}`;i.host!==Th&&i.host!==a&&k("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const c=Object.assign(Object.assign({},i),{host:a,ssl:!1,emulatorOptions:r});if(!(0,u.bD)(c,o)&&(t._setSettings(c),r.mockUserToken)){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=_.MOCK_USER;else{e=(0,u.Fy)(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new F(L.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new _(i)}t._authCredentials=new B(new U(e,n))}}class Ch{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Ch(this.firestore,t,this._query)}}class Ah{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Dh(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Ah(this.firestore,t,this._key)}}class Dh extends Ch{constructor(t,e,n){super(t,e,$r(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Ah(this.firestore,null,new dt(t))}withConverter(t){return new Dh(this.firestore,t,this._path)}}function kh(t,e){for(var n=arguments.length,r=new Array(n>2?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];if(t=(0,u.Ku)(t),mh("collection","path",e),t instanceof Sh){const n=ct.fromString(e,...r);return wh(n),new Dh(t,null,n)}{if(!(t instanceof Ah||t instanceof Dh))throw new F(L.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=t._path.child(ct.fromString(e,...r));return wh(n),new Dh(t.firestore,null,n)}}function Nh(t,e){if(t=bh(t,Sh),mh("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new F(L.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ch(t,null,function(t){return new Kr(ct.emptyPath(),t)}(e))}function Rh(t,e){for(var n=arguments.length,r=new Array(n>2?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];if(t=(0,u.Ku)(t),1===arguments.length&&(e=Y.newId()),mh("doc","path",e),t instanceof Sh){const n=ct.fromString(e,...r);return yh(n),new Ah(t,null,new dt(n))}{if(!(t instanceof Ah||t instanceof Dh))throw new F(L.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=t._path.child(ct.fromString(e,...r));return yh(n),new Ah(t.firestore,t instanceof Dh?t.converter:null,new dt(n))}}function Mh(t,e){return t=(0,u.Ku)(t),e=(0,u.Ku)(e),(t instanceof Ah||t instanceof Dh)&&(e instanceof Ah||e instanceof Dh)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Ph(t,e){return t=(0,u.Ku)(t),e=(0,u.Ku)(e),t instanceof Ch&&e instanceof Ch&&t.firestore===e.firestore&&es(t._query,e._query)&&t.converter===e.converter}const Oh="AsyncQueue";class Lh{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Promise.resolve();this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new Zu(this,"async_queue_retry"),this.Su=()=>{const t=Xu();t&&A(Oh,"Visibility state changed to "+t.visibilityState),this.a_.t_()},this.bu=t;const e=Xu();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Su)}get isShuttingDown(){return this.mu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Du(),this.vu(t)}enterRestrictedMode(t){if(!this.mu){this.mu=!0,this.yu=t||!1;const e=Xu();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Su)}}enqueue(t){if(this.Du(),this.mu)return new Promise((()=>{}));const e=new V;return this.vu((()=>this.mu&&this.yu?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Vu.push(t),this.Cu())))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(t){if(!Ot(t))throw t;A(Oh,"Operation failed with retryable error: "+t)}this.Vu.length>0&&this.a_.Xo((()=>this.Cu()))}}vu(t){const e=this.bu.then((()=>(this.pu=!0,t().catch((t=>{this.gu=t,this.pu=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw D("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.pu=!1,t))))));return this.bu=e,e}enqueueAfterDelay(t,e,n){this.Du(),this.wu.indexOf(t)>-1&&(e=0);const r=Vc.createAndSchedule(this,t,e,n,(t=>this.Fu(t)));return this.fu.push(r),r}Du(){this.gu&&R()}verifyOperationInProgress(){}async Mu(){let t;do{t=this.bu,await t}while(t!==this.bu)}xu(t){for(const e of this.fu)if(e.timerId===t)return!0;return!1}Ou(t){return this.Mu().then((()=>{this.fu.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.fu)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Mu()}))}Nu(t){this.wu.push(t)}Fu(t){const e=this.fu.indexOf(t);this.fu.splice(e,1)}}function Fh(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const r of e)if(r in n&&"function"==typeof n[r])return!0;return!1}(t,["next","error","complete"])}class Vh{constructor(){this._progressObserver={},this._taskCompletionResolver=new V,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Uh=-1;class qh extends Sh{constructor(t,e,n,r){super(t,e,n,r),this.type="firestore",this._queue=new Lh,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const t=this._firestoreClient.terminate();this._queue=new Lh(t),this._firestoreClient=void 0,await t}}}function Bh(t,e,n){n||(n=Rn);const r=(0,i.j6)(t,"firestore");if(r.isInitialized(n)){const t=r.getImmediate({identifier:n}),s=r.getOptions(n);if((0,u.bD)(s,e))return t;throw new F(L.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&void 0!==e.localCache)throw new F(L.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<wa)throw new F(L.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:e,instanceIdentifier:n})}function zh(t,e){const n="object"==typeof t?t:(0,i.Sx)(),r="string"==typeof t?t:e||Rn,s=(0,i.j6)(n,"firestore").getImmediate({identifier:r});if(!s._initialized){const t=(0,u.yU)("firestore");t&&xh(s,...t)}return s}function jh(t){if(t._terminated)throw new F(L.FAILED_PRECONDITION,"The client has already been terminated.");return t._firestoreClient||Kh(t),t._firestoreClient}function Kh(t){var e,n,r;const s=t._freezeSettings(),i=function(t,e,n,r){return new Nn(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,fh(r.experimentalLongPollingOptions),r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,s);t._componentsProvider||(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(t._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),t._firestoreClient=new Zl(t._authCredentials,t._appCheckCredentials,t._queue,i,t._componentsProvider&&function(t){const e=null==t?void 0:t._online.build();return{_offline:null==t?void 0:t._offline.build(e),_online:e}}(t._componentsProvider))}function Gh(t,e){k("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings();return Qh(t,$l.provider,{build:t=>new Kl(t,n.cacheSizeBytes,null==e?void 0:e.forceOwnership)}),Promise.resolve()}async function $h(t){k("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const e=t._freezeSettings();Qh(t,$l.provider,{build:t=>new Gl(t,e.cacheSizeBytes)})}function Qh(t,e,n){if((t=bh(t,qh))._firestoreClient||t._terminated)throw new F(L.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(t._componentsProvider||t._getSettings().localCache)throw new F(L.FAILED_PRECONDITION,"SDK cache is already specified.");t._componentsProvider={_online:e,_offline:n},Kh(t)}function Hh(t){if(t._initialized&&!t._terminated)throw new F(L.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new V;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Nt.D())return Promise.resolve();const e=t+nu;await Nt.delete(e)}(ou(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Wh(t){return function(t){const e=new V;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=O(t);yc(n.remoteStore)||A(al,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=O(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(t===Kt)return void e.resolve();const r=n.Ga.get(t)||[];r.push(e),n.Ga.set(t,r)}catch(t){const n=Uc(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await ah(t),e))),e.promise}(jh(t=bh(t,qh)))}function Yh(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await sh(t),n=await oh(t);return e.setNetworkEnabled(!0),function(t){const e=O(t);return e.W_.delete(0),cc(e)}(n)}))}(jh(t=bh(t,qh)))}function Xh(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await sh(t),n=await oh(t);return e.setNetworkEnabled(!1),async function(t){const e=O(t);e.W_.add(0),await lc(e),e.j_.set("Offline")}(n)}))}(jh(t=bh(t,qh)))}function Jh(t){return(0,i.Us)(t.app,"firestore",t._databaseId.database),t._delete()}function Zh(t,e){const n=jh(t=bh(t,qh)),r=new Vh;return dh(n,t._databaseId,e,r),r}function td(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=O(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Yr.getNamedQuery(t,e)))}(await ih(t),e)))}(jh(t=bh(t,qh)),e).then((e=>e?new Ch(t,null,e.query):null))}class ed{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"count",e=arguments.length>1?arguments[1]:void 0;this._internalFieldPath=e,this.type="AggregateField",this.aggregateType=t}}class nd{constructor(t,e,n){this._userDataWriter=e,this._data=n,this.type="AggregateQuerySnapshot",this.query=t}data(){return this._userDataWriter.convertObjectMap(this._data)}}class rd{constructor(t){this._byteString=t}static fromBase64String(t){try{return new rd(vn.fromBase64String(t))}catch(t){throw new F(L.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new rd(vn.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class sd{constructor(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(let r=0;r<e.length;++r)if(0===e[r].length)throw new F(L.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ht(e)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function id(){return new sd(at)}class od{constructor(t){this._methodName=t}}class ad{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new F(L.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new F(L.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return X(this._lat,t._lat)||X(this._long,t._long)}}class ud{constructor(t){this._values=(t||[]).map((t=>t))}toArray(){return this._values.map((t=>t))}isEqual(t){return function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}(this._values,t._values)}}const cd=/^__.*__$/;class ld{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Hs(t,this.data,this.fieldMask,e,this.fieldTransforms):new Qs(t,this.data,e,this.fieldTransforms)}}class hd{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Hs(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function dd(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw R()}}class fd{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Bu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(t){return new fd(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.ku({path:n,Qu:!1});return r.$u(t),r}Uu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.ku({path:n,Qu:!1});return r.Bu(),r}Ku(t){return this.ku({path:void 0,Qu:!0})}Wu(t){return Md(t,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Bu(){if(this.path)for(let t=0;t<this.path.length;t++)this.$u(this.path.get(t))}$u(t){if(0===t.length)throw this.Wu("Document fields must not be empty");if(dd(this.Lu)&&cd.test(t))throw this.Wu('Document fields cannot begin and end with "__"')}}class gd{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||Ju(t)}ju(t,e,n){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new fd({Lu:t,methodName:e,zu:n,path:ht.emptyPath(),Qu:!1,Gu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function md(t){const e=t._freezeSettings(),n=Ju(t._databaseId);return new gd(t._databaseId,!!e.ignoreUndefinedProperties,n)}function pd(t,e,n,r,s){let i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const o=t.ju(i.merge||i.mergeFields?2:0,e,n,s);Dd("Data must be an object, but it was:",o,r);const a=Cd(r,o);let u,c;if(i.merge)u=new pn(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=kd(e,r,n);if(!o.contains(s))throw new F(L.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Pd(t,s)||t.push(s)}u=new pn(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new ld(new cr(a),u,c)}class yd extends od{_toFieldTransform(t){if(2!==t.Lu)throw 1===t.Lu?t.Wu(`${this._methodName}() can only appear at the top level of your update data`):t.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof yd}}function wd(t,e,n){return new fd({Lu:3,zu:e.settings.zu,methodName:t._methodName,Qu:n},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class vd extends od{_toFieldTransform(t){return new Fs(t.path,new Ds)}isEqual(t){return t instanceof vd}}class bd extends od{constructor(t,e){super(t),this.Hu=e}_toFieldTransform(t){const e=wd(this,t,!0),n=this.Hu.map((t=>xd(t,e))),r=new ks(n);return new Fs(t.path,r)}isEqual(t){return t instanceof bd&&(0,u.bD)(this.Hu,t.Hu)}}class Id extends od{constructor(t,e){super(t),this.Hu=e}_toFieldTransform(t){const e=wd(this,t,!0),n=this.Hu.map((t=>xd(t,e))),r=new Rs(n);return new Fs(t.path,r)}isEqual(t){return t instanceof Id&&(0,u.bD)(this.Hu,t.Hu)}}class Td extends od{constructor(t,e){super(t),this.Ju=e}_toFieldTransform(t){const e=new Ps(t.serializer,Es(t.serializer,this.Ju));return new Fs(t.path,e)}isEqual(t){return t instanceof Td&&this.Ju===t.Ju}}function _d(t,e,n,r){const s=t.ju(1,e,n);Dd("Data must be an object, but it was:",s,r);const i=[],o=cr.empty();an(r,((t,r)=>{const a=Rd(e,t,n);r=(0,u.Ku)(r);const c=s.Uu(a);if(r instanceof yd)i.push(a);else{const t=xd(r,c);null!=t&&(i.push(a),o.set(a,t))}}));const a=new pn(i);return new hd(o,a,s.fieldTransforms)}function Ed(t,e,n,r,s,i){const o=t.ju(1,e,n),a=[kd(e,r,n)],c=[s];if(i.length%2!=0)throw new F(L.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let u=0;u<i.length;u+=2)a.push(kd(e,i[u])),c.push(i[u+1]);const l=[],h=cr.empty();for(let f=a.length-1;f>=0;--f)if(!Pd(l,a[f])){const t=a[f];let e=c[f];e=(0,u.Ku)(e);const n=o.Uu(t);if(e instanceof yd)l.push(t);else{const r=xd(e,n);null!=r&&(l.push(t),h.set(t,r))}}const d=new pn(l);return new hd(h,d,o.fieldTransforms)}function Sd(t,e,n){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return xd(n,t.ju(r?4:3,e))}function xd(t,e){if(Ad(t=(0,u.Ku)(t)))return Dd("Unsupported field value:",e,t),Cd(t,e);if(t instanceof od)return function(t,e){if(!dd(e.Lu))throw e.Wu(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Wu(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Qu&&4!==e.Lu)throw e.Wu("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=xd(s,e.Ku(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,u.Ku)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Es(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=it.fromDate(t);return{timestampValue:Di(e.serializer,n)}}if(t instanceof it){const n=new it(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Di(e.serializer,n)}}if(t instanceof ad)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof rd)return{bytesValue:ki(e.serializer,t._byteString)};if(t instanceof Ah){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.Wu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Mi(t.firestore._databaseId||e.databaseId,t._key.path)}}if(t instanceof ud)return function(t,e){return{mapValue:{fields:{[Pn]:{stringValue:Fn},[Vn]:{arrayValue:{values:t.toArray().map((t=>{if("number"!=typeof t)throw e.Wu("VectorValues must only contain numeric values.");return Ts(e.serializer,t)}))}}}}}}(t,e);throw e.Wu(`Unsupported field value: ${vh(t)}`)}(t,e)}function Cd(t,e){const n={};return cn(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):an(t,((t,r)=>{const s=xd(r,e.qu(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function Ad(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof it||t instanceof ad||t instanceof rd||t instanceof Ah||t instanceof od||t instanceof ud)}function Dd(t,e,n){if(!Ad(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=vh(n);throw"an object"===r?e.Wu(t+" a custom object"):e.Wu(t+" "+r)}}function kd(t,e,n){if((e=(0,u.Ku)(e))instanceof sd)return e._internalPath;if("string"==typeof e)return Rd(t,e);throw Md("Field path arguments must be of type string or ",t,!1,void 0,n)}const Nd=new RegExp("[~\\*/\\[\\]]");function Rd(t,e,n){if(e.search(Nd)>=0)throw Md(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new sd(...e.split("."))._internalPath}catch(r){throw Md(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Md(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new F(L.INVALID_ARGUMENT,a+t+u)}function Pd(t,e){return t.some((t=>t.isEqual(e)))}class Od{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Ah(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Ld(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Fd("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Ld extends Od{data(){return super.data()}}function Fd(t,e){return"string"==typeof e?Rd(t,e):e instanceof sd?e._internalPath:e._delegate._internalPath}function Vd(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new F(L.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Ud{}class qd extends Ud{}function Bd(t,e){let n=[];for(var r=arguments.length,s=new Array(r>2?r-2:0),i=2;i<r;i++)s[i-2]=arguments[i];e instanceof Ud&&n.push(e),n=n.concat(s),function(t){const e=t.filter((t=>t instanceof Kd)).length,n=t.filter((t=>t instanceof zd)).length;if(e>1||e>0&&n>0)throw new F(L.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(const o of n)t=o._apply(t);return t}class zd extends qd{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new zd(t,e,n)}_apply(t){const e=this._parse(t);return uf(t._query,e),new Ch(t.firestore,t.converter,Zr(t._query,e))}_parse(t){const e=md(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new F(L.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){af(o,i);const e=[];for(const n of o)e.push(of(r,t,n));a={arrayValue:{values:e}}}else a=of(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||af(o,i),a=Sd(n,e,o,"in"===i||"not-in"===i);return wr.create(s,i,a)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function jd(t,e,n){const r=e,s=Fd("where",t);return zd._create(s,r,n)}class Kd extends Ud{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Kd(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:vr.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const r=e.getFlattenedFilters();for(const s of r)uf(n,s),n=Zr(n,s)}(t._query,e),new Ch(t.firestore,t.converter,Zr(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function Gd(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return e.forEach((t=>cf("or",t))),Kd._create("or",e)}function $d(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return e.forEach((t=>cf("and",t))),Kd._create("and",e)}class Qd extends qd{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new Qd(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new F(L.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new F(L.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new mr(e,n)}(t._query,this._field,this._direction);return new Ch(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Kr(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function Hd(t){const e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc",n=Fd("orderBy",t);return Qd._create(n,e)}class Wd extends qd{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new Wd(t,e,n)}_apply(t){return new Ch(t.firestore,t.converter,ts(t._query,this._limit,this._limitType))}}function Yd(t){return Ih("limit",t),Wd._create("limit",t,"F")}function Xd(t){return Ih("limitToLast",t),Wd._create("limitToLast",t,"L")}class Jd extends qd{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new Jd(t,e,n)}_apply(t){const e=sf(t,this.type,this._docOrFields,this._inclusive);return new Ch(t.firestore,t.converter,function(t,e){return new Kr(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function Zd(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Jd._create("startAt",e,!0)}function tf(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Jd._create("startAfter",e,!1)}class ef extends qd{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new ef(t,e,n)}_apply(t){const e=sf(t,this.type,this._docOrFields,this._inclusive);return new Ch(t.firestore,t.converter,function(t,e){return new Kr(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function nf(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return ef._create("endBefore",e,!1)}function rf(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return ef._create("endAt",e,!0)}function sf(t,e,n,r){if(n[0]=(0,u.Ku)(n[0]),n[0]instanceof Od)return function(t,e,n,r,s){if(!r)throw new F(L.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Wr(t))if(o.field.isKeyField())i.push(Wn(e,r.key));else{const t=r.data.field(o.field);if(An(t))throw new F(L.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=o.field.canonicalString();throw new F(L.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new dr(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=md(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new F(L.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let u=0;u<s.length;u++){const i=s[u];if(o[u].field.isKeyField()){if("string"!=typeof i)throw new F(L.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Hr(t)&&-1!==i.indexOf("/"))throw new F(L.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=t.path.child(ct.fromString(i));if(!dt.isDocumentKey(n))throw new F(L.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new dt(n);a.push(Wn(e,s))}else{const t=Sd(n,r,i);a.push(t)}}return new dr(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function of(t,e,n){if("string"==typeof(n=(0,u.Ku)(n))){if(""===n)throw new F(L.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Hr(e)&&-1!==n.indexOf("/"))throw new F(L.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(ct.fromString(n));if(!dt.isDocumentKey(r))throw new F(L.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Wn(t,new dt(r))}if(n instanceof Ah)return Wn(t,n._key);throw new F(L.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${vh(n)}.`)}function af(t,e){if(!Array.isArray(t)||0===t.length)throw new F(L.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function uf(t,e){const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new F(L.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new F(L.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}function cf(t,e){if(!(e instanceof zd||e instanceof Kd))throw new F(L.INVALID_ARGUMENT,`Function ${t}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class lf{convertValue(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none";switch(qn(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Tn(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(_n(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw R()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none";const n={};return an(t,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertVectorValue(t){var e,n,r;const s=null===(r=null===(n=null===(e=t.fields)||void 0===e?void 0:e[Vn].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map((t=>Tn(t.doubleValue)));return new ud(s)}convertGeoPoint(t){return new ad(Tn(t.latitude),Tn(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Dn(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(kn(t));default:return null}}convertTimestamp(t){const e=In(t);return new it(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=ct.fromString(t);M(so(n));const r=new Mn(n.get(1),n.get(3)),s=new dt(n.popFirst(5));return r.isEqual(e)||D(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function hf(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class df extends lf{constructor(t){super(),this.firestore=t}convertBytes(t){return new rd(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Ah(this.firestore,null,e)}}function ff(t){return new ed("sum",kd("sum",t))}function gf(t){return new ed("avg",kd("average",t))}function mf(){return new ed("count")}function pf(t,e){var n,r;return t instanceof ed&&e instanceof ed&&t.aggregateType===e.aggregateType&&(null===(n=t._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=e._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function yf(t,e){return Ph(t.query,e.query)&&(0,u.bD)(t.data(),e.data())}class wf{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class vf extends Od{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._document){if(this._converter){const e=new bf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._document){const n=this._document.data.field(Fd("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class bf extends vf{data(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return super.data(t)}}class If{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new wf(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new bf(this._firestore,this._userDataWriter,n.key,n,new wf(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(){const t=!!(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new F(L.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const r=new bf(t._firestore,t._userDataWriter,n.doc.key,n.doc,new wf(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new bf(t._firestore,t._userDataWriter,e.doc.key,e.doc,new wf(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Tf(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Tf(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return R()}}function _f(t,e){return t instanceof vf&&e instanceof vf?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof If&&e instanceof If&&t._firestore===e._firestore&&Ph(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Ef(t){t=bh(t,Ah);const e=bh(t.firestore,qh);return lh(jh(e),t._key).then((n=>Vf(e,t,n)))}class Sf extends lf{constructor(t){super(),this.firestore=t}convertBytes(t){return new rd(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Ah(this.firestore,null,e)}}function xf(t){t=bh(t,Ah);const e=bh(t.firestore,qh),n=jh(e),r=new Sf(e);return function(t,e){const n=new V;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=O(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new F(L.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=Uc(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await ih(t),e,n))),n.promise}(n,t._key).then((n=>new vf(e,r,t._key,n,new wf(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Cf(t){t=bh(t,Ah);const e=bh(t.firestore,qh);return lh(jh(e),t._key,{source:"server"}).then((n=>Vf(e,t,n)))}function Af(t){t=bh(t,Ch);const e=bh(t.firestore,qh),n=jh(e),r=new Sf(e);return Vd(t._query),hh(n,t._query).then((n=>new If(e,r,t,n)))}function Df(t){t=bh(t,Ch);const e=bh(t.firestore,qh),n=jh(e),r=new Sf(e);return function(t,e){const n=new V;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await bu(t,e,!0),s=new ol(e,r.gs),i=s.ba(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=Uc(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await ih(t),e,n))),n.promise}(n,t._query).then((n=>new If(e,r,t,n)))}function kf(t){t=bh(t,Ch);const e=bh(t.firestore,qh),n=jh(e),r=new Sf(e);return hh(n,t._query,{source:"server"}).then((n=>new If(e,r,t,n)))}function Nf(t,e,n){t=bh(t,Ah);const r=bh(t.firestore,qh),s=hf(t.converter,e,n);return Ff(r,[pd(md(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,Us.none())])}function Rf(t,e,n){t=bh(t,Ah);const r=bh(t.firestore,qh),s=md(r);let i;for(var o=arguments.length,a=new Array(o>3?o-3:0),c=3;c<o;c++)a[c-3]=arguments[c];return i="string"==typeof(e=(0,u.Ku)(e))||e instanceof sd?Ed(s,"updateDoc",t._key,e,n,a):_d(s,"updateDoc",t._key,e),Ff(r,[i.toMutation(t._key,Us.exists(!0))])}function Mf(t){return Ff(bh(t.firestore,qh),[new Js(t._key,Us.none())])}function Pf(t,e){const n=bh(t.firestore,qh),r=Rh(t),s=hf(t.converter,e);return Ff(n,[pd(md(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,Us.exists(!1))]).then((()=>r))}function Of(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var s,i,o;t=(0,u.Ku)(t);let a={includeMetadataChanges:!1,source:"default"},c=0;"object"!=typeof n[c]||Fh(n[c])||(a=n[c],c++);const l={includeMetadataChanges:a.includeMetadataChanges,source:a.source};if(Fh(n[c])){const t=n[c];n[c]=null===(s=t.next)||void 0===s?void 0:s.bind(t),n[c+1]=null===(i=t.error)||void 0===i?void 0:i.bind(t),n[c+2]=null===(o=t.complete)||void 0===o?void 0:o.bind(t)}let h,d,f;if(t instanceof Ah)d=bh(t.firestore,qh),f=$r(t._key.path),h={next:e=>{n[c]&&n[c](Vf(d,t,e))},error:n[c+1],complete:n[c+2]};else{const e=bh(t,Ch);d=bh(e.firestore,qh),f=e._query;const r=new Sf(d);h={next:t=>{n[c]&&n[c](new If(d,r,e,t))},error:n[c+1],complete:n[c+2]},Vd(t._query)}return function(t,e,n,r){const s=new Hl(r),i=new Zc(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>$c(await ch(t),i))),()=>{s.su(),t.asyncQueue.enqueueAndForget((async()=>Qc(await ch(t),i)))}}(jh(d),f,l,h)}function Lf(t,e){return function(t,e){const n=new Hl(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){O(t).ia.add(e),e.next()}(await ch(t),n))),()=>{n.su(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){O(t).ia.delete(e)}(await ch(t),n)))}}(jh(t=bh(t,qh)),Fh(e)?e:{next:e})}function Ff(t,e){return function(t,e){const n=new V;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=Bl(t);try{const t=await function(t,e){const n=O(t),r=it.now(),s=e.reduce(((t,e)=>t.add(e.key)),vs());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=ls(),u=vs();return n.ds.getEntries(t,s).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((s=>{i=s;const o=[];for(const t of e){const e=Gs(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new Hs(t.key,e,lr(e.value.mapValue),Us.exists(!0)))}return n.mutationQueue.addMutationBatch(t,r,o,e)})).next((e=>{o=e;const r=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:fs(i)})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Wa[t.currentUser.toKey()];r||(r=new ln(X)),r=r.insert(e,n),t.Wa[t.currentUser.toKey()]=r}(r,t.batchId,n),await Dl(r,t.changes),await Sc(r.remoteStore)}catch(t){const e=Uc(t,"Failed to persist write");n.reject(e)}}(await ah(t),e,n))),n.promise}(jh(t),e)}function Vf(t,e,n){const r=n.docs.get(e._key),s=new Sf(t);return new vf(t,s,e._key,r,new wf(n.hasPendingWrites,n.fromCache),e.converter)}function Uf(t){return qf(t,{count:mf()})}function qf(t,e){const n=bh(t.firestore,qh),r=jh(n),s=un(e,((t,e)=>new ri(e,t.aggregateType,t._internalFieldPath)));return function(t,e,n){const r=new V;return t.asyncQueue.enqueueAndForget((async()=>{try{const s=await uh(t);r.resolve(async function(t,e,n){var r;const s=O(t),{request:i,Pt:o,parent:a}=Hi(s.serializer,Xr(e),n);s.connection.fo||delete i.parent;const u=(await s.Co("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((t=>!!t.result));M(1===u.length);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce(((t,e)=>(t[o[e]]=c[e],t)),{})}(s,e,n))}catch(t){r.reject(t)}})),r.promise}(r,t._query,s).then((e=>function(t,e,n){const r=new Sf(t);return new nd(e,r,n)}(n,t,e)))}class Bf{constructor(t){this.kind="memory",this._onlineComponentProvider=$l.provider,(null==t?void 0:t.garbageCollector)?this._offlineComponentProvider=t.garbageCollector._offlineComponentProvider:this._offlineComponentProvider={build:()=>new jl(void 0)}}toJSON(){return{kind:this.kind}}}class zf{constructor(t){let e;this.kind="persistent",(null==t?void 0:t.tabManager)?(t.tabManager._initialize(t),e=t.tabManager):(e=Xf(void 0),e._initialize(t)),this._onlineComponentProvider=e._onlineComponentProvider,this._offlineComponentProvider=e._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class jf{constructor(){this.kind="memoryEager",this._offlineComponentProvider=zl.provider}toJSON(){return{kind:this.kind}}}class Kf{constructor(t){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new jl(t)}}toJSON(){return{kind:this.kind}}}function Gf(){return new jf}function $f(t){return new Kf(null==t?void 0:t.cacheSizeBytes)}function Qf(t){return new Bf(t)}function Hf(t){return new zf(t)}class Wf{constructor(t){this.forceOwnership=t,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=$l.provider,this._offlineComponentProvider={build:e=>new Kl(e,null==t?void 0:t.cacheSizeBytes,this.forceOwnership)}}}class Yf{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=$l.provider,this._offlineComponentProvider={build:e=>new Gl(e,null==t?void 0:t.cacheSizeBytes)}}}function Xf(t){return new Wf(null==t?void 0:t.forceOwnership)}function Jf(){return new Yf}const Zf={maxAttempts:5};class tg{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=md(t)}set(t,e,n){this._verifyNotCommitted();const r=eg(t,this._firestore),s=hf(r.converter,e,n),i=pd(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Us.none())),this}update(t,e,n){this._verifyNotCommitted();const r=eg(t,this._firestore);let s;for(var i=arguments.length,o=new Array(i>3?i-3:0),a=3;a<i;a++)o[a-3]=arguments[a];return s="string"==typeof(e=(0,u.Ku)(e))||e instanceof sd?Ed(this._dataReader,"WriteBatch.update",r._key,e,n,o):_d(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(s.toMutation(r._key,Us.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=eg(t,this._firestore);return this._mutations=this._mutations.concat(new Js(e._key,Us.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new F(L.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function eg(t,e){if((t=(0,u.Ku)(t)).firestore!==e)throw new F(L.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class ng{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=md(t)}get(t){const e=eg(t,this._firestore),n=new df(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return R();const r=t[0];if(r.isFoundDocument())return new Od(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Od(this._firestore,n,e._key,null,e.converter);throw R()}))}set(t,e,n){const r=eg(t,this._firestore),s=hf(r.converter,e,n),i=pd(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n){const r=eg(t,this._firestore);let s;for(var i=arguments.length,o=new Array(i>3?i-3:0),a=3;a<i;a++)o[a-3]=arguments[a];return s="string"==typeof(e=(0,u.Ku)(e))||e instanceof sd?Ed(this._dataReader,"Transaction.update",r._key,e,n,o):_d(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,s),this}delete(t){const e=eg(t,this._firestore);return this._transaction.delete(e._key),this}}class rg extends ng{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=eg(t,this._firestore),n=new Sf(this._firestore);return super.get(t).then((t=>new vf(this._firestore,n,e._key,t._document,new wf(!1,!1),e.converter)))}}function sg(t,e,n){t=bh(t,qh);const r=Object.assign(Object.assign({},Zf),n);return function(t){if(t.maxAttempts<1)throw new F(L.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,e,n){const r=new V;return t.asyncQueue.enqueueAndForget((async()=>{const s=await uh(t);new Xl(t.asyncQueue,s,n,e,r).Iu()})),r.promise}(jh(t),(n=>e(new rg(t,n))),r)}function ig(){return new yd("deleteField")}function og(){return new vd("serverTimestamp")}function ag(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return new bd("arrayUnion",e)}function ug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return new Id("arrayRemove",e)}function cg(t){return new Td("increment",t)}function lg(t){return new ud(t)}function hg(t){return jh(t=bh(t,qh)),new tg(t,(e=>Ff(t,e)))}function dg(t,e){const n=jh(t=bh(t,qh));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return k("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(t){const e="string"==typeof t?function(t){try{return JSON.parse(t)}catch(t){throw new F(L.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==t?void 0:t.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const r of e.indexes){const t=fg(r,"collectionGroup"),e=[];if(Array.isArray(r.fields))for(const n of r.fields){const t=Rd("setIndexConfiguration",fg(n,"fieldPath"));"CONTAINS"===n.arrayConfig?e.push(new wt(t,2)):"ASCENDING"===n.order?e.push(new wt(t,0)):"DESCENDING"===n.order&&e.push(new wt(t,1))}n.push(new gt(gt.UNKNOWN_ID,t,e,bt.empty()))}return n}(e);return function(t,e){return t.asyncQueue.enqueue((async()=>async function(t,e){const n=O(t),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>r.getFieldIndexes(t).next((n=>function(t,e,n,r,s){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(t[u],e[a]);i<0?s(t[u++]):i>0?r(e[a++]):(a++,u++)}for(;a<o;)r(e[a++]);for(;u<i;)s(t[u++])}(n,e,yt,(e=>{s.push(r.addFieldIndex(t,e))}),(e=>{s.push(r.deleteFieldIndex(t,e))})))).next((()=>At.waitFor(s)))))}(await ih(t),e)))}(n,r)}function fg(t,e){if("string"!=typeof t[e])throw new F(L.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}class gg{constructor(t){this._firestore=t,this.type="PersistentCacheIndexManager"}}function mg(t){var e;t=bh(t,qh);const n=bg.get(t);if(n)return n;if("persistent"!==(null===(e=jh(t)._uninitializedComponentsProvider)||void 0===e?void 0:e._offline.kind))return null;const r=new gg(t);return bg.set(t,r),r}function pg(t){vg(t,!0)}function yg(t){vg(t,!1)}function wg(t){(function(t){return t.asyncQueue.enqueue((async()=>function(t){const e=O(t),n=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",(t=>n.deleteAllFieldIndexes(t)))}(await ih(t))))})(jh(t._firestore)).then((t=>A("deleting all persistent cache indexes succeeded"))).catch((t=>k("deleting all persistent cache indexes failed",t)))}function vg(t,e){(function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){O(t).Ps.Xi=e}(await ih(t),e)))})(jh(t._firestore),e).then((t=>A(`setting persistent cache index auto creation isEnabled=${e} succeeded`))).catch((t=>k(`setting persistent cache index auto creation isEnabled=${e} failed`,t)))}const bg=new WeakMap;function Ig(t){var e;const n=null===(e=jh(bh(t.firestore,qh))._onlineComponents)||void 0===e?void 0:e.datastore.serializer;return void 0===n?null:Qi(n,Yr(t._query)).ht}function Tg(t,e){var n;const r=un(e,((t,e)=>new ri(e,t.aggregateType,t._internalFieldPath))),s=null===(n=jh(bh(t.firestore,qh))._onlineComponents)||void 0===n?void 0:n.datastore.serializer;return void 0===s?null:Hi(s,Xr(t._query),r,!0).request}class _g{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(t){return Eg.instance.onExistenceFilterMismatch(t)}}class Eg{constructor(){this.Yu=new Map}static get instance(){return Sg||(Sg=new Eg,function(t){if(ci)throw new Error("a TestingHooksSpi instance is already set");ci=t}(Sg)),Sg}rt(t){this.Yu.forEach((e=>e(t)))}onExistenceFilterMismatch(t){const e=Symbol(),n=this.Yu;return n.set(e,t),()=>n.delete(e)}}let Sg=null;!function(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!function(t){E=t}(i.MF),(0,i.om)(new o.uA("firestore",((t,n)=>{let{instanceIdentifier:r,options:s}=n;const i=t.getProvider("app").getImmediate(),o=new qh(new z(t.getProvider("auth-internal")),new $(i,t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new F(L.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Mn(t.options.projectId,e)}(i,r),i);return s=Object.assign({useFetchStreams:e},s),o._setSettings(s),o}),"PUBLIC").setMultipleInstances(!0)),(0,i.KO)(I,T,t),(0,i.KO)(I,T,"esm2017")}()}}]);
//# sourceMappingURL=857.62eb44a1.chunk.js.map