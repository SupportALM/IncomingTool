"use strict";(self.webpackChunkincoming_tool=self.webpackChunkincoming_tool||[]).push([[894],{612:(e,t,i)=>{i.d(t,{Q:()=>r});var s=i(8613),o=i(8006),l=i(161);const r=e=>{const[t,i]=(0,s.useState)([]),[r,n]=(0,s.useState)(!0),[a,d]=(0,s.useState)(null),[c,u]=(0,s.useState)(""),[m,g]=(0,s.useState)("All"),[p,h]=(0,s.useState)(!1);(0,s.useEffect)((()=>{if(console.log("[useStockItems] useEffect: Checking db and orgId:",{db_instance:l.db,org_id:e}),!l.db||!e)return console.warn("[useStockItems] useEffect: db or orgId is missing, skipping Firestore query."),n(!1),void(e||i([]));n(!0),d(null),console.log(`[useStockItems] useEffect: Setting up listener for orgs/${e}/stockItems`);const t=(0,o.query)((0,o.collection)(l.db,"orgs",e,"stockItems"),(0,o.orderBy)("orderDate","desc")),s=(0,o.onSnapshot)(t,(e=>{console.log("[useStockItems] useEffect: Received snapshot.");const t=e.docs.map((e=>({id:e.id,...e.data()})));i(t),n(!1)}),(e=>{console.error("[useStockItems] useEffect: Snapshot error:",e),d("Failed to load items: "+e.message),n(!1)}));return()=>{console.log("[useStockItems] useEffect: Cleaning up listener."),s()}}),[e]);const A=(0,s.useMemo)((()=>t.filter((e=>{const t=c.toLowerCase(),i=e.deliveryName&&"string"===typeof e.deliveryName&&e.deliveryName.toLowerCase().includes(t)||e.productName&&"string"===typeof e.productName&&e.productName.toLowerCase().includes(t)||e.seller&&"string"===typeof e.seller&&e.seller.toLowerCase().includes(t)||e.asinSku&&"string"===typeof e.asinSku&&e.asinSku.toLowerCase().includes(t);let s=!1;s="All"===m||("Late"===m?(e=>{if("Pending Delivery"!==e.currentStatus)return!1;const t=new Date(e.orderDate),i=new Date;return i.setDate(i.getDate()-7),t<i})(e):e.currentStatus===m);const o=!p||!0===e.isFlagged;return s&&i&&o}))),[t,c,m,p]);return{allItems:t,items:A,loading:r,error:a,searchTerm:c,currentFilter:m,showFlaggedOnly:p,setSearchTerm:u,setCurrentFilter:g,setShowFlaggedOnly:h,setError:d}}},5929:(e,t,i)=>{i.r(t),i.d(t,{ActionMenu:()=>K,default:()=>ee,getAvailableActions:()=>Q});var s=i(8613),o=i(9284),l=i(8677),r=i(1024),n=i(8006),a=i(6623),d=i(8512),c=i(9801),u=i(6185),m=i(2731),g=i(267),p=i(6748),h=i(6393),A=i(5495),v=i(2967),x=i(5895),b=i(6647),S=i(3287),f=i(5557),y=i(5359),j=i(1),I=i(2571),D=i(5847),w=i(5303),k=i(8229),N=i(6687),C=i(6859),E=i(2523),T=i(2011),F=i(4755),O=i(9841),_=i(1399),L=i(2043),z=i(2950),P=i(6936),R=i(2327),U=i(9161),$=i(9963),M=i(2422),q=i(6384),G=i(210),W=i(161),B=i(612),H=i(579);console.log("[IncomingTool] ToolApp.tsx: Top level, imported db is:",W.db);const V=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{timestamp:(new Date).toISOString(),type:t,userId:e,details:i}},Q=(e,t)=>{let i=[];switch(e){case"Pending Delivery":case"Late":i=[{id:"Mark as Delivered",label:"Mark as Delivered",description:"Update status to Delivered"},{id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:(0,H.jsx)(q.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,H.jsx)(G.A,{fontSize:"small"})}];break;case"Delivered":i=[{id:"Archive",label:"Archive",description:"Archive this item",icon:(0,H.jsx)($.A,{fontSize:"small"})},{id:"Report Issue",label:"Report Issue",description:"Report an issue with this item",icon:(0,H.jsx)(q.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,H.jsx)(G.A,{fontSize:"small"})}];break;case"Issue":i=[{id:"Resolve Issue",label:"Resolve Issue",description:"Mark the issue as resolved"},{id:"Add Issue Update",label:"Add Issue Update",description:"Add an update note to the ongoing issue"},{id:"Archive",label:"Archive",description:"Archive this item",icon:(0,H.jsx)($.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a general note to the item history",icon:(0,H.jsx)(G.A,{fontSize:"small"})}];break;case"Archived":i=[{id:"Unarchive Item",label:"Unarchive",description:"Restore this item from archive",icon:(0,H.jsx)(M.A,{fontSize:"small"})},{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,H.jsx)(G.A,{fontSize:"small"})}];break;default:i=[{id:"Add Note",label:"Add Note",description:"Add a note to the item history",icon:(0,H.jsx)(G.A,{fontSize:"small"})}]}return"Archived"!==e&&i.unshift(t?{id:"action_unflag",label:"Unflag",description:"Remove the flag from this item",icon:(0,H.jsx)(R.A,{fontSize:"small",color:"disabled"})}:{id:"action_flag",label:"Flag",description:"Flag this item for attention",icon:(0,H.jsx)(R.A,{fontSize:"small"})}),i},K=e=>{let{itemId:t,actions:i,onActionSelected:s,onClose:o,anchorEl:l,open:r}=e;return(0,H.jsx)(a.A,{anchorEl:l,open:r,onClose:o,MenuListProps:{"aria-labelledby":`actions-button-${t}`},children:i.map((e=>(0,H.jsxs)(d.A,{onClick:()=>(e=>{s(t,e),o()})(e),children:[e.icon&&(0,H.jsx)(c.A,{sx:{minWidth:"32px"},children:e.icon}),(0,H.jsx)(u.A,{primary:e.label})]},e.id)))})},J=[{id:"orderDate",label:"Order Date"},{id:"quantity",label:"Qty"},{id:"productName",label:"Product Name"},{id:"deliveryName",label:"Delivery Name"},{id:"pricePerItem",label:"Price/Item"},{id:"seller",label:"Seller/Source"},{id:"destination",label:"Destination"},{id:"asinSku",label:"ASIN/SKU"},{id:"purchaseStatus",label:"Purchase Status"},{id:"orderNumber",label:"Order #"},{id:"currentStatus",label:"Status"},{id:"isFlagged",label:"Flagged"},{id:"acquisitionNotes",label:"Acquisition Notes"},{id:"issueDescription",label:"Issue Description"},{id:"dateDelivered",label:"Date Delivered"},{id:"actions",label:"Actions"}],Y=["orderDate","quantity","productName","deliveryName","currentStatus","actions"],X="incomingTool_visibleColumns",Z=e=>{let{column:t}=e;const{attributes:i,listeners:s,setNodeRef:o,transform:n,transition:a,isDragging:d}=(0,l.gl)({id:t.id}),c={transform:r.Ks.Transform.toString(n),transition:a,opacity:d?.5:1,touchAction:"none"},u=["quantity","pricePerItem"].includes(t.id);return(0,H.jsxs)(m.A,{ref:o,component:"th",scope:"col",style:c,...i,...s,align:u?"right":"left",sx:{fontWeight:"bold",cursor:"grab",whiteSpace:"nowrap",bgcolor:d?"#e0e0e0":"background.paper",..."isFlagged"===t.id&&{width:50,p:"6px 8px"},..."seller"===t.id&&{minWidth:140},..."deliveryName"===t.id&&{minWidth:160},..."quantity"===t.id&&{width:80},..."destination"===t.id&&{minWidth:110},..."pricePerItem"===t.id&&{width:100},..."orderNumber"===t.id&&{width:110},..."purchaseStatus"===t.id&&{width:110},..."orderDate"===t.id&&{width:110},..."asinSku"===t.id&&{width:120},..."productName"===t.id&&{minWidth:160},..."actions"===t.id&&{width:60,p:"6px 8px"},..."currentStatus"===t.id&&{width:100}},children:[t.label," "]})},ee=e=>{let{user:t,org:i,permissions:r,logAction:a}=e;console.log("ToolApp Props Received:",{user:t,orgId:null===i||void 0===i?void 0:i.id,permissions:r,logActionExists:!!a}),console.log("ToolApp using imported db:",W.db),console.log("ToolApp using imported auth:",W.auth);const{items:d,allItems:c,loading:u,error:$,searchTerm:M,currentFilter:q,showFlaggedOnly:G,setSearchTerm:Q,setCurrentFilter:K,setShowFlaggedOnly:ee,setError:te}=(0,B.Q)(null===i||void 0===i?void 0:i.id);console.log("[IncomingTool] useStockItems returned:",{loading:u,error:$,items_length:null===d||void 0===d?void 0:d.length,allItems_length:null===c||void 0===c?void 0:c.length,currentFilter:q,showFlaggedOnly:G,searchTerm:M});const[ie,se]=(0,s.useState)(null),[oe,le]=(0,s.useState)(!1),[re,ne]=(0,s.useState)(null),[ae,de]=(0,s.useState)(null),[ce,ue]=(0,s.useState)(null),[me,ge]=(0,s.useState)(null),[pe,he]=(0,s.useState)(!1),[Ae,ve]=(0,s.useState)(null),[xe,be]=(0,s.useState)(!1),[Se,fe]=(0,s.useState)((()=>{try{const e=localStorage.getItem(X),t=e?JSON.parse(e):Y;return Array.isArray(t)?t:Y}catch($){return console.error("Error reading visible columns from localStorage",$),Y}})),[ye,je]=(0,s.useState)(null),[Ie,De]=(0,s.useState)(null);(0,s.useEffect)((()=>{localStorage.setItem(X,JSON.stringify(Se))}),[Se]);const we=Se.map((e=>J.find((t=>t.id===e)))).filter((e=>void 0!==e)),ke=(0,s.useCallback)((async(e,t,s,o)=>{if(console.log("[IncomingTool] updateItemAndLog: Checking db and org.id:",{db_instance:W.db,org_id:null===i||void 0===i?void 0:i.id}),!W.db||null===i||void 0===i||!i.id||!t)return console.error("Cannot update item: Missing configuration.",{db:!!W.db,orgId:null===i||void 0===i?void 0:i.id,userId:t}),void te("Cannot update item: Missing configuration.");console.log(`[IncomingTool] updateItemAndLog: Preparing to update item ${e} in org ${i.id}`);const l=(0,n.doc)(W.db,"orgs",i.id,"stockItems",e),r=c.find((t=>t.id===e));if(!r)return console.error(`Item ${e} not found for update`),void te(`Item ${e} not found.`);const d=(u={...s,lastUpdated:(0,n.serverTimestamp)()},Object.fromEntries(Object.entries(u).filter((e=>{let[t,i]=e;return void 0!==i}))));var u;const m={...r,...d};try{if(await(0,n.updateDoc)(l,d),console.log(`Item ${e} updated successfully.`),console.log("updateItemAndLog: Attempting to log action. logAction available?",!!a),a){let t;try{if("EDITED"===o.type)t="item.update.fields";else if("FLAG_TOGGLED"===o.type)t="item.update.flag";else if("STATUS_CHANGED"===o.type){var g,p;t=`item.update.status.${(null===(g=o.details)||void 0===g||null===(p=g.newStatus)||void 0===p?void 0:p.toLowerCase())||"unknown"}`}else t="ISSUE_REPORTED"===o.type?"item.update.issue.report":"ISSUE_RESOLVED"===o.type?"item.update.issue.resolve":"ISSUE_UPDATE_ADDED"===o.type?"item.update.issue.update":"NOTE_ADDED"===o.type?"item.add_note":o.type}catch(h){console.error("Error deriving action name for logging:",h),t=o.type}const s={orgId:i.id,toolKey:"incomingtool",action:t,entityPath:`stockItems/${e}`,...void 0!==r&&{before:r},...void 0!==m&&{after:m},...void 0!==o.details&&{details:o.details}};await a(s)}}catch(A){throw console.error(`Error updating item ${e}:`,A),te(`Failed to update item: ${A.message}`),A}}),[i,c,a,te]),Ne=((0,s.useCallback)((async(e,i)=>{console.log(`Action: ${i.label} on item ${e}`);const s=c.find((t=>t.id===e));if(s)switch(i.id){case"Edit Item":ne(s),le(!0);break;case"Flag Item":case"Unflag Item":const o="Flag Item"===i.id;await ke(e,null===t||void 0===t?void 0:t.uid,{isFlagged:o},V((null===t||void 0===t?void 0:t.uid)||"","FLAG_TOGGLED",{isFlagged:o}));break;case"Mark as Delivered":"Delivered"!==s.currentStatus&&await ke(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Delivered",dateDelivered:(new Date).toISOString()},V((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:s.currentStatus,newStatus:"Delivered"}));break;case"Archive":"Archived"!==s.currentStatus&&await ke(e,null===t||void 0===t?void 0:t.uid,{currentStatus:"Archived"},V((null===t||void 0===t?void 0:t.uid)||"","STATUS_CHANGED",{previousStatus:s.currentStatus,newStatus:"Archived"}));break;case"Add Note":ve(s);break;case"Report Issue":se(null),de(s);break;case"Resolve Issue":se(null),ge(s);break;case"Add Issue Update":se(null),ue(s);break;case"View Details":se(s)}}),[null===t||void 0===t?void 0:t.uid,c,ke,ne,le,de,ue,ge,se]),(0,s.useCallback)((e=>{const t=c.find((t=>t.id===e));return t?(console.log("Viewing details for:",t),i?void se(t):(console.error("Org ID is missing, cannot fetch logs."),void te("Organization context is missing."))):(console.error("Item not found for viewing details:",e),void te("Item not found."))}),[i,c,te])),Ce=(e,t)=>{De(e.currentTarget),je(t.id)},Ee=((0,o.FR)(),(0,g.A)()),Te=(0,p.A)(Ee.breakpoints.down("sm")),Fe=e=>{var t;let{item:i,onViewDetails:s,onActionClick:o}=e;return(0,H.jsx)(h.A,{sx:{mb:2,cursor:"pointer"},onClick:()=>s(i.id),children:(0,H.jsx)(A.A,{sx:{pb:"8px !important"},children:(0,H.jsxs)(v.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[(0,H.jsxs)(v.A,{sx:{flexGrow:1,mr:1},children:[(0,H.jsx)(x.A,{variant:"subtitle1",component:"div",sx:{fontWeight:"bold",lineHeight:1.3},children:i.productName||i.deliveryName||"Unnamed Item"}),(0,H.jsxs)(x.A,{variant:"body2",color:"text.secondary",children:["Status: ",i.currentStatus]}),(0,H.jsxs)(x.A,{variant:"body2",color:"text.secondary",children:["Qty: ",null!==(t=i.quantity)&&void 0!==t?t:"N/A"," | Seller: ",i.seller||"N/A"]}),(0,H.jsxs)(x.A,{variant:"body2",color:"text.secondary",sx:{fontSize:"0.8rem"},children:["Order Date: ",i.orderDate?new Date(i.orderDate).toLocaleDateString():"N/A"]})]}),(0,H.jsx)(b.A,{size:"small",onClick:e=>{e.stopPropagation(),o(e,i)},sx:{mt:-1,mr:-1},children:(0,H.jsx)(L.A,{})})]})})})};return(0,H.jsxs)(v.A,{sx:{p:Te?1:2},children:[" ",(0,H.jsxs)(v.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[(0,H.jsx)(x.A,{variant:"h6",children:"Stock Items"}),(0,H.jsxs)(v.A,{children:[(0,H.jsx)(S.A,{title:"Add New Item",children:(0,H.jsx)(f.A,{variant:"contained",startIcon:(0,H.jsx)(z.A,{}),onClick:()=>{ne(null),le(!0)},sx:{mr:1},children:"Add Item"})}),(0,H.jsx)(S.A,{title:"Table Settings",children:(0,H.jsx)(b.A,{onClick:()=>he(!0),sx:{mr:1},children:(0,H.jsx)(P.A,{})})}),(0,H.jsx)(S.A,{title:"View User Activity",children:(0,H.jsx)(b.A,{onClick:()=>be(!0),children:(0,H.jsx)(U.A,{})})})]})]}),$&&(0,H.jsx)(y.A,{severity:"error",onClose:()=>te(null),sx:{},children:$}),u&&(0,H.jsx)(j.A,{sx:{}}),(0,H.jsxs)(v.A,{sx:{},children:[(0,H.jsx)(I.A,{value:M,onChange:e=>Q(e.target.value)}),(0,H.jsx)(D.A,{control:(0,H.jsx)(w.A,{checked:G,onChange:e=>ee(e.target.checked),size:"small"}),label:(0,H.jsx)(x.A,{variant:"body2",children:"Show Flagged Only"}),sx:{mr:0}})]}),(0,H.jsx)(v.A,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:(0,H.jsxs)(k.A,{value:q,onChange:(e,t)=>K(t),variant:"scrollable",scrollButtons:"auto",allowScrollButtonsMobile:!0,"aria-label":"Stock item status filter",children:[(0,H.jsx)(N.A,{label:"All",value:"All"}),(0,H.jsx)(N.A,{label:"Pending",value:"Pending Delivery"}),(0,H.jsx)(N.A,{label:"Delivered",value:"Delivered"}),(0,H.jsx)(N.A,{label:"Issue",value:"Issue"}),(0,H.jsx)(N.A,{label:"Late",value:"Late"}),(0,H.jsx)(N.A,{label:"Archived",value:"Archived"})]})}),(0,H.jsxs)(o.Mp,{children:[!Te&&(0,H.jsx)(C.A,{component:E.A,sx:{mt:2,maxHeight:"calc(100vh - 250px)",overflowY:"auto"},children:(0,H.jsxs)(T.A,{stickyHeader:!0,size:"small",children:[(0,H.jsx)(F.A,{children:(0,H.jsx)(O.A,{children:(0,H.jsx)(l.gB,{items:Se,strategy:l.m$,children:we.map((e=>(0,H.jsx)(Z,{column:e},e.id)))})})}),(0,H.jsxs)(_.A,{children:[d.map(((e,t)=>(0,H.jsx)(O.A,{hover:!0,sx:{"& > *":{borderBottom:"unset"},cursor:"pointer"},onClick:()=>Ne(e.id),children:we.map((t=>{var i;return(0,H.jsx)(m.A,{align:["quantity","pricePerItem"].includes(t.id)?"right":"left",sx:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:["productName","deliveryName","seller"].includes(t.id)?200:void 0,..."isFlagged"===t.id&&{p:"6px 8px",textAlign:"center"},..."actions"===t.id&&{p:"0px 8px",textAlign:"center"}},children:"actions"===t.id?(0,H.jsx)(b.A,{size:"small",onClick:t=>{t.stopPropagation(),Ce(t,e)},children:(0,H.jsx)(L.A,{fontSize:"small"})}):"isFlagged"===t.id?e.isFlagged?(0,H.jsx)(R.A,{fontSize:"inherit",color:"error"}):null:"orderDate"===t.id||"dateDelivered"===t.id?e[t.id]?new Date(e[t.id]).toLocaleDateString():"":null!==(i=e[t.id])&&void 0!==i?i:""},t.id)}))},e.id))),0===d.length&&!u&&(0,H.jsx)(O.A,{children:(0,H.jsx)(m.A,{colSpan:we.length,align:"center",children:"No items match the current filter."})})]})]})}),Te&&(0,H.jsxs)(v.A,{sx:{p:1},children:[" ",d.map((e=>(0,H.jsx)(Fe,{item:e,onViewDetails:Ne,onActionClick:Ce},e.id))),0===d.length&&(0,H.jsx)(x.A,{align:"center",sx:{mt:2,color:"text.secondary"},children:"No items match the current filter."})]})]}),(()=>{if(!ye)return null;c.find((e=>e.id===ye))})()]})}}}]);
//# sourceMappingURL=894.97c67752.chunk.js.map